IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[OP0085]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[OP0085]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO


---- Created by Tiểu Mai on 26/07/2016
---- Purpose: In báo cáo Bảng cân đối nguyên phụ liệu theo đơn hàng (CustomizeIndex = 54 - An Phát)
---- Modified by Hải Long on 25/05/2017: Sửa danh mục dùng chung
---- Modified by Huỳnh Thử on 28/09/2020 : Bổ sung danh mục dùng chung
---- Modified by Đức Duy on 13/02/2023: [2023/02/IS/0052] - Bổ sung thêm điều kiện DivisionID dùng chung cho bảng danh mục kho hàng - AT1303.

-- <Example>
--exec OP0085 'PC', 1, 2016, 9, 2016, '2016-01-01', '2016-01-01', 'CPRO-000001', 'CPRO-000001', 'SC/08/2016/0010', 'SC/08/2016/0010', 0

CREATE PROCEDURE [dbo].[OP0085] 
(
	@DivisionID nvarchar(50),
	@FromMonth INT,
	@FromYear INT,
	@ToMonth INT,
	@ToYear INT,
	@FromDate DATETIME,
	@ToDate DATETIME,
	@FromObjectID NVARCHAR(50),
	@ToObjectID NVARCHAR(50),
	@FromSOrderID NVARCHAR(50),
	@ToSOrderID NVARCHAR(50),
	@IsDate TINYINT
	
)
AS

Declare @sSQL1 AS nvarchar(max), @sSQL11 AS nvarchar(max),
		@sSQL2 AS nvarchar(max), @sSQL22 AS nvarchar(max),
		@sSQL3 AS NVARCHAR(MAX), @sSQL33 AS NVARCHAR(MAX),
		@sSQL4 AS NVARCHAR(MAX),
		@sSQL5 AS NVARCHAR(MAX),
		@sSQL6 AS NVARCHAR(MAX),
		@sSQL7 AS NVARCHAR(MAX),
		@sWhere AS NVARCHAR(MAX)

SET @sWhere = ''
IF Isnull(@IsDate,0) = 0
	SET @sWhere = @sWhere + '
	AND OT2001.TranMonth + OT2001.TranYear*100 BETWEEN '+ CONVERT(NVARCHAR(50),@FromMonth+@FromYear*100) +' AND '+ CONVERT(NVARCHAR(50),@ToMonth+@ToYear*100)
ELSE 
	SET @sWhere = @sWhere + '
	AND CONVERT(NVARCHAR(10),OT2001.OrderDate,112) BETWEEN '+ CONVERT(NVARCHAR(10),@FromDate,112) +' AND '+ CONVERT(NVARCHAR(10),@ToDate,112)

---- Lấy thông tin định mức đơn hàng bán
SET @sSQL1 = '
SELECT DISTINCT	OT2002.DivisionID, OT2001.ObjectID, OT2002.SOrderID, OT2002.InventoryID, OT2002.UnitID, OT2002.OrderQuantity, 
	O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	M37.MaterialID, M37.MaterialUnitID, M37.MaterialQuantity, --MAX(M37.RateDecimalApp) as RateDecimalApp, 
	Max(M37.QuantityUnit) as QuantityUnit, 
	M37.DS01ID, M37.DS02ID, M37.DS03ID, M37.DS04ID, M37.DS05ID, M37.DS06ID, M37.DS07ID, M37.DS08ID, M37.DS09ID, M37.DS10ID,
	M37.DS11ID, M37.DS12ID, M37.DS13ID, M37.DS14ID, M37.DS15ID, M37.DS16ID, M37.DS17ID, M37.DS18ID, M37.DS19ID, M37.DS20ID,
	OT2002.SOrderIDRecognition, M35.Description,
	MAX(OT2002.Ana01ID) as Ana01ID, MAX(OT2002.Ana02ID) as Ana02ID, MAX(OT2002.Ana03ID) as Ana03ID, MAX(OT2002.Ana04ID) as Ana04ID, MAX(OT2002.Ana05ID) as Ana05ID, 
	MAX(OT2002.Ana06ID) as Ana06ID, MAX(OT2002.Ana07ID) as Ana07ID, MAX(OT2002.Ana08ID) as Ana08ID, MAX(OT2002.Ana09ID) as Ana09ID, MAX(OT2002.Ana10ID) as Ana10ID
INTO #TEM1	
FROM OT2001 WITH (NOLOCK)
	INNER JOIN OT2002 WITH (NOLOCK) ON OT2002.DivisionID = OT2001.DivisionID AND OT2002.SOrderID = OT2001.SOrderID
	LEFT JOIN OT8899 O99 WITH (NOLOCK) ON O99.DivisionID = OT2002.DivisionID AND O99.VoucherID = OT2002.SOrderID AND O99.TransactionID  = OT2002.TransactionID and O99.TableID  = ''OT2002''
	LEFT JOIN MT0136 M36 WITH (NOLOCK) ON M36.DivisionID = OT2002.DivisionID AND M36.ApportionID = OT2002.InheritVoucherID AND M36.TransactionID = OT2002.InheritTransactionID AND
					ISNULL(O99.S01ID,'''') = ISNULL(M36.S01ID,'''') AND 
					ISNULL(O99.S02ID,'''') = ISNULL(M36.S02ID,'''') AND 
					ISNULL(O99.S03ID,'''') = ISNULL(M36.S03ID,'''') AND 
					ISNULL(O99.S04ID,'''') = ISNULL(M36.S04ID,'''') AND 
					ISNULL(O99.S05ID,'''') = ISNULL(M36.S05ID,'''') AND 
					ISNULL(O99.S06ID,'''') = ISNULL(M36.S06ID,'''') AND 
					ISNULL(O99.S07ID,'''') = ISNULL(M36.S07ID,'''') AND 
					ISNULL(O99.S08ID,'''') = ISNULL(M36.S08ID,'''') AND 
					ISNULL(O99.S09ID,'''') = ISNULL(M36.S09ID,'''') AND 
					ISNULL(O99.S10ID,'''') = ISNULL(M36.S10ID,'''') AND 
					ISNULL(O99.S11ID,'''') = ISNULL(M36.S11ID,'''') AND 
					ISNULL(O99.S12ID,'''') = ISNULL(M36.S12ID,'''') AND 
					ISNULL(O99.S13ID,'''') = ISNULL(M36.S13ID,'''') AND 
					ISNULL(O99.S14ID,'''') = ISNULL(M36.S14ID,'''') AND 
					ISNULL(O99.S15ID,'''') = ISNULL(M36.S15ID,'''') AND 
					ISNULL(O99.S16ID,'''') = ISNULL(M36.S16ID,'''') AND 
					ISNULL(O99.S17ID,'''') = ISNULL(M36.S17ID,'''') AND 
					ISNULL(O99.S18ID,'''') = ISNULL(M36.S18ID,'''') AND 
					ISNULL(O99.S19ID,'''') = ISNULL(M36.S19ID,'''') AND 
					ISNULL(O99.S20ID,'''') = ISNULL(M36.S20ID,'''') 
	LEFT JOIN MT0137 M37 WITH (NOLOCK) ON M37.DivisionID = M36.DivisionID AND M37.ProductID = M36.ProductID AND M37.ReTransactionID = M36.TransactionID
	LEFT JOIN MT0135 M35 WITH (NOLOCK) ON M36.DivisionID = M35.DivisionID AND M36.ApportionID = M35.ApportionID
'
SET @sSQL11 = '
WHERE OT2002.DivisionID = '''+@DivisionID+'''
	AND OrderType = 0
	AND M37.ExpenseID = ''COST001''
	AND OT2001.ObjectID BETWEEN '''+@FromObjectID+''' AND '''+@ToObjectID+'''
	AND OT2002.SOrderIDRecognition BETWEEN '''+@FromSOrderID+''' AND '''+@ToSOrderID+'''
	' + @sWhere + '
GROUP BY OT2002.DivisionID, OT2001.ObjectID, OT2002.SOrderID, OT2002.InventoryID, OT2002.UnitID, OT2002.OrderQuantity, 
	O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	M37.MaterialID, M37.MaterialUnitID, M37.MaterialQuantity,  M35.Description,
	M37.DS01ID, M37.DS02ID, M37.DS03ID, M37.DS04ID, M37.DS05ID, M37.DS06ID, M37.DS07ID, M37.DS08ID, M37.DS09ID, M37.DS10ID,
	M37.DS11ID, M37.DS12ID, M37.DS13ID, M37.DS14ID, M37.DS15ID, M37.DS16ID, M37.DS17ID, M37.DS18ID, M37.DS19ID, M37.DS20ID,
	OT2002.SOrderIDRecognition
'

	
---- Lấy thông tin đơn hàng sản xuất
SET @sSQL2 = '
SELECT DISTINCT	OT2002.DivisionID, OT2002.InventoryID, OT2002.UnitID, OT2002.OrderQuantity, 
	O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	M37.MaterialID, M37.MaterialUnitID, --MAX(M37.RateDecimalApp) as RateDecimalAppDHSX, 
	Max(M37.QuantityUnit) as QuantityUnitDHSX, 
	M37.DS01ID, M37.DS02ID, M37.DS03ID, M37.DS04ID, M37.DS05ID, M37.DS06ID, M37.DS07ID, M37.DS08ID, M37.DS09ID, M37.DS10ID,
	M37.DS11ID, M37.DS12ID, M37.DS13ID, M37.DS14ID, M37.DS15ID, M37.DS16ID, M37.DS17ID, M37.DS18ID, M37.DS19ID, M37.DS20ID,
	OT2002.SOrderIDRecognition, 
	MAX(OT2002.Ana01ID) as Ana01IDDHSX, MAX(OT2002.Ana02ID) as Ana02IDDHSX, MAX(OT2002.Ana03ID) as Ana03IDDHSX, MAX(OT2002.Ana04ID) as Ana04IDDHSX, MAX(OT2002.Ana05ID) as Ana05IDDHSX, 
	MAX(OT2002.Ana06ID) as Ana06IDDHSX, MAX(OT2002.Ana07ID) as Ana07IDDHSX, MAX(OT2002.Ana08ID) as Ana08IDDHSX, MAX(OT2002.Ana09ID) as Ana09IDDHSX, MAX(OT2002.Ana10ID) as Ana10IDDHSX	
INTO #TEM2			
FROM	OT2002  WITH (NOLOCK)
LEFT JOIN AT1302 WITH (NOLOCK) ON AT1302.DivisionID IN (''@@@'', OT2002.DivisionID) AND AT1302.InventoryID = OT2002.InventoryID
LEFT JOIN OT1003 WITH (NOLOCK) ON OT1003.MethodID = OT2002.MethodID  AND OT1003.DivisionID = OT2002.DivisionID
INNER JOIN OT2001 WITH (NOLOCK) ON OT2001.SOrderID = OT2002.SOrderID AND OT2001.DivisionID = OT2002.DivisionID	
LEFT JOIN AT1303 WITH (NOLOCK) ON AT1303.DivisionID IN (''@@@'', '''+@DivisionID+''') AND AT1303.WareHouseID = OT2002.WareHouseID
LEFT JOIN AT1102 WITH (NOLOCK) ON AT1102.DepartmentID = OT2001.DepartmentID
LEFT JOIN AT1301 WITH (NOLOCK) ON AT1301.InventoryTypeID = OT2001.InventoryTypeID
LEFT JOIN AT1304 WITH (NOLOCK) ON AT1304.UnitID = AT1302.UnitID 
LEFT JOIN OT8899 O99 WITH (NOLOCK) ON O99.DivisionID = OT2002.DivisionID AND O99.VoucherID = OT2002.SOrderID AND O99.TransactionID  = OT2002.TransactionID and O99.TableID  = ''OT2002''
'
SET @sSQL22 = '
LEFT JOIN MT0136 M36 WITH (NOLOCK) ON M36.DivisionID = OT2001.DivisionID AND M36.ApportionID = OT2001.InheritApportionID  AND M36.ProductID = OT2002.InventoryID AND
				ISNULL(O99.S01ID,'''') = ISNULL(M36.S01ID,'''') AND 
				ISNULL(O99.S02ID,'''') = ISNULL(M36.S02ID,'''') AND 
				ISNULL(O99.S03ID,'''') = ISNULL(M36.S03ID,'''') AND 
				ISNULL(O99.S04ID,'''') = ISNULL(M36.S04ID,'''') AND 
				ISNULL(O99.S05ID,'''') = ISNULL(M36.S05ID,'''') AND 
				ISNULL(O99.S06ID,'''') = ISNULL(M36.S06ID,'''') AND 
				ISNULL(O99.S07ID,'''') = ISNULL(M36.S07ID,'''') AND 
				ISNULL(O99.S08ID,'''') = ISNULL(M36.S08ID,'''') AND 
				ISNULL(O99.S09ID,'''') = ISNULL(M36.S09ID,'''') AND 
				ISNULL(O99.S10ID,'''') = ISNULL(M36.S10ID,'''') AND 
				ISNULL(O99.S11ID,'''') = ISNULL(M36.S11ID,'''') AND 
				ISNULL(O99.S12ID,'''') = ISNULL(M36.S12ID,'''') AND 
				ISNULL(O99.S13ID,'''') = ISNULL(M36.S13ID,'''') AND 
				ISNULL(O99.S14ID,'''') = ISNULL(M36.S14ID,'''') AND 
				ISNULL(O99.S15ID,'''') = ISNULL(M36.S15ID,'''') AND 
				ISNULL(O99.S16ID,'''') = ISNULL(M36.S16ID,'''') AND 
				ISNULL(O99.S17ID,'''') = ISNULL(M36.S17ID,'''') AND 
				ISNULL(O99.S18ID,'''') = ISNULL(M36.S18ID,'''') AND		
				ISNULL(O99.S19ID,'''') = ISNULL(M36.S19ID,'''') AND 
				ISNULL(O99.S20ID,'''') = ISNULL(M36.S20ID,'''') 		
LEFT JOIN MT0137 M37 WITH (NOLOCK) ON M37.DivisionID = M36.DivisionID AND M37.ProductID = M36.ProductID AND M37.ReTransactionID = M36.TransactionID	
WHERE	OT2001.DivisionID = '''+@DivisionID+''' AND 
		OT2002.SOrderIDRecognition BETWEEN '''+@FromSOrderID+''' AND '''+@ToSOrderID+''' AND
		OT2001.OrderType = 1
		AND M37.ExpenseID = ''COST001''
		' + @sWhere + '
GROUP BY OT2002.DivisionID, OT2001.ObjectID, OT2002.SOrderID, OT2002.InventoryID, OT2002.UnitID, OT2002.OrderQuantity, 
	O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	M37.MaterialID, M37.MaterialUnitID, M37.MaterialQuantity,
	M37.DS01ID, M37.DS02ID, M37.DS03ID, M37.DS04ID, M37.DS05ID, M37.DS06ID, M37.DS07ID, M37.DS08ID, M37.DS09ID, M37.DS10ID,
	M37.DS11ID, M37.DS12ID, M37.DS13ID, M37.DS14ID, M37.DS15ID, M37.DS16ID, M37.DS17ID, M37.DS18ID, M37.DS19ID, M37.DS20ID,
	OT2002.SOrderIDRecognition
'

---- Lấy thông tin nhập kho 
SET @sSQL3 = '
SELECT A07.DivisionID, A06.VoucherDate, A06.WareHouseID AS ImWareHouseID,
	A07.InventoryID AS MaterialID, A07.UnitID, A07.ConvertedUnitID, A07.ActualQuantity AS ImActualQuantity, A07.ConvertedQuantity AS ImConvertedQuantity,
	O99.S01ID as DS01ID, O99.S02ID as DS02ID, O99.S03ID as DS03ID, O99.S04ID as DS04ID, O99.S05ID as DS05ID, O99.S06ID AS DS06ID, O99.S07ID AS DS07ID, O99.S08ID as DS08ID, O99.S09ID as DS09ID, O99.S10ID AS DS10ID,
	O99.S11ID as DS11ID, O99.S12ID as DS12ID, O99.S13ID as DS13ID, O99.S14ID as DS14ID, O99.S15ID as DS15ID, O99.S16ID as DS16ID, O99.S17ID as DS17ID, O99.S18ID as DS18ID, O99.S19ID as DS19ID, O99.S20ID as DS20ID,
	A07.SOrderIDRecognition, 
	A07.Ana01ID AS ImAna01ID, A07.Ana02ID AS ImAna02ID, A07.Ana03ID AS ImAna03ID, A07.Ana04ID AS ImAna04ID, A07.Ana05ID AS ImAna05ID,
	A07.Ana06ID AS ImAna06ID, A07.Ana07ID AS ImAna07ID, A07.Ana08ID AS ImAna08ID, A07.Ana09ID AS ImAna09ID, A07.Ana10ID AS ImAna10ID
INTO #TEM3
FROM AT2007 A07 WITH (NOLOCK)
INNER JOIN AT2006 A06 WITH (NOLOCK) ON A06.DivisionID = A07.DivisionID AND A06.VoucherID = A07.VoucherID
LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = A07.DivisionID AND O99.VoucherID = A07.VoucherID AND O99.TransactionID = A07.TransactionID AND O99.TableID = ''AT2007''
WHERE A07.DivisionID = '''+@DivisionID+'''
	AND A06.KindVoucherID IN (1,3,5,7)
	AND A07.SOrderIDRecognition BETWEEN '''+@FromSOrderID+''' AND '''+@ToSOrderID+'''
	'


---- Lấy thông tin xuất kho
SET @sSQL4 = '
SELECT A07.DivisionID,
		A07.InventoryID AS MaterialID, A07.ActualQuantity AS ExActualQuantity, A07.UnitID, A07.ConvertedUnitID, A07.ConvertedQuantity AS ExConvertedQuantity,
		O99.S01ID as DS01ID, O99.S02ID as DS02ID, O99.S03ID as DS03ID, O99.S04ID as DS04ID, O99.S05ID as DS05ID, O99.S06ID AS DS06ID, O99.S07ID AS DS07ID, O99.S08ID as DS08ID, O99.S09ID as DS09ID, O99.S10ID AS DS10ID,
		O99.S11ID as DS11ID, O99.S12ID as DS12ID, O99.S13ID as DS13ID, O99.S14ID as DS14ID, O99.S15ID as DS15ID, O99.S16ID as DS16ID, O99.S17ID as DS17ID, O99.S18ID as DS18ID, O99.S19ID as DS19ID, O99.S20ID as DS20ID,
		A07.SOrderIDRecognition, A07.Ana01ID AS ExAna01ID, A07.Ana02ID AS ExAna02ID, A07.Ana03ID AS ExAna03ID, A07.Ana04ID AS ExAna04ID, A07.Ana05ID AS ExAna05ID,
	A07.Ana06ID AS ExAna06ID, A07.Ana07ID AS ExAna07ID, A07.Ana08ID AS ExAna08ID, A07.Ana09ID AS ExAna09ID, A07.Ana10ID AS ExAna10ID
INTO #TEM4
FROM AT2007 A07 WITH (NOLOCK)
INNER JOIN AT2006 A06 WITH (NOLOCK) ON A06.DivisionID = A07.DivisionID AND A06.VoucherID = A07.VoucherID
--LEFT JOIN WT0096 W96 WITH (NOLOCK) ON W96.DivisionID = A07.DivisionID AND W96.VoucherID = A07.InheritVoucherID --AND W96.TransactionID = A07.InheritTransactionID 
--AND W96.Ana05ID = A07.Ana05ID AND W96.InventoryID = A07.InventoryID
--LEFT JOIN WT0095 W95 WITH (NOLOCK) ON W95.DivisionID = W96.DivisionID AND W96.VoucherID = W95.VoucherID
LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = A07.DivisionID AND O99.VoucherID = A07.VoucherID AND O99.TransactionID = A07.TransactionID AND O99.TableID = ''AT2007''
WHERE A07.DivisionID = '''+@DivisionID+'''
AND A06.KindVoucherID IN (2,4,6)
AND A07.SOrderIDRecognition BETWEEN '''+@FromSOrderID+''' AND '''+@ToSOrderID+'''
'

--DROP TABLE #TEM5

--SELECT * FROM #TEM4

DECLARE @StringPivot NVARCHAR(MAX) = '', @StringPivot1 NVARCHAR(MAX) = '', @StringPivot2 NVARCHAR(MAX) = ''

SELECT @StringPivot = @StringPivot + ('[' + AnaID + '],') FROM AT1011 WITH (NOLOCK) WHERE AnaTypeID = 'A05'
SELECT @StringPivot1 = @StringPivot1 + ('t5.' + AnaID + ',') FROM AT1011 WITH (NOLOCK) WHERE AnaTypeID = 'A05'
SELECT @StringPivot2 = @StringPivot2 + ('t6.' + AnaID + ',') FROM AT1011 WITH (NOLOCK) WHERE AnaTypeID = 'A05'

SET @StringPivot = LEFT( @StringPivot, LEN(@StringPivot) - 1)
SET @StringPivot1 = LEFT( @StringPivot1, LEN(@StringPivot1) - 1)
SET @StringPivot2 = LEFT( @StringPivot2, LEN(@StringPivot2) - 1)

--PRINT @StringPivot1

SET @sSQL5 = '
SELECT 
		MaterialID, UnitID,
		DS01ID, DS02ID, DS03ID, DS04ID, DS05ID, DS06ID, DS07ID, DS08ID, DS09ID, DS10ID,
		DS11ID, DS12ID, DS13ID, DS14ID, DS15ID, DS16ID, DS17ID, DS18ID, DS19ID, DS20ID,
		SOrderIDRecognition, ExAna01ID, ExAna02ID, ExAna03ID, ExAna04ID,
		ExAna06ID, ExAna07ID, ExAna08ID, ExAna09ID, ExAna10ID, '+@StringPivot+'
INTO #TEM5
FROM
(SELECT ExAna05ID, ExActualQuantity, MaterialID, UnitID,
		DS01ID, DS02ID, DS03ID, DS04ID, DS05ID, DS06ID, DS07ID, DS08ID, DS09ID, DS10ID,
		DS11ID, DS12ID, DS13ID, DS14ID, DS15ID, DS16ID, DS17ID, DS18ID, DS19ID, DS20ID,
		SOrderIDRecognition, ExAna01ID, ExAna02ID, ExAna03ID, ExAna04ID,
		ExAna06ID, ExAna07ID, ExAna08ID, ExAna09ID, ExAna10ID
    FROM #TEM4) AS SourceTable
PIVOT
(
SUM(ExActualQuantity)
FOR ExAna05ID IN ('+@STringPivot+')
) AS PivotTable

SELECT 
		VoucherDate, MaterialID, UnitID,
		DS01ID, DS02ID, DS03ID, DS04ID, DS05ID, DS06ID, DS07ID, DS08ID, DS09ID, DS10ID,
		DS11ID, DS12ID, DS13ID, DS14ID, DS15ID, DS16ID, DS17ID, DS18ID, DS19ID, DS20ID,
		SOrderIDRecognition, 
		ImAna01ID, ImAna02ID, ImAna03ID, ImAna04ID,
		ImAna06ID, ImAna07ID, ImAna08ID, ImAna09ID, ImAna10ID, '+@StringPivot+'
INTO #TEM6
FROM
(SELECT ImAna05ID, ImActualQuantity, MaterialID, UnitID, VoucherDate,
		DS01ID, DS02ID, DS03ID, DS04ID, DS05ID, DS06ID, DS07ID, DS08ID, DS09ID, DS10ID,
		DS11ID, DS12ID, DS13ID, DS14ID, DS15ID, DS16ID, DS17ID, DS18ID, DS19ID, DS20ID,
		SOrderIDRecognition, 
		ImAna01ID, ImAna02ID, ImAna03ID, ImAna04ID,
		ImAna06ID, ImAna07ID, ImAna08ID, ImAna09ID, ImAna10ID
    FROM #TEM3) AS SourceTable
PIVOT
(
SUM(ImActualQuantity)
FOR ImAna05ID IN ('+@STringPivot+')
) AS PivotTable

'


--PRINT @sSQL5
--SELECT * FROM #TEM1
--SELECT * FROM #TEM2

SET @sSQL6 = '
SELECT t12.InventoryName, t13.InventoryName as MaterialName, t1.*, t2.OrderQuantity as OrderQuantityDHSX, t2.QuantityUnitDHSX,
	Ana01IDDHSX, Ana02IDDHSX, Ana03IDDHSX, Ana04IDDHSX,	 Ana05IDDHSX,
	Ana06IDDHSX, Ana07IDDHSX, Ana08IDDHSX, Ana09IDDHSX,	 Ana10IDDHSX,
	ExActualQuantity, ExConvertedQuantity, 
	ExAna01ID, ExAna02ID, ExAna03ID, ExAna04ID, ExAna05ID,
	ExAna06ID, ExAna07ID, ExAna08ID, ExAna09ID, ExAna10ID, 
	ImActualQuantity, ImConvertedQuantity, 
	ImAna01ID, ImAna02ID, ImAna03ID, ImAna04ID, ImAna05ID,
	ImAna06ID, ImAna07ID, ImAna08ID, ImAna09ID, ImAna10ID, 
	VoucherDate, a.*,
	OT1002_1.AnaName as ExAnaName01, 
	OT1002_2.AnaName as ExAnaName02, 
	OT1002_3.AnaName as ExAnaName03, 
	OT1002_4.AnaName as ExAnaName04, 
	OT1002_5.AnaName as ExAnaName05, 
	OT1002_6.AnaName as ImAnaName01, 
	OT1002_7.AnaName as ImAnaName02, 
	OT1002_8.AnaName as ImAnaName03, 
	OT1002_9.AnaName as ImAnaName04, 
	OT1002_10.AnaName as ImAnaName05
FROM #TEM1 t1
left JOIN #TEM2 t2 ON t1.InventoryID = t2.InventoryID AND t1.UnitID = t2.UnitID 
			AND ISNULL(t1.S01ID,'''') = ISNULL(t2.S01ID,'''')
			AND ISNULL(t1.S02ID,'''') = ISNULL(t2.S02ID,'''')
			AND ISNULL(t1.S03ID,'''') = ISNULL(t2.S03ID,'''')
			AND ISNULL(t1.S04ID,'''') = ISNULL(t2.S04ID,'''')
			AND ISNULL(t1.S05ID,'''') = ISNULL(t2.S05ID,'''')
			AND ISNULL(t1.S06ID,'''') = ISNULL(t2.S06ID,'''')
			AND ISNULL(t1.S07ID,'''') = ISNULL(t2.S07ID,'''')
			AND ISNULL(t1.S08ID,'''') = ISNULL(t2.S08ID,'''')
			AND ISNULL(t1.S09ID,'''') = ISNULL(t2.S09ID,'''')
			AND ISNULL(t1.S10ID,'''') = ISNULL(t2.S10ID,'''')
			AND ISNULL(t1.S11ID,'''') = ISNULL(t2.S11ID,'''')
			AND ISNULL(t1.S12ID,'''') = ISNULL(t2.S12ID,'''')
			AND ISNULL(t1.S13ID,'''') = ISNULL(t2.S13ID,'''')
			AND ISNULL(t1.S14ID,'''') = ISNULL(t2.S14ID,'''')
			AND ISNULL(t1.S15ID,'''') = ISNULL(t2.S15ID,'''')
			AND ISNULL(t1.S16ID,'''') = ISNULL(t2.S16ID,'''')
			AND ISNULL(t1.S17ID,'''') = ISNULL(t2.S17ID,'''')
			AND ISNULL(t1.S18ID,'''') = ISNULL(t2.S18ID,'''')
			AND ISNULL(t1.S19ID,'''') = ISNULL(t2.S19ID,'''')
			AND ISNULL(t1.S20ID,'''') = ISNULL(t2.S20ID,'''')
			AND t1.MaterialID = t2.MaterialID AND t1.MaterialUnitID = t2.MaterialUnitID 
			AND ISNULL(t1.DS01ID,'''') = ISNULL(t2.DS01ID,'''')
			AND ISNULL(t1.DS02ID,'''') = ISNULL(t2.DS02ID,'''')
			AND ISNULL(t1.DS03ID,'''') = ISNULL(t2.DS03ID,'''')
			AND ISNULL(t1.DS04ID,'''') = ISNULL(t2.DS04ID,'''')
			AND ISNULL(t1.DS05ID,'''') = ISNULL(t2.DS05ID,'''')
			AND ISNULL(t1.DS06ID,'''') = ISNULL(t2.DS06ID,'''')
			AND ISNULL(t1.DS07ID,'''') = ISNULL(t2.DS07ID,'''')
			AND ISNULL(t1.DS08ID,'''') = ISNULL(t2.DS08ID,'''')
			AND ISNULL(t1.DS09ID,'''') = ISNULL(t2.DS09ID,'''')
			AND ISNULL(t1.DS10ID,'''') = ISNULL(t2.DS10ID,'''')
			AND ISNULL(t1.DS11ID,'''') = ISNULL(t2.DS11ID,'''')
			AND ISNULL(t1.DS12ID,'''') = ISNULL(t2.DS12ID,'''')
			AND ISNULL(t1.DS13ID,'''') = ISNULL(t2.DS13ID,'''')
			AND ISNULL(t1.DS14ID,'''') = ISNULL(t2.DS14ID,'''')
			AND ISNULL(t1.DS15ID,'''') = ISNULL(t2.DS15ID,'''')
			AND ISNULL(t1.DS16ID,'''') = ISNULL(t2.DS16ID,'''')
			AND ISNULL(t1.DS17ID,'''') = ISNULL(t2.DS17ID,'''')
			AND ISNULL(t1.DS18ID,'''') = ISNULL(t2.DS18ID,'''')
			AND ISNULL(t1.DS19ID,'''') = ISNULL(t2.DS19ID,'''')
			AND ISNULL(t1.DS20ID,'''') = ISNULL(t2.DS20ID,'''')
			AND t1.SOrderIDRecognition = t2.SOrderIDRecognition
'
SET @sSQL7 = '
left JOIN #TEM3 t3 ON  t1.MaterialID = t3.MaterialID AND t1.MaterialUnitID = t3.UnitID AND t1.SOrderIDRecognition = t3.SOrderIDRecognition
			AND ISNULL(t1.DS01ID,'''') = ISNULL(t3.DS01ID,'''')
			AND ISNULL(t1.DS02ID,'''') = ISNULL(t3.DS02ID,'''')
			AND ISNULL(t1.DS03ID,'''') = ISNULL(t3.DS03ID,'''')
			AND ISNULL(t1.DS04ID,'''') = ISNULL(t3.DS04ID,'''')
			AND ISNULL(t1.DS05ID,'''') = ISNULL(t3.DS05ID,'''')
			AND ISNULL(t1.DS06ID,'''') = ISNULL(t3.DS06ID,'''')
			AND ISNULL(t1.DS07ID,'''') = ISNULL(t3.DS07ID,'''')
			AND ISNULL(t1.DS08ID,'''') = ISNULL(t3.DS08ID,'''')
			AND ISNULL(t1.DS09ID,'''') = ISNULL(t3.DS09ID,'''')
			AND ISNULL(t1.DS10ID,'''') = ISNULL(t3.DS10ID,'''')
			AND ISNULL(t1.DS11ID,'''') = ISNULL(t3.DS11ID,'''')
			AND ISNULL(t1.DS12ID,'''') = ISNULL(t3.DS12ID,'''')
			AND ISNULL(t1.DS13ID,'''') = ISNULL(t3.DS13ID,'''')
			AND ISNULL(t1.DS14ID,'''') = ISNULL(t3.DS14ID,'''')
			AND ISNULL(t1.DS15ID,'''') = ISNULL(t3.DS15ID,'''')
			AND ISNULL(t1.DS16ID,'''') = ISNULL(t3.DS16ID,'''')
			AND ISNULL(t1.DS17ID,'''') = ISNULL(t3.DS17ID,'''')
			AND ISNULL(t1.DS18ID,'''') = ISNULL(t3.DS18ID,'''')
			AND ISNULL(t1.DS19ID,'''') = ISNULL(t3.DS19ID,'''')
			AND ISNULL(t1.DS20ID,'''') = ISNULL(t3.DS20ID,'''')
left JOIN #TEM4 t4 ON t1.MaterialID = t4.MaterialID AND t1.MaterialUnitID = t4.UnitID AND t1.SOrderIDRecognition = t4.SOrderIDRecognition
			AND ISNULL(t1.DS01ID,'''') = ISNULL(t4.DS01ID,'''')
			AND ISNULL(t1.DS02ID,'''') = ISNULL(t4.DS02ID,'''')
			AND ISNULL(t1.DS03ID,'''') = ISNULL(t4.DS03ID,'''')
			AND ISNULL(t1.DS04ID,'''') = ISNULL(t4.DS04ID,'''')
			AND ISNULL(t1.DS05ID,'''') = ISNULL(t4.DS05ID,'''')
			AND ISNULL(t1.DS06ID,'''') = ISNULL(t4.DS06ID,'''')
			AND ISNULL(t1.DS07ID,'''') = ISNULL(t4.DS07ID,'''')
			AND ISNULL(t1.DS08ID,'''') = ISNULL(t4.DS08ID,'''')
			AND ISNULL(t1.DS09ID,'''') = ISNULL(t4.DS09ID,'''')
			AND ISNULL(t1.DS10ID,'''') = ISNULL(t4.DS10ID,'''')
			AND ISNULL(t1.DS11ID,'''') = ISNULL(t4.DS11ID,'''')
			AND ISNULL(t1.DS12ID,'''') = ISNULL(t4.DS12ID,'''')
			AND ISNULL(t1.DS13ID,'''') = ISNULL(t4.DS13ID,'''')
			AND ISNULL(t1.DS14ID,'''') = ISNULL(t4.DS14ID,'''')
			AND ISNULL(t1.DS15ID,'''') = ISNULL(t4.DS15ID,'''')
			AND ISNULL(t1.DS16ID,'''') = ISNULL(t4.DS16ID,'''')
			AND ISNULL(t1.DS17ID,'''') = ISNULL(t4.DS17ID,'''')
			AND ISNULL(t1.DS18ID,'''') = ISNULL(t4.DS18ID,'''')
			AND ISNULL(t1.DS19ID,'''') = ISNULL(t4.DS19ID,'''')
			AND ISNULL(t1.DS20ID,'''') = ISNULL(t4.DS20ID,'''')
LEFT JOIN (SELECT * FROM  (SELECT UserName, TypeID, DivisionID
		                   FROM AT0005 WITH (NOLOCK) WHERE TypeID LIKE ''S__'') b PIVOT (max(Username) for TypeID IN (S01, S02, S03, S04, S05, S06, S07, S08, S09, S10,
																										S11, S12, S13, S14, S15, S16, S17, S18, S19, S20))  AS a) a ON a.DivisionID = t1.DivisionID
LEFT JOIN AT1302 t12 WITH (NOLOCK) ON t12.DivisionID IN (''@@@'', t1.DivisionID) AND t12.InventoryID = t1.InventoryID
LEFT JOIN AT1302 t13 WITH (NOLOCK) ON t13.DivisionID IN (''@@@'', t1.DivisionID) AND t13.InventoryID = t1.MaterialID
LEFT JOIN AT1011 OT1002_1 WITH (NOLOCK) ON OT1002_1.AnaID = t4.ExAna01ID AND  OT1002_1.AnaTypeID = ''A01'' 
LEFT JOIN AT1011 OT1002_2 WITH (NOLOCK) ON OT1002_2.AnaID = t4.ExAna02ID AND  OT1002_2.AnaTypeID = ''A02'' 
LEFT JOIN AT1011 OT1002_3 WITH (NOLOCK) ON OT1002_3.AnaID = t4.ExAna03ID AND  OT1002_3.AnaTypeID = ''A03'' 
LEFT JOIN AT1011 OT1002_4 WITH (NOLOCK) ON OT1002_4.AnaID = t4.ExAna04ID AND  OT1002_4.AnaTypeID = ''A04'' 
LEFT JOIN AT1011 OT1002_5 WITH (NOLOCK) ON OT1002_5.AnaID = t4.ExAna05ID AND  OT1002_5.AnaTypeID = ''A05'' 
LEFT JOIN AT1011 OT1002_6 WITH (NOLOCK) ON OT1002_6.AnaID = t3.ImAna01ID AND  OT1002_6.AnaTypeID = ''A01'' 
LEFT JOIN AT1011 OT1002_7 WITH (NOLOCK) ON OT1002_7.AnaID = t3.ImAna02ID AND  OT1002_7.AnaTypeID = ''A02'' 
LEFT JOIN AT1011 OT1002_8 WITH (NOLOCK) ON OT1002_8.AnaID = t3.ImAna03ID AND  OT1002_8.AnaTypeID = ''A03'' 
LEFT JOIN AT1011 OT1002_9 WITH (NOLOCK) ON OT1002_9.AnaID = t3.ImAna04ID AND  OT1002_9.AnaTypeID = ''A04'' 
LEFT JOIN AT1011 OT1002_10 WITH (NOLOCK) ON OT1002_10.AnaID = t3.ImAna05ID AND OT1002_10.AnaTypeID = ''A05'' 
'
--PRINT @sSQL6
EXEC (@sSQL1+@sSQL11+@sSQL2+@sSQL22+@sSQL3+@sSQL4+@sSQL6+@sSQL7)

--GO
--SET QUOTED_IDENTIFIER OFF
--GO
--SET ANSI_NULLS ON
--GO

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
