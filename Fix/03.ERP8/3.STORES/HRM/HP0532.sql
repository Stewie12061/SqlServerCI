IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[HP0532]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[HP0532]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO



 -- <Summary>
---- Báo cáo chênh lệch chấm công số giờ
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- ASOFT-HRM \ Nghiệp vụ \ Chấm công \ Quét thẻ chấm công \ Xuất excel \ Chênh lệch chấm công số giờ
-- <History>
----Created by: Bảo Thy on 
----Modified by Bảo Thy on 23/04/2018: không hiển thị dữ liệu < 0
-- <Example>
/*	[HP0532] @DivisionID='NTY', @TranMonth=10, @TranYear=2017, @DepartmentID = '%', @FromDate = '', @ToDate = ''

EXEC HP0532 @DivisionID, @TranMonth, @TranYear, @DepartmentID, @FromDate, @ToDate

*/

CREATE PROCEDURE [dbo].[HP0532] 
		@DivisionID NVARCHAR(50), 
		@TranMonth INT,
		@TranYear INT,
		@DepartmentID NVARCHAR(50),
		@FromDate DATETIME, 
		@ToDate DATETIME
	
AS
CREATE TABLE #HP0532 
(
DivisionID NVARCHAR(50), EmployeeID NVARCHAR(50), EmployeeName NVARCHAR(250), TranMonth INT, TranYear INT, DepartmentID NVARCHAR(1000), TypeID TINYINT, 
D01 NVARCHAR(50), D02 NVARCHAR(50), D03 NVARCHAR(50), D04 NVARCHAR(50), D05 NVARCHAR(50),D06 NVARCHAR(50), D07 NVARCHAR(50), D08 NVARCHAR(50), D09 NVARCHAR(50), 
D10 NVARCHAR(50), D11 NVARCHAR(50), D12 NVARCHAR(50), D13 NVARCHAR(50), D14 NVARCHAR(50),D15 NVARCHAR(50), D16 NVARCHAR(50), D17 NVARCHAR(50), D18 NVARCHAR(50), 
D19 NVARCHAR(50), D20 NVARCHAR(50), D21 NVARCHAR(50), D22 NVARCHAR(50), D23 NVARCHAR(50),D24 NVARCHAR(50), D25 NVARCHAR(50), D26 NVARCHAR(50), D27 NVARCHAR(50), 
D28 NVARCHAR(50), D29 NVARCHAR(50), D30 NVARCHAR(50), D31 NVARCHAR(50), TotalTime DECIMAL(28,8)
)

DECLARE @TableHT2408 Varchar(50) = '',
		@sTranMonth Varchar(2) = '',
		@sSQL VARCHAR(MAX) = ''

SELECT @sTranMonth = CASE WHEN @TranMonth >9 THEN Convert(Varchar(2),@TranMonth) ELSE '0'+Convert(Varchar(1),@TranMonth) END
IF EXISTS (SELECT TOP 1 1 FROM AT0001 WITH (NOLOCK) WHERE IsSplitTable = 1)	
BEGIN
	SELECT  @TableHT2408 = 'HT2408M'+@sTranMonth+Convert(Varchar(4),@TranYear)
END
ELSE
BEGIN
	SELECT  @TableHT2408 = 'HT2408'
END

-- Thời gian làm việc theo bảng xếp ca  
SELECT *, CONVERT(DATETIME,CONVERT(VARCHAR(4),@TranYear)+'-'+CONVERT(VARCHAR(2),@TranMonth)+'-'+LTRIM(RIGHT(DateShift,2)),120) As Date,
CONVERT(DECIMAL(28,8),0) AS ShiftTime, CONVERT(DECIMAL(28,8),0) AS AbsentTime, CONVERT(DECIMAL(28,8),0) AS ActualTime 
INTO #HP0532_HT1025
FROM 
(	SELECT T1.DivisionID, T1.EmployeeID, LTRIM(RTRIM(ISNULL(T2.LastName,N'')))+ ' ' + LTRIM(RTRIM(ISNULL(T2.MiddleName,N''))) + ' ' + LTRIM(RTRIM(ISNULL(T2.FirstName,N''))) AS EmployeeName,
	T1.TranMonth, T1.TranYear, T2.DepartmentID, D01, D02, D03, D04, D05, D06, D07, D08, D09, D10, 
	D11, D12, D13, D14, D15, D16, D17, D18, D19, D20, D21, D22, D23, D24, D25, D26, D27, D28, D29, D30, D31
 	FROM HT1025 T1 WITH (NOLOCK)
	INNER JOIN HT1400 T2 WITH (NOLOCK) ON T1.DivisionID = T2.DivisionID AND T1.EmployeeID = T2.EmployeeID
 	WHERE T1.DivisionID = @DivisionID AND T1.TranMonth + T1.TranYear * 100 = @TranMonth + @TranYear * 100 
	AND ISNULL(T2.DepartmentID,'') LIKE ISNULL(@DepartmentID,'%')
) AS P
UNPIVOT (ShiftID FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, D10, D11, D12, D13, D14, D15, D16, D17, D18, D19, D20,
D21, D22, D23, D24, D25, D26, D27, D28, D29, D30, D31)) AS UNPV
WHERE CONVERT(INT, LTRIM(RIGHT(DateShift,2))) <= DAY(DATEADD(d,-1, DATEADD(mm, DATEDIFF(mm, 0, CONVERT(DATETIME,CONVERT(VARCHAR(4),@TranYear)+'-'+CONVERT(VARCHAR(2),@TranMonth)+'-01',120))+1,0)))
AND CONVERT(DATETIME,CONVERT(VARCHAR(4),@TranYear)+'-'+CONVERT(VARCHAR(2),@TranMonth)+'-'+LTRIM(RIGHT(DateShift,2)),120) BETWEEN @FromDate AND @ToDate

---Số giờ làm việc theo bảng phân ca
UPDATE T1
SET T1.ShiftTime = ABS(CONVERT (DECIMAL(28,8),DATEDIFF(mi,T2.BeginTime, T2.EndTime))/60)
FROM #HP0532_HT1025 T1
INNER JOIN HT1020 T2 WITH (NOLOCK) ON T1.DivisionID = T2.DivisionID AND T1.ShiftID = T2.ShiftID

---Số giờ làm việc theo máy chấm công

SET @sSQL = '
UPDATE T1
SET T1.AbsentTime = CONVERT(DECIMAL(28,8),DATEDIFF(mi,T2.BeginTime, T2.EndTime))/60
FROM #HP0532_HT1025 T1
INNER JOIN '+@TableHT2408+' T2 WITH (NOLOCK) ON T1.DivisionID = T2.DivisionID AND T1.EmployeeID = T2.EmployeeID AND T1.Date = T2.AbsentDate
'
--PRINT(@sSQL)
--EXEC(@sSQL)

---Số giờ làm việc thực tế (HF0510)
UPDATE T1
SET T1.ActualTime = ABS(CONVERT (DECIMAL(28,8),DATEDIFF(mi,T2.ActFromTime, T2.ActToTime))/60)
FROM #HP0532_HT1025 T1
INNER JOIN HT1113 T2 WITH (NOLOCK) ON T1.DivisionID = T2.DivisionID AND T1.Date = T2.Date AND T1.TranMonth + T1.TranYear * 100 = T2.TranMonth + T2.TranYear * 100
AND T1.EmployeeID = T2.EmployeeID

----Insert dữ liệu Số giờ làm việc theo bảng phân ca (TypeID = 1)
INSERT INTO #HP0532 (DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, TypeID, D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31, TotalTime)

SELECT	T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14,D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31,
ISNULL(D01,0)+ISNULL(D02,0)+ISNULL(D03,0)+ISNULL(D04,0)+ISNULL(D05,0)+ISNULL(D06,0)+ISNULL(D07,0)+ISNULL(D08,0)+ISNULL(D09,0)+ISNULL(D10,0)+ISNULL(D11,0)+
ISNULL(D12,0)+ISNULL(D13,0)+ISNULL(D14,0)+ISNULL(D15,0)+ISNULL(D16,0)+ISNULL(D17,0)+ISNULL(D18,0)+ISNULL(D19,0)+ISNULL(D20,0)+
ISNULL(D21,0)+ISNULL(D22,0)+ISNULL(D23,0)+ISNULL(D24,0)+ISNULL(D25,0)+ISNULL(D26,0)+ISNULL(D27,0)+ISNULL(D28,0)+ISNULL(D29,0)+ISNULL(D30,0)+ISNULL(D31,0) AS TotalTime
FROM	
(
SELECT DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, DateShift, ShiftTime, 1 AS TypeID
FROM #HP0532_HT1025
) P
PIVOT
(MAX(ShiftTime) FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31
) ) AS T1


----Insert dữ liệu Số giờ làm việc theo máy chấm công (TypeID = 2)
INSERT INTO #HP0532 (DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, TypeID, D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31,TotalTime)

SELECT	T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14,D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31,
ISNULL(D01,0)+ISNULL(D02,0)+ISNULL(D03,0)+ISNULL(D04,0)+ISNULL(D05,0)+ISNULL(D06,0)+ISNULL(D07,0)+ISNULL(D08,0)+ISNULL(D09,0)+ISNULL(D10,0)+ISNULL(D11,0)+
ISNULL(D12,0)+ISNULL(D13,0)+ISNULL(D14,0)+ISNULL(D15,0)+ISNULL(D16,0)+ISNULL(D17,0)+ISNULL(D18,0)+ISNULL(D19,0)+ISNULL(D20,0)+
ISNULL(D21,0)+ISNULL(D22,0)+ISNULL(D23,0)+ISNULL(D24,0)+ISNULL(D25,0)+ISNULL(D26,0)+ISNULL(D27,0)+ISNULL(D28,0)+ISNULL(D29,0)+ISNULL(D30,0)+ISNULL(D31,0) AS TotalTime
FROM	
(
SELECT DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, DateShift, AbsentTime, 2 AS TypeID
FROM #HP0532_HT1025
) P
PIVOT
(MAX(AbsentTime) FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31
) ) AS T1

----Insert dữ liệu Số giờ làm việc thực tế (TypeID = 3)
INSERT INTO #HP0532 (DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, TypeID, D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31, TotalTime)

SELECT	T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14,D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31,
ISNULL(D01,0)+ISNULL(D02,0)+ISNULL(D03,0)+ISNULL(D04,0)+ISNULL(D05,0)+ISNULL(D06,0)+ISNULL(D07,0)+ISNULL(D08,0)+ISNULL(D09,0)+ISNULL(D10,0)+ISNULL(D11,0)+
ISNULL(D12,0)+ISNULL(D13,0)+ISNULL(D14,0)+ISNULL(D15,0)+ISNULL(D16,0)+ISNULL(D17,0)+ISNULL(D18,0)+ISNULL(D19,0)+ISNULL(D20,0)+
ISNULL(D21,0)+ISNULL(D22,0)+ISNULL(D23,0)+ISNULL(D24,0)+ISNULL(D25,0)+ISNULL(D26,0)+ISNULL(D27,0)+ISNULL(D28,0)+ISNULL(D29,0)+ISNULL(D30,0)+ISNULL(D31,0) AS TotalTime
FROM	
(
SELECT DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, DateShift, ActualTime, 3 AS TypeID
FROM #HP0532_HT1025
) P
PIVOT
(MAX(ActualTime) FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31
) ) AS T1

----Insert dữ liệu Chênh lệch số giờ làm việc thực tế/xếp ca (TypeID = 4)
INSERT INTO #HP0532 (DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, TypeID, D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31, TotalTime)

SELECT	T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14,D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31,
ISNULL(D01,0)+ISNULL(D02,0)+ISNULL(D03,0)+ISNULL(D04,0)+ISNULL(D05,0)+ISNULL(D06,0)+ISNULL(D07,0)+ISNULL(D08,0)+ISNULL(D09,0)+ISNULL(D10,0)+ISNULL(D11,0)+
ISNULL(D12,0)+ISNULL(D13,0)+ISNULL(D14,0)+ISNULL(D15,0)+ISNULL(D16,0)+ISNULL(D17,0)+ISNULL(D18,0)+ISNULL(D19,0)+ISNULL(D20,0)+
ISNULL(D21,0)+ISNULL(D22,0)+ISNULL(D23,0)+ISNULL(D24,0)+ISNULL(D25,0)+ISNULL(D26,0)+ISNULL(D27,0)+ISNULL(D28,0)+ISNULL(D29,0)+ISNULL(D30,0)+ISNULL(D31,0) AS TotalTime
FROM	
(
SELECT DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, DateShift, 
CASE WHEN ISNULL(ActualTime,0) > ISNULL(ShiftTime,0) THEN ISNULL(ActualTime,0) - ISNULL(ShiftTime,0) ELSE 0 END AS Type4Number, 4 AS TypeID
FROM #HP0532_HT1025
) P
PIVOT
(MAX(Type4Number) FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31
) ) AS T1

----Insert dữ liệu Chênh lệch số giờ làm việc thực tế/máy chấm công (TypeID = 5)
INSERT INTO #HP0532 (DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, TypeID, D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31, TotalTime)

SELECT	T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14, T1.D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31,
ISNULL(D01,0)+ISNULL(D02,0)+ISNULL(D03,0)+ISNULL(D04,0)+ISNULL(D05,0)+ISNULL(D06,0)+ISNULL(D07,0)+ISNULL(D08,0)+ISNULL(D09,0)+ISNULL(D10,0)+ISNULL(D11,0)+
ISNULL(D12,0)+ISNULL(D13,0)+ISNULL(D14,0)+ISNULL(D15,0)+ISNULL(D16,0)+ISNULL(D17,0)+ISNULL(D18,0)+ISNULL(D19,0)+ISNULL(D20,0)+
ISNULL(D21,0)+ISNULL(D22,0)+ISNULL(D23,0)+ISNULL(D24,0)+ISNULL(D25,0)+ISNULL(D26,0)+ISNULL(D27,0)+ISNULL(D28,0)+ISNULL(D29,0)+ISNULL(D30,0)+ISNULL(D31,0) AS TotalTime
FROM	
(
SELECT DivisionID, EmployeeID, EmployeeName, TranMonth, TranYear, DepartmentID, DateShift, 
CASE WHEN ISNULL(ActualTime,0) > ISNULL(AbsentTime,0) THEN ISNULL(ActualTime,0) - ISNULL(AbsentTime,0) ELSE 0 END AS Type5Number, 5 AS TypeID
FROM #HP0532_HT1025
) P
PIVOT
(MAX(Type5Number) FOR DateShift IN (D01, D02, D03, D04, D05, D06, D07, D08, D09, 
D10, D11, D12, D13, D14,D15, D16, D17, D18, D19, D20, D21, D22, D23,D24, D25, D26, D27, D28, D29, D30, D31
) ) AS T1

SELECT T1.DivisionID, T1.EmployeeID, T1.EmployeeName, T1.TranMonth, T1.TranYear, T1.DepartmentID+' - '+ISNULL(T2.DepartmentName,N'') AS DepartmentID, T1.TypeID, 
T1.D01, T1.D02, T1.D03, T1.D04, T1.D05, T1.D06, T1.D07, T1.D08, T1.D09, T1.D10, T1.D11, T1.D12, T1.D13, T1.D14, T1.D15, T1.D16, T1.D17, T1.D18, T1.D19, T1.D20, 
T1.D21, T1.D22, T1.D23,D24, T1.D25, T1.D26, T1.D27, T1.D28, T1.D29, T1.D30, T1.D31, TotalTime
FROM #HP0532 T1
LEFT JOIN AT1102 T2 WITH (NOLOCK) ON T1.DepartmentID = T2.DepartmentID AND T2.DivisionID IN (T1.DivisionID,'@@@')

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO

