IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[HP0333]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[HP0333]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO



-- <Summary>
---- Update dữ liệu cho hồ sơ nhân sự từ form Cập nhật thay đổi hồ sơ nhân sự
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
-- <History>
---- Create on 02/12/2013 by Thanh Sơn
---- 
---- Modified on 23/11/2013 by Bảo Thy: bổ sung update C26->C150 (MEIKO)
-- <Example>
---- EXEC HP0333 'MK', 'ASOFTADMIN', '8A133395-0E4C-42D7-B920-7EBBC21A409E'
/*
INSERT INTO HT0330 (DivisionID, VoucherDate, Notes, FromDepartmentID, ToDepartmentID, BaseSalary)
VALUES ('AS', GETDATE(), 'Testing', 'ADM', 'PJS', 1500000)

SELECT * FROM  HT0330

*/
CREATE PROCEDURE HP0333
( 
		@DivisionID VARCHAR(50),
		@UserID VARCHAR(50),
		@APK VARCHAR(50)
		
) 
AS 
DECLARE @sWhere NVARCHAR(MAX),
		@sSQL1 NVARCHAR(MAX),
		@sSQL2 NVARCHAR(MAX),
		@sSQL3 NVARCHAR(MAX),
		@sSQL4 NVARCHAR(MAX)
		
SET @sWhere = ''
SET @sSQL2 = ''


DECLARE @FromDepartmentID NVARCHAR(50),
		@ToDepartmentID NVARCHAR(50),
		@FromTeamID NVARCHAR(50),
		@ToTeamID NVARCHAR(50),
		@FromEmployeeID NVARCHAR(50),
		@ToEmployeeID NVARCHAR(50),
		@CustomerIndex INT

SELECT @CustomerIndex = CustomerName From CustomerIndex

SELECT	@FromDepartmentID = FromDepartmentID ,
		@ToDepartmentID = ToDepartmentID,
		@FromTeamID = FromTeamID,
		@ToTeamID = ToTeamID,
		@FromEmployeeID = FromEmployeeID,
		@ToEmployeeID = ToEmployeeID
FROM HT0330 
WHERE DivisionID = @DivisionID 
AND APK = @APK

SET @sWhere = '
	AND HT1400.DepartmentID >= '''+@FromDepartmentID+'''
	AND HT1400.DepartmentID <= '''+@ToDepartmentID+'''
	'
IF ISNULL(@FromTeamID,'') <> '' OR  ISNULL(@ToTeamID,'') <> '' 
SET @sWhere = @sWhere + '
	AND HT1400.TeamID >= '''+@FromTeamID+'''
	AND HT1400.TeamID <= '''+@ToTeamID+'''
	'
IF ISNULL(@FromEmployeeID,'') <> '' OR  ISNULL(@ToEmployeeID,'') <> '' 
SET @sWhere = @sWhere + '
	AND HT1400.EmployeeID >= '''+@FromEmployeeID+'''
	AND HT1400.EmployeeID <= '''+@ToEmployeeID+'''
	'
	
CREATE TABLE #VALUES
(	
	TableID VARCHAR(50),
	ID VARCHAR(100)
)
 INSERT INTO #VALUES VALUES ('HT1403','IsJobWage') 
 INSERT INTO #VALUES VALUES ('HT1403','IsPiecework') 
 INSERT INTO #VALUES VALUES ('HT1403','SuggestSalary') 
 INSERT INTO #VALUES VALUES ('HT1403','BaseSalary') 
 INSERT INTO #VALUES VALUES ('HT1403','InsuranceSalary') 
 INSERT INTO #VALUES VALUES ('HT1403','Salary01') 
 INSERT INTO #VALUES VALUES ('HT1403','Salary02') 
 INSERT INTO #VALUES VALUES ('HT1403','Salary03') 
 INSERT INTO #VALUES VALUES ('HT1403','SalaryCoefficient') 
 INSERT INTO #VALUES VALUES ('HT1403','TaxObjectID') 
 INSERT INTO #VALUES VALUES ('HT1403','LoaCondID') 
 INSERT INTO #VALUES VALUES ('HT1403','DutyID') 
 INSERT INTO #VALUES VALUES ('HT1403','DutyCoefficient') 
 INSERT INTO #VALUES VALUES ('HT1403','TimeCoefficient') 
 INSERT INTO #VALUES VALUES ('HT1403','C01') 
 INSERT INTO #VALUES VALUES ('HT1403','C02') 
 INSERT INTO #VALUES VALUES ('HT1403','C03') 
 INSERT INTO #VALUES VALUES ('HT1403','C04') 
 INSERT INTO #VALUES VALUES ('HT1403','C05') 
 INSERT INTO #VALUES VALUES ('HT1403','C06') 
 INSERT INTO #VALUES VALUES ('HT1403','C07') 
 INSERT INTO #VALUES VALUES ('HT1403','C08') 
 INSERT INTO #VALUES VALUES ('HT1403','C09') 
 INSERT INTO #VALUES VALUES ('HT1403','C10') 
 INSERT INTO #VALUES VALUES ('HT1403','C11') 
 INSERT INTO #VALUES VALUES ('HT1403','C12') 
 INSERT INTO #VALUES VALUES ('HT1403','C13') 
 INSERT INTO #VALUES VALUES ('HT1403','C14') 
 INSERT INTO #VALUES VALUES ('HT1403','C15') 
 INSERT INTO #VALUES VALUES ('HT1403','C16') 
 INSERT INTO #VALUES VALUES ('HT1403','C17') 
 INSERT INTO #VALUES VALUES ('HT1403','C18') 
 INSERT INTO #VALUES VALUES ('HT1403','C19') 
 INSERT INTO #VALUES VALUES ('HT1403','C20') 
 INSERT INTO #VALUES VALUES ('HT1403','C21') 
 INSERT INTO #VALUES VALUES ('HT1403','C22') 
 INSERT INTO #VALUES VALUES ('HT1403','C23') 
 INSERT INTO #VALUES VALUES ('HT1403','C24') 
 INSERT INTO #VALUES VALUES ('HT1403','C25') 
 INSERT INTO #VALUES VALUES ('HT1403','Target01ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount01') 
 INSERT INTO #VALUES VALUES ('HT1403','Target02ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount02') 
 INSERT INTO #VALUES VALUES ('HT1403','Target03ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount03') 
 INSERT INTO #VALUES VALUES ('HT1403','Target04ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount04') 
 INSERT INTO #VALUES VALUES ('HT1403','Target05ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount05') 
 INSERT INTO #VALUES VALUES ('HT1403','Target06ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount06') 
 INSERT INTO #VALUES VALUES ('HT1403','Target07ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount07') 
 INSERT INTO #VALUES VALUES ('HT1403','Target08ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount08') 
 INSERT INTO #VALUES VALUES ('HT1403','Target09ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount09') 
 INSERT INTO #VALUES VALUES ('HT1403','Target10ID') 
 INSERT INTO #VALUES VALUES ('HT1403','TargetAmount10') 


INSERT INTO #VALUES VALUES ('HT1403_1','C26') 
INSERT INTO #VALUES VALUES ('HT1403_1','C27') 
INSERT INTO #VALUES VALUES ('HT1403_1','C28') 
INSERT INTO #VALUES VALUES ('HT1403_1','C29') 
INSERT INTO #VALUES VALUES ('HT1403_1','C30') 
INSERT INTO #VALUES VALUES ('HT1403_1','C31') 
INSERT INTO #VALUES VALUES ('HT1403_1','C32') 
INSERT INTO #VALUES VALUES ('HT1403_1','C33') 
INSERT INTO #VALUES VALUES ('HT1403_1','C34') 
INSERT INTO #VALUES VALUES ('HT1403_1','C35') 
INSERT INTO #VALUES VALUES ('HT1403_1','C36') 
INSERT INTO #VALUES VALUES ('HT1403_1','C37') 
INSERT INTO #VALUES VALUES ('HT1403_1','C38') 
INSERT INTO #VALUES VALUES ('HT1403_1','C39') 
INSERT INTO #VALUES VALUES ('HT1403_1','C40')
INSERT INTO #VALUES VALUES ('HT1403_1','C41') 
INSERT INTO #VALUES VALUES ('HT1403_1','C42') 
INSERT INTO #VALUES VALUES ('HT1403_1','C43') 
INSERT INTO #VALUES VALUES ('HT1403_1','C44') 
INSERT INTO #VALUES VALUES ('HT1403_1','C45') 
INSERT INTO #VALUES VALUES ('HT1403_1','C46') 
INSERT INTO #VALUES VALUES ('HT1403_1','C47') 
INSERT INTO #VALUES VALUES ('HT1403_1','C48') 
INSERT INTO #VALUES VALUES ('HT1403_1','C49') 
INSERT INTO #VALUES VALUES ('HT1403_1','C50') 
INSERT INTO #VALUES VALUES ('HT1403_1','C51') 
INSERT INTO #VALUES VALUES ('HT1403_1','C52') 
INSERT INTO #VALUES VALUES ('HT1403_1','C53') 
INSERT INTO #VALUES VALUES ('HT1403_1','C54') 
INSERT INTO #VALUES VALUES ('HT1403_1','C55') 
INSERT INTO #VALUES VALUES ('HT1403_1','C56') 
INSERT INTO #VALUES VALUES ('HT1403_1','C57') 
INSERT INTO #VALUES VALUES ('HT1403_1','C58') 
INSERT INTO #VALUES VALUES ('HT1403_1','C59')
INSERT INTO #VALUES VALUES ('HT1403_1','C60') 
INSERT INTO #VALUES VALUES ('HT1403_1','C61') 
INSERT INTO #VALUES VALUES ('HT1403_1','C62') 
INSERT INTO #VALUES VALUES ('HT1403_1','C63') 
INSERT INTO #VALUES VALUES ('HT1403_1','C64') 
INSERT INTO #VALUES VALUES ('HT1403_1','C65') 
INSERT INTO #VALUES VALUES ('HT1403_1','C66') 
INSERT INTO #VALUES VALUES ('HT1403_1','C67') 
INSERT INTO #VALUES VALUES ('HT1403_1','C68') 
INSERT INTO #VALUES VALUES ('HT1403_1','C69')
INSERT INTO #VALUES VALUES ('HT1403_1','C70') 
INSERT INTO #VALUES VALUES ('HT1403_1','C71') 
INSERT INTO #VALUES VALUES ('HT1403_1','C72') 
INSERT INTO #VALUES VALUES ('HT1403_1','C73') 
INSERT INTO #VALUES VALUES ('HT1403_1','C74') 
INSERT INTO #VALUES VALUES ('HT1403_1','C75') 
INSERT INTO #VALUES VALUES ('HT1403_1','C76') 
INSERT INTO #VALUES VALUES ('HT1403_1','C77') 
INSERT INTO #VALUES VALUES ('HT1403_1','C78') 
INSERT INTO #VALUES VALUES ('HT1403_1','C79')
INSERT INTO #VALUES VALUES ('HT1403_1','C80') 
INSERT INTO #VALUES VALUES ('HT1403_1','C81') 
INSERT INTO #VALUES VALUES ('HT1403_1','C82') 
INSERT INTO #VALUES VALUES ('HT1403_1','C83') 
INSERT INTO #VALUES VALUES ('HT1403_1','C84') 
INSERT INTO #VALUES VALUES ('HT1403_1','C85') 
INSERT INTO #VALUES VALUES ('HT1403_1','C86') 
INSERT INTO #VALUES VALUES ('HT1403_1','C87') 
INSERT INTO #VALUES VALUES ('HT1403_1','C88') 
INSERT INTO #VALUES VALUES ('HT1403_1','C89')
INSERT INTO #VALUES VALUES ('HT1403_1','C90') 
INSERT INTO #VALUES VALUES ('HT1403_1','C91') 
INSERT INTO #VALUES VALUES ('HT1403_1','C92') 
INSERT INTO #VALUES VALUES ('HT1403_1','C93') 
INSERT INTO #VALUES VALUES ('HT1403_1','C94') 
INSERT INTO #VALUES VALUES ('HT1403_1','C95') 
INSERT INTO #VALUES VALUES ('HT1403_1','C96') 
INSERT INTO #VALUES VALUES ('HT1403_1','C97') 
INSERT INTO #VALUES VALUES ('HT1403_1','C98') 
INSERT INTO #VALUES VALUES ('HT1403_1','C99')
INSERT INTO #VALUES VALUES ('HT1403_1','C100')
INSERT INTO #VALUES VALUES ('HT1403_1','C101') 
INSERT INTO #VALUES VALUES ('HT1403_1','C102') 
INSERT INTO #VALUES VALUES ('HT1403_1','C103') 
INSERT INTO #VALUES VALUES ('HT1403_1','C104') 
INSERT INTO #VALUES VALUES ('HT1403_1','C105') 
INSERT INTO #VALUES VALUES ('HT1403_1','C106') 
INSERT INTO #VALUES VALUES ('HT1403_1','C107') 
INSERT INTO #VALUES VALUES ('HT1403_1','C108') 
INSERT INTO #VALUES VALUES ('HT1403_1','C109')
INSERT INTO #VALUES VALUES ('HT1403_1','C100')
INSERT INTO #VALUES VALUES ('HT1403_1','C111') 
INSERT INTO #VALUES VALUES ('HT1403_1','C112') 
INSERT INTO #VALUES VALUES ('HT1403_1','C113') 
INSERT INTO #VALUES VALUES ('HT1403_1','C114') 
INSERT INTO #VALUES VALUES ('HT1403_1','C115') 
INSERT INTO #VALUES VALUES ('HT1403_1','C116') 
INSERT INTO #VALUES VALUES ('HT1403_1','C117') 
INSERT INTO #VALUES VALUES ('HT1403_1','C118') 
INSERT INTO #VALUES VALUES ('HT1403_1','C119')
INSERT INTO #VALUES VALUES ('HT1403_1','C120')
INSERT INTO #VALUES VALUES ('HT1403_1','C121') 
INSERT INTO #VALUES VALUES ('HT1403_1','C122') 
INSERT INTO #VALUES VALUES ('HT1403_1','C123') 
INSERT INTO #VALUES VALUES ('HT1403_1','C124') 
INSERT INTO #VALUES VALUES ('HT1403_1','C125') 
INSERT INTO #VALUES VALUES ('HT1403_1','C126') 
INSERT INTO #VALUES VALUES ('HT1403_1','C127') 
INSERT INTO #VALUES VALUES ('HT1403_1','C128') 
INSERT INTO #VALUES VALUES ('HT1403_1','C129')
INSERT INTO #VALUES VALUES ('HT1403_1','C130')
INSERT INTO #VALUES VALUES ('HT1403_1','C131') 
INSERT INTO #VALUES VALUES ('HT1403_1','C132') 
INSERT INTO #VALUES VALUES ('HT1403_1','C133') 
INSERT INTO #VALUES VALUES ('HT1403_1','C134') 
INSERT INTO #VALUES VALUES ('HT1403_1','C135') 
INSERT INTO #VALUES VALUES ('HT1403_1','C136') 
INSERT INTO #VALUES VALUES ('HT1403_1','C137') 
INSERT INTO #VALUES VALUES ('HT1403_1','C138') 
INSERT INTO #VALUES VALUES ('HT1403_1','C139')
INSERT INTO #VALUES VALUES ('HT1403_1','C140')
INSERT INTO #VALUES VALUES ('HT1403_1','C141') 
INSERT INTO #VALUES VALUES ('HT1403_1','C142') 
INSERT INTO #VALUES VALUES ('HT1403_1','C143') 
INSERT INTO #VALUES VALUES ('HT1403_1','C144') 
INSERT INTO #VALUES VALUES ('HT1403_1','C145') 
INSERT INTO #VALUES VALUES ('HT1403_1','C146') 
INSERT INTO #VALUES VALUES ('HT1403_1','C147') 
INSERT INTO #VALUES VALUES ('HT1403_1','C148') 
INSERT INTO #VALUES VALUES ('HT1403_1','C149')
INSERT INTO #VALUES VALUES ('HT1403_1','C150')
 

DECLARE @cursor CURSOR , 
		@ID VARCHAR(100),
		@TableID VARCHAR(50),
		@TableHT0330 VARCHAR(50)	

	SET @sSQL1 = '
	CREATE TABLE #Employee
	(	
		EmployeeID NVARCHAR(50)
	)
	
	INSERT INTO #Employee (	EmployeeID)
	SELECT EmployeeID 
	FROM HT1400 
	WHERE DivisionID = '''+@DivisionID+'''
	'

SET @cursor = CURSOR FORWARD_ONLY FOR
SELECT ID, TableID
FROM #VALUES

OPEN @cursor

FETCH NEXT FROM @cursor INTO @ID, @TableID
WHILE @@FETCH_STATUS = 0
BEGIN
	IF @TableID = 'HT1403' SET @TableHT0330 = 'HT0330'
	ELSE SET @TableHT0330 = 'HT0330_1'

	SET @sSQL2 = '
	DECLARE @SValue NVARCHAR(250)
	SET @SValue = (SELECT '+@ID+' FROM '+@TableHT0330+' WHERE APK = '''+@APK+''' )
	IF @SValue IS NOT NULL
	BEGIN
		UPDATE	'+@TableID+'
		SET		'+@ID+' = @SValue
		WHERE	DivisionID = '''+@DivisionID+'''
				AND EmployeeID IN (SELECT EmployeeID FROM #Employee )
	END
	'
	--PRINT(@sSQL1)
	--PRINT(@sWhere)
	--PRINT(@sSQL2)

	EXEC (@sSQL1+@sWhere+@sSQL2)
	
  FETCH NEXT FROM @cursor INTO @ID, @TableID
END 
CLOSE @cursor
DEALLOCATE @cursor


GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
