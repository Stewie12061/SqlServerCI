IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[HP0334]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[HP0334]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO



-- <Summary>
---- Update dữ liệu cho hồ sơ lương từ form Cập nhật thay đổi hồ sơ nhân sự
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
-- <History>
---- Create on 02/12/2013 by Thanh Sơn
---- 
---- Modified on 23/11/2013 by Bảo Thy: bổ sung update C26->C150 (MEIKO)
-- <Example>
---- EXEC HP0334 'MK', 'ASOFTADMIN', '9E1E5667-BE42-4248-8880-7ED2BD6D608D',11,2016
/*
INSERT INTO HT0330 (DivisionID, VoucherDate, Notes, FromDepartmentID, ToDepartmentID, BaseSalary)
VALUES ('AS', GETDATE(), 'Testing', 'ADM', 'PJS', 1500000)

*/
CREATE PROCEDURE HP0334
( 
		@DivisionID VARCHAR(50),
		@UserID VARCHAR(50),
		@APK VARCHAR(50),
		@TranMonth INT,
		@TranYear INT		
) 
AS 
DECLARE @sWhere NVARCHAR(MAX),
		@sSQL1 NVARCHAR(MAX),
		@sSQL2 NVARCHAR(MAX),
		@sSQL3 NVARCHAR(MAX),
		@sSQL4 NVARCHAR(MAX),
		@CustomerIndex INT

SELECT @CustomerIndex = CustomerName From CustomerIndex
		
SET @sWhere = ''
SET @sSQL2 = ''


DECLARE @FromDepartmentID NVARCHAR(50),
		@ToDepartmentID NVARCHAR(50),
		@FromTeamID NVARCHAR(50),
		@ToTeamID NVARCHAR(50),
		@FromEmployeeID NVARCHAR(50),
		@ToEmployeeID NVARCHAR(50)

SELECT	@FromDepartmentID = FromDepartmentID ,
		@ToDepartmentID = ToDepartmentID,
		@FromTeamID = FromTeamID,
		@ToTeamID = ToTeamID,
		@FromEmployeeID = FromEmployeeID,
		@ToEmployeeID = ToEmployeeID
FROM HT0330 
WHERE DivisionID = @DivisionID 
AND APK = @APK

SET @sWhere = '
	AND HT2400.DepartmentID >= '''+@FromDepartmentID+'''
	AND HT2400.DepartmentID <= '''+@ToDepartmentID+'''
	'
IF ISNULL(@FromTeamID,'') <> '' OR  ISNULL(@ToTeamID,'') <> '' 
SET @sWhere = @sWhere + '
	AND HT2400.TeamID >= '''+@FromTeamID+'''
	AND HT2400.TeamID <= '''+@ToTeamID+'''
	'
IF ISNULL(@FromEmployeeID,'') <> '' OR  ISNULL(@ToEmployeeID,'') <> '' 
SET @sWhere = @sWhere + '
	AND HT2400.EmployeeID >= '''+@FromEmployeeID+'''
	AND HT2400.EmployeeID <= '''+@ToEmployeeID+'''
	'
	
CREATE TABLE #VALUES
(	
	TableID VARCHAR(50),
	ID VARCHAR(100)
)
 INSERT INTO #VALUES VALUES ('HT2400','IsJobWage') 
 INSERT INTO #VALUES VALUES ('HT2400','IsPiecework') 
 INSERT INTO #VALUES VALUES ('HT2400','BaseSalary') 
 INSERT INTO #VALUES VALUES ('HT2400','InsuranceSalary') 
 INSERT INTO #VALUES VALUES ('HT2400','Salary01') 
 INSERT INTO #VALUES VALUES ('HT2400','Salary02') 
 INSERT INTO #VALUES VALUES ('HT2400','Salary03') 
 INSERT INTO #VALUES VALUES ('HT2400','SalaryCoefficient') 
 INSERT INTO #VALUES VALUES ('HT2400','TaxObjectID')
 INSERT INTO #VALUES VALUES ('HT2400','DutyCoefficient') 
 INSERT INTO #VALUES VALUES ('HT2400','TimeCoefficient') 
 INSERT INTO #VALUES VALUES ('HT2400','C01') 
 INSERT INTO #VALUES VALUES ('HT2400','C02') 
 INSERT INTO #VALUES VALUES ('HT2400','C03') 
 INSERT INTO #VALUES VALUES ('HT2400','C04') 
 INSERT INTO #VALUES VALUES ('HT2400','C05') 
 INSERT INTO #VALUES VALUES ('HT2400','C06') 
 INSERT INTO #VALUES VALUES ('HT2400','C07') 
 INSERT INTO #VALUES VALUES ('HT2400','C08') 
 INSERT INTO #VALUES VALUES ('HT2400','C09') 
 INSERT INTO #VALUES VALUES ('HT2400','C10') 
 INSERT INTO #VALUES VALUES ('HT2400','C11') 
 INSERT INTO #VALUES VALUES ('HT2400','C12') 
 INSERT INTO #VALUES VALUES ('HT2400','C13') 
 INSERT INTO #VALUES VALUES ('HT2400','C14') 
 INSERT INTO #VALUES VALUES ('HT2400','C15') 
 INSERT INTO #VALUES VALUES ('HT2400','C16') 
 INSERT INTO #VALUES VALUES ('HT2400','C17') 
 INSERT INTO #VALUES VALUES ('HT2400','C18') 
 INSERT INTO #VALUES VALUES ('HT2400','C19') 
 INSERT INTO #VALUES VALUES ('HT2400','C20') 
 INSERT INTO #VALUES VALUES ('HT2400','C21') 
 INSERT INTO #VALUES VALUES ('HT2400','C22') 
 INSERT INTO #VALUES VALUES ('HT2400','C23') 
 INSERT INTO #VALUES VALUES ('HT2400','C24') 
 INSERT INTO #VALUES VALUES ('HT2400','C25') 

INSERT INTO #VALUES VALUES ('HT2499','C26') 
INSERT INTO #VALUES VALUES ('HT2499','C27') 
INSERT INTO #VALUES VALUES ('HT2499','C28') 
INSERT INTO #VALUES VALUES ('HT2499','C29') 
INSERT INTO #VALUES VALUES ('HT2499','C30') 
INSERT INTO #VALUES VALUES ('HT2499','C31') 
INSERT INTO #VALUES VALUES ('HT2499','C32') 
INSERT INTO #VALUES VALUES ('HT2499','C33') 
INSERT INTO #VALUES VALUES ('HT2499','C34') 
INSERT INTO #VALUES VALUES ('HT2499','C35') 
INSERT INTO #VALUES VALUES ('HT2499','C36') 
INSERT INTO #VALUES VALUES ('HT2499','C37') 
INSERT INTO #VALUES VALUES ('HT2499','C38') 
INSERT INTO #VALUES VALUES ('HT2499','C39') 
INSERT INTO #VALUES VALUES ('HT2499','C40')
INSERT INTO #VALUES VALUES ('HT2499','C41') 
INSERT INTO #VALUES VALUES ('HT2499','C42') 
INSERT INTO #VALUES VALUES ('HT2499','C43') 
INSERT INTO #VALUES VALUES ('HT2499','C44') 
INSERT INTO #VALUES VALUES ('HT2499','C45') 
INSERT INTO #VALUES VALUES ('HT2499','C46') 
INSERT INTO #VALUES VALUES ('HT2499','C47') 
INSERT INTO #VALUES VALUES ('HT2499','C48') 
INSERT INTO #VALUES VALUES ('HT2499','C49') 
INSERT INTO #VALUES VALUES ('HT2499','C50') 
INSERT INTO #VALUES VALUES ('HT2499','C51') 
INSERT INTO #VALUES VALUES ('HT2499','C52') 
INSERT INTO #VALUES VALUES ('HT2499','C53') 
INSERT INTO #VALUES VALUES ('HT2499','C54') 
INSERT INTO #VALUES VALUES ('HT2499','C55') 
INSERT INTO #VALUES VALUES ('HT2499','C56') 
INSERT INTO #VALUES VALUES ('HT2499','C57') 
INSERT INTO #VALUES VALUES ('HT2499','C58') 
INSERT INTO #VALUES VALUES ('HT2499','C59')
INSERT INTO #VALUES VALUES ('HT2499','C60') 
INSERT INTO #VALUES VALUES ('HT2499','C61') 
INSERT INTO #VALUES VALUES ('HT2499','C62') 
INSERT INTO #VALUES VALUES ('HT2499','C63') 
INSERT INTO #VALUES VALUES ('HT2499','C64') 
INSERT INTO #VALUES VALUES ('HT2499','C65') 
INSERT INTO #VALUES VALUES ('HT2499','C66') 
INSERT INTO #VALUES VALUES ('HT2499','C67') 
INSERT INTO #VALUES VALUES ('HT2499','C68') 
INSERT INTO #VALUES VALUES ('HT2499','C69')
INSERT INTO #VALUES VALUES ('HT2499','C70') 
INSERT INTO #VALUES VALUES ('HT2499','C71') 
INSERT INTO #VALUES VALUES ('HT2499','C72') 
INSERT INTO #VALUES VALUES ('HT2499','C73') 
INSERT INTO #VALUES VALUES ('HT2499','C74') 
INSERT INTO #VALUES VALUES ('HT2499','C75') 
INSERT INTO #VALUES VALUES ('HT2499','C76') 
INSERT INTO #VALUES VALUES ('HT2499','C77') 
INSERT INTO #VALUES VALUES ('HT2499','C78') 
INSERT INTO #VALUES VALUES ('HT2499','C79')
INSERT INTO #VALUES VALUES ('HT2499','C80') 
INSERT INTO #VALUES VALUES ('HT2499','C81') 
INSERT INTO #VALUES VALUES ('HT2499','C82') 
INSERT INTO #VALUES VALUES ('HT2499','C83') 
INSERT INTO #VALUES VALUES ('HT2499','C84') 
INSERT INTO #VALUES VALUES ('HT2499','C85') 
INSERT INTO #VALUES VALUES ('HT2499','C86') 
INSERT INTO #VALUES VALUES ('HT2499','C87') 
INSERT INTO #VALUES VALUES ('HT2499','C88') 
INSERT INTO #VALUES VALUES ('HT2499','C89')
INSERT INTO #VALUES VALUES ('HT2499','C90') 
INSERT INTO #VALUES VALUES ('HT2499','C91') 
INSERT INTO #VALUES VALUES ('HT2499','C92') 
INSERT INTO #VALUES VALUES ('HT2499','C93') 
INSERT INTO #VALUES VALUES ('HT2499','C94') 
INSERT INTO #VALUES VALUES ('HT2499','C95') 
INSERT INTO #VALUES VALUES ('HT2499','C96') 
INSERT INTO #VALUES VALUES ('HT2499','C97') 
INSERT INTO #VALUES VALUES ('HT2499','C98') 
INSERT INTO #VALUES VALUES ('HT2499','C99')
INSERT INTO #VALUES VALUES ('HT2499','C100')
INSERT INTO #VALUES VALUES ('HT2499','C101') 
INSERT INTO #VALUES VALUES ('HT2499','C102') 
INSERT INTO #VALUES VALUES ('HT2499','C103') 
INSERT INTO #VALUES VALUES ('HT2499','C104') 
INSERT INTO #VALUES VALUES ('HT2499','C105') 
INSERT INTO #VALUES VALUES ('HT2499','C106') 
INSERT INTO #VALUES VALUES ('HT2499','C107') 
INSERT INTO #VALUES VALUES ('HT2499','C108') 
INSERT INTO #VALUES VALUES ('HT2499','C109')
INSERT INTO #VALUES VALUES ('HT2499','C100')
INSERT INTO #VALUES VALUES ('HT2499','C111') 
INSERT INTO #VALUES VALUES ('HT2499','C112') 
INSERT INTO #VALUES VALUES ('HT2499','C113') 
INSERT INTO #VALUES VALUES ('HT2499','C114') 
INSERT INTO #VALUES VALUES ('HT2499','C115') 
INSERT INTO #VALUES VALUES ('HT2499','C116') 
INSERT INTO #VALUES VALUES ('HT2499','C117') 
INSERT INTO #VALUES VALUES ('HT2499','C118') 
INSERT INTO #VALUES VALUES ('HT2499','C119')
INSERT INTO #VALUES VALUES ('HT2499','C120')
INSERT INTO #VALUES VALUES ('HT2499','C121') 
INSERT INTO #VALUES VALUES ('HT2499','C122') 
INSERT INTO #VALUES VALUES ('HT2499','C123') 
INSERT INTO #VALUES VALUES ('HT2499','C124') 
INSERT INTO #VALUES VALUES ('HT2499','C125') 
INSERT INTO #VALUES VALUES ('HT2499','C126') 
INSERT INTO #VALUES VALUES ('HT2499','C127') 
INSERT INTO #VALUES VALUES ('HT2499','C128') 
INSERT INTO #VALUES VALUES ('HT2499','C129')
INSERT INTO #VALUES VALUES ('HT2499','C130')
INSERT INTO #VALUES VALUES ('HT2499','C131') 
INSERT INTO #VALUES VALUES ('HT2499','C132') 
INSERT INTO #VALUES VALUES ('HT2499','C133') 
INSERT INTO #VALUES VALUES ('HT2499','C134') 
INSERT INTO #VALUES VALUES ('HT2499','C135') 
INSERT INTO #VALUES VALUES ('HT2499','C136') 
INSERT INTO #VALUES VALUES ('HT2499','C137') 
INSERT INTO #VALUES VALUES ('HT2499','C138') 
INSERT INTO #VALUES VALUES ('HT2499','C139')
INSERT INTO #VALUES VALUES ('HT2499','C140')
INSERT INTO #VALUES VALUES ('HT2499','C141') 
INSERT INTO #VALUES VALUES ('HT2499','C142') 
INSERT INTO #VALUES VALUES ('HT2499','C143') 
INSERT INTO #VALUES VALUES ('HT2499','C144') 
INSERT INTO #VALUES VALUES ('HT2499','C145') 
INSERT INTO #VALUES VALUES ('HT2499','C146') 
INSERT INTO #VALUES VALUES ('HT2499','C147') 
INSERT INTO #VALUES VALUES ('HT2499','C148') 
INSERT INTO #VALUES VALUES ('HT2499','C149')
INSERT INTO #VALUES VALUES ('HT2499','C150')
 

SET @sSQL1 = '
CREATE TABLE #Employee
(	
	EmployeeID NVARCHAR(50)
)

INSERT INTO #Employee (	EmployeeID)
SELECT EmployeeID 
FROM HT2400 
WHERE DivisionID = '''+@DivisionID+'''
AND TranMonth = '''+STR(@TranMonth)+'''
AND TranYear = '''+STR(@TranYear)+'''
'

DECLARE @cursor CURSOR , 
		@ID VARCHAR(100),
		@TableID VARCHAR(50),
		@TableHT0330 nVARCHAR(50)	
		
SET @cursor = CURSOR FORWARD_ONLY FOR
SELECT ID, TableID
FROM #VALUES

OPEN @cursor

FETCH NEXT FROM @cursor INTO @ID, @TableID
WHILE @@FETCH_STATUS = 0
BEGIN
	IF @TableID = 'HT2400' SET @TableHT0330 = 'HT0330'
	ELSE SET @TableHT0330 = 'HT0330_1'

	SET @sSQL2 = '
	DECLARE @SValue NVARCHAR(250)
	SET @SValue = (SELECT '+@ID+' FROM '+@TableHT0330+' WHERE APK = '''+@APK+''' )
	IF @SValue IS NOT NULL
	BEGIN
		UPDATE	'+@TableID+'
		SET		'+@ID+' = @SValue
		WHERE	DivisionID = '''+@DivisionID+'''
				AND EmployeeID IN (SELECT EmployeeID FROM #Employee )
				AND TranMonth = '''+STR(@TranMonth)+'''
                AND TranYear = '''+STR(@TranYear)+'''
	END
	'
	--PRINT(@sSQL1)
	--PRINT(@sWhere)
	--PRINT(@sSQL2)

	EXEC (@sSQL1+@sWhere+@sSQL2)

  FETCH NEXT FROM @cursor INTO @ID, @TableID
END 
CLOSE @cursor
DEALLOCATE @cursor

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
