IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[MP0200]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[MP0200]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO


-- <Summary>
--- In báo cáo theo dõi hóa đơn tại OP (ANGEL)
-- <Param>
----
-- <Return>
----
-- <Reference>
----
-- <History>
---- Created by Tieu Mai on 01/08/2017
---- Modified on 13/10/2020 by Nhựt Trường: (Sửa danh mục dùng chung) Bổ sung điều kiện DivisionID IN cho AT1302.
---- Modified by Đức Duy on 20/02/2023: [2023/02/IS/0091] - Bổ sung thêm điều kiện DivisionID dùng chung cho bảng danh mục đối tượng - AT1202.
-- <Example>
/*	select * from AT1015 where AnaTypeID = 'A03'
	exec MP0200 'ANG', '2017-01-02 00:00:00.000', '2017-07-27 00:00:00.000', 1, 2016, 8, 2016, 0, 'ANHPHU', 'VTL-000000042', '010101', '120201', 'COC.PHC.D300C', 'COC.PHC.D300C'	

*/
CREATE PROCEDURE MP0200
(
	@DivisionID		NVARCHAR(50),
	@FromDate		DATETIME,
	@ToDate			DATETIME,
	@FromMonth		INT,
	@FromYear		INT,
	@ToMonth		INT,
	@ToYear			INT,
	@IsDate			TINYINT,
	@FromObjectID	NVARCHAR(50),
	@ToObjectID		NVARCHAR(50),
	@FromAna03ID	NVARCHAR(50),
	@ToAna03ID		NVARCHAR(50),
	@FromI02ID		NVARCHAR(50),
	@ToI02ID		NVARCHAR(50)
	
)
AS

DECLARE @sSQL NVARCHAR(MAX),
		@sSQL1 NVARCHAR(MAX),
		@sSQL2 NVARCHAR(MAX),
		@sSQL3 NVARCHAR(MAX),
		@sSQL4 NVARCHAR(MAX),
		@sWhere NVARCHAR(MAX),
		@sWhere1 NVARCHAR(MAX),
		@sWhere2 NVARCHAR(MAX)
		
		
SET @sSQL = N''
SET @sSQL1 = N''
SET @sWhere = N''
SET @sWhere1 = N''
SET @sWhere2 = N''

IF @IsDate = 0
BEGIN
	SET @sWhere = @sWhere + N' AND O01.TranMonth + O01.TranYear*100 BETWEEN '+STR(@FromMonth+@FromYear*100)+' AND '+ STR(@ToMonth+@ToYear*100)
	SET @sWhere1 = @sWhere1 + N' AND M01.TranMonth + M01.TranYear*100 BETWEEN '+STR(@FromMonth+@FromYear*100)+' AND '+ STR(@ToMonth+@ToYear*100)
	SET @sWhere2 = @sWhere2 + N' AND A06.TranMonth + A06.TranYear*100 BETWEEN '+STR(@FromMonth+@FromYear*100)+' AND '+ STR(@ToMonth+@ToYear*100)
END
ELSE
BEGIN
	SET @sWhere = @sWhere + N' AND CONVERT(NVARCHAR(10),O01.OrderDate,101) BETWEEN '''+CONVERT(NVARCHAR(10),@FromDate,101)+''' AND '''+ CONVERT(NVARCHAR(10),@ToDate,101)+''''
	SET @sWhere1 = @sWhere1 + N' AND CONVERT(NVARCHAR(10),M01.VoucherDate,101) BETWEEN '''+CONVERT(NVARCHAR(10),@FromDate,101)+''' AND '''+ CONVERT(NVARCHAR(10),@ToDate,101)+''''
	SET @sWhere2 = @sWhere2 + N' AND CONVERT(NVARCHAR(10),A06.VoucherDate,101) BETWEEN '''+CONVERT(NVARCHAR(10),@FromDate,101)+''' AND '''+ CONVERT(NVARCHAR(10),@ToDate,101)+''''
END

SET @sSQL = '
---- Lấy khối lượng đặt hàng
SELECT O02.DivisionID, O01.ObjectID, CONVERT(NVARCHAR(10),O01.OrderDate,101) OrderDate, A32.I02ID, O02.InventoryID, A32.InventoryName, O02.UnitID, O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	O02.Ana01ID, O02.Ana02ID, O02.Ana03ID, O02.Ana04ID, O02.Ana05ID, O02.Ana06ID, O02.Ana07ID, O02.Ana08ID, O02.Ana09ID, O02.Ana10ID,
	SUM(O02.OrderQuantity) AS OrderQuantity
INTO #TEMP1
FROM OT2002 O02 WITH (NOLOCK)
LEFT JOIN OT2001 O01 WITH (NOLOCK) ON O01.DivisionID = O02.DivisionID AND O01.SOrderID = O02.SOrderID
LEFT JOIN OT8899 O99 WITH (NOLOCK) ON O99.DivisionID = O02.DivisionID AND O99.TransactionID = O02.TransactionID AND O02.SOrderID = O99.VoucherID
LEFT JOIN AT1020 A20 WITH (NOLOCK) ON A20.DivisionID = O02.DivisionID AND A20.ContractID = O02.InheritVoucherID
LEFT JOIN AT1302 A32 WITH (NOLOCK) ON A32.InventoryID = O02.InventoryID AND A32.DivisionID IN (O02.DivisionID,''@@@'')
WHERE O02.DivisionID = '''+@DivisionID+''' AND O01.ObjectID BETWEEN '''+@FromObjectID+''' AND '''+@ToObjectID+'''
	AND A32.I02ID BETWEEN '''+@FromI02ID+''' AND '''+@ToI02ID+'''
	AND O02.Ana03ID BETWEEN '''+@FromAna03ID+''' AND '''+@ToAna03ID+'''
	'+@sWhere+'
GROUP BY  O02.DivisionID, O01.ObjectID, O01.OrderDate, A32.I02ID, O02.InventoryID, A32.InventoryName, O02.UnitID, O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	O02.Ana01ID, O02.Ana02ID, O02.Ana03ID, O02.Ana04ID, O02.Ana05ID, O02.Ana06ID, O02.Ana07ID, O02.Ana08ID, O02.Ana09ID, O02.Ana10ID
'
SET @sSQL1 = '
---- Lấy khối lượng sản xuất
SELECT M01.DivisionID, M01.ObjectID, M01.VoucherDate, A32.I02ID, M02.ProductID AS InventoryID, M02.S01ID, M02.S02ID, M02.S03ID, M02.S04ID, M02.S05ID, M02.S06ID, M02.S07ID, M02.S08ID, M02.S09ID, M02.S10ID,
	M02.S11ID, M02.S12ID, M02.S13ID, M02.S14ID, M02.S15ID, M02.S16ID, M02.S17ID, M02.S18ID, M02.S19ID, M02.S20ID,
	M02.Ana01ID, M02.Ana02ID, M02.Ana03ID, M02.Ana04ID, M02.Ana05ID, M02.Ana06ID, M02.Ana07ID, M02.Ana08ID, M02.Ana09ID, M02.Ana10ID,
	SUM(M02.ActualQuantity) AS ActualQuantity
INTO #TEMP2
FROM MT1801 M01 WITH (NOLOCK)
LEFT JOIN MT1802 M02 WITH (NOLOCK) ON M02.DivisionID = M01.DivisionID AND M02.VoucherID = M01.VoucherID
LEFT JOIN AT1302 A32 WITH (NOLOCK) ON A32.InventoryID = M02.ProductID AND A32.DivisionID IN (M02.DivisionID,''@@@'')
WHERE M01.DivisionID = '''+@DivisionID+''' AND M02.TypeTab = 2
	AND M01.ObjectID BETWEEN '''+@FromObjectID+''' AND '''+@ToObjectID+'''
	AND A32.I02ID BETWEEN '''+@FromI02ID+''' AND '''+@ToI02ID+'''
	AND M02.Ana03ID BETWEEN '''+@FromAna03ID+''' AND '''+@ToAna03ID+'''
	'+@sWhere1+'
GROUP BY M01.DivisionID, M01.ObjectID, M01.VoucherDate, A32.I02ID, M02.ProductID, M02.S01ID, M02.S02ID, M02.S03ID, M02.S04ID, M02.S05ID, M02.S06ID, M02.S07ID, M02.S08ID, M02.S09ID, M02.S10ID,
	M02.S11ID, M02.S12ID, M02.S13ID, M02.S14ID, M02.S15ID, M02.S16ID, M02.S17ID, M02.S18ID, M02.S19ID, M02.S20ID,
	M02.Ana01ID, M02.Ana02ID, M02.Ana03ID, M02.Ana04ID, M02.Ana05ID, M02.Ana06ID, M02.Ana07ID, M02.Ana08ID, M02.Ana09ID, M02.Ana10ID
'
SET @sSQL2 = '
---- Lấy khối lượng đã giao
SELECT A07.DivisionID, A06.ObjectID, A06.VoucherDate, A32.I02ID, A07.InventoryID, O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	A07.Ana01ID, A07.Ana02ID, A07.Ana03ID, A07.Ana04ID, A07.Ana05ID, A07.Ana06ID, A07.Ana07ID, A07.Ana08ID, A07.Ana09ID, A07.Ana10ID,
	SUM(A07.ActualQuantity) AS  DeliveryQuantity
INTO #TEMP3
FROM AT2007 A07 WITH (NOLOCK)
LEFT JOIN AT2006 A06 WITH (NOLOCK) ON A06.DivisionID = A07.DivisionID AND A06.VoucherID = A07.VoucherID
LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = A07.DivisionID AND O99.TransactionID = A07.TransactionID AND O99.VoucherID = A07.VoucherID
LEFT JOIN AT1302 A32 WITH (NOLOCK) ON A32.InventoryID = A07.InventoryID AND A32.DivisionID IN (A07.DivisionID,''@@@'')
WHERE A06.DivisionID = '''+@DivisionID+'''
	AND A06.ObjectID BETWEEN '''+@FromObjectID+''' AND '''+@ToObjectID+'''
	AND A07.Ana03ID BETWEEN '''+@FromAna03ID+''' AND '''+@ToAna03ID+'''
	AND A32.I02ID BETWEEN '''+@FromI02ID+''' AND '''+@ToI02ID+'''
	AND ISNULL(A06.IsDelivery,0) <> 0
	AND A06.KindVoucherID = 3
	'+@sWhere2+'
GROUP BY A07.DivisionID, A06.ObjectID, A06.VoucherDate, A32.I02ID, A07.InventoryID, O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID,
	A07.Ana01ID, A07.Ana02ID, A07.Ana03ID, A07.Ana04ID, A07.Ana05ID, A07.Ana06ID, A07.Ana07ID, A07.Ana08ID, A07.Ana09ID, A07.Ana10ID
'

SET @sSQL3 = '
SELECT T1.*, T2.VoucherDate AS SX_VoucherDate, T2.ActualQuantity, T3.VoucherDate AS Delivery_VoucherDate, T3.DeliveryQuantity,
	AT02.ObjectName, A03.AnaName AS Ana03Name, A05.AnaName AS Ana05Name, A06.AnaName AS Ana06Name, A15.AnaName as I02Name
FROM #TEMP1 T1 
LEFT JOIN #TEMP2 T2 ON T1.DivisionID  = T2.DivisionID AND T1.ObjectID  = T2.ObjectID AND T1.I02ID = T2.I02ID
						AND T1.InventoryID = T2.InventoryID AND ISNULL(T1.Ana03ID,'''')  = ISNULL(T2.Ana03ID,'''') AND ISNULL(T1.Ana05ID,'''')  = ISNULL(T2.Ana05ID,'''')
						AND ISNULL(T1.S01ID,'''') = ISNULL(T2.S01ID,'''')
						AND ISNULL(T1.S02ID,'''') = ISNULL(T2.S02ID,'''')
						AND ISNULL(T1.S03ID,'''') = ISNULL(T2.S03ID,'''')
						AND ISNULL(T1.S04ID,'''') = ISNULL(T2.S04ID,'''')
						AND ISNULL(T1.S05ID,'''') = ISNULL(T2.S05ID,'''')
						AND ISNULL(T1.S06ID,'''') = ISNULL(T2.S06ID,'''')
						AND ISNULL(T1.S07ID,'''') = ISNULL(T2.S07ID,'''')
						AND ISNULL(T1.S08ID,'''') = ISNULL(T2.S08ID,'''')
						AND ISNULL(T1.S09ID,'''') = ISNULL(T2.S09ID,'''')
						AND ISNULL(T1.S10ID,'''') = ISNULL(T2.S10ID,'''')
						AND ISNULL(T1.S11ID,'''') = ISNULL(T2.S11ID,'''')
						AND ISNULL(T1.S12ID,'''') = ISNULL(T2.S12ID,'''')
						AND ISNULL(T1.S13ID,'''') = ISNULL(T2.S13ID,'''')
						AND ISNULL(T1.S14ID,'''') = ISNULL(T2.S14ID,'''')
						AND ISNULL(T1.S15ID,'''') = ISNULL(T2.S15ID,'''')
						AND ISNULL(T1.S16ID,'''') = ISNULL(T2.S16ID,'''')
						AND ISNULL(T1.S17ID,'''') = ISNULL(T2.S17ID,'''')
						AND ISNULL(T1.S18ID,'''') = ISNULL(T2.S18ID,'''')
						AND ISNULL(T1.S19ID,'''') = ISNULL(T2.S19ID,'''')
						AND ISNULL(T1.S20ID,'''') = ISNULL(T2.S20ID,'''')
'
SET @sSQL4 = '
LEFT JOIN #TEMP3 T3 ON T1.DivisionID  = T3.DivisionID AND T1.ObjectID  = T3.ObjectID AND T1.I02ID = T3.I02ID
						AND T1.InventoryID = T3.InventoryID AND ISNULL(T1.Ana03ID,'''')  = ISNULL(T3.Ana03ID,'''') AND ISNULL(T1.Ana05ID,'''')  = ISNULL(T3.Ana05ID,'''')
						AND ISNULL(T1.S01ID,'''') = ISNULL(T3.S01ID,'''')
						AND ISNULL(T1.S02ID,'''') = ISNULL(T3.S02ID,'''')
						AND ISNULL(T1.S03ID,'''') = ISNULL(T3.S03ID,'''')
						AND ISNULL(T1.S04ID,'''') = ISNULL(T3.S04ID,'''')
						AND ISNULL(T1.S05ID,'''') = ISNULL(T3.S05ID,'''')
						AND ISNULL(T1.S06ID,'''') = ISNULL(T3.S06ID,'''')
						AND ISNULL(T1.S07ID,'''') = ISNULL(T3.S07ID,'''')
						AND ISNULL(T1.S08ID,'''') = ISNULL(T3.S08ID,'''')
						AND ISNULL(T1.S09ID,'''') = ISNULL(T3.S09ID,'''')
						AND ISNULL(T1.S10ID,'''') = ISNULL(T3.S10ID,'''')
						AND ISNULL(T1.S11ID,'''') = ISNULL(T3.S11ID,'''')
						AND ISNULL(T1.S12ID,'''') = ISNULL(T3.S12ID,'''')
						AND ISNULL(T1.S13ID,'''') = ISNULL(T3.S13ID,'''')
						AND ISNULL(T1.S14ID,'''') = ISNULL(T3.S14ID,'''')
						AND ISNULL(T1.S15ID,'''') = ISNULL(T3.S15ID,'''')
						AND ISNULL(T1.S16ID,'''') = ISNULL(T3.S16ID,'''')
						AND ISNULL(T1.S17ID,'''') = ISNULL(T3.S17ID,'''')
						AND ISNULL(T1.S18ID,'''') = ISNULL(T3.S18ID,'''')
						AND ISNULL(T1.S19ID,'''') = ISNULL(T3.S19ID,'''')
						AND ISNULL(T1.S20ID,'''') = ISNULL(T3.S20ID,'''')
LEFT JOIN AT1202 AT02 WITH (NOLOCK) ON AT02.DivisionID IN (''' +@DivisionID+ ''', ''@@@'') AND AT02.ObjectID  = T1.ObjectID
LEFT JOIN AT1011 A03 WITH (NOLOCK) ON A03.AnaID  = T1.Ana03ID AND A03.AnaTypeID  = ''A03''
LEFT JOIN AT1011 A05 WITH (NOLOCK) ON A05.AnaID  = T1.Ana05ID AND A05.AnaTypeID  = ''A05''
LEFT JOIN AT1011 A06 WITH (NOLOCK) ON A06.AnaID  = T1.Ana06ID AND A06.AnaTypeID  = ''A06''
LEFT JOIN AT1015 A15 WITH (NOLOCK) ON A15.AnaID  = T1.I02ID AND A15.AnaTypeID  = ''I02''
'
--PRINT @sSQL
--PRINT @sSQL1
--PRINT @sSQL2
--PRINT @sSQL3
--PRINT @sSQL4
EXEC (@sSQL + @sSQL1 + @sSQL2 + @sSQL3 + @sSQL4)

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
