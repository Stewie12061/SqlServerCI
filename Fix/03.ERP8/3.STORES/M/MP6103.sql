IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[MP6103]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[MP6103]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

----- Created BY  Tiểu Mai
----- Created Date 31/12/2015.
----- Purpose: Phan bo chi phi Nguyen vat lieu theo PP dinh muc (theo quy cach hang hoa)
---- Modified by Kim Thư on 13/12/2018 - Bổ sung lưu dữ liệu đã phân bổ vô table MT0400 => Không load MF0011 cải thiện tốc độ


CREATE PROCEDURE  [dbo].[MP6103]     @DivisionID AS nvarchar(50), 
					@UserID AS VARCHAR(50),
                    @PeriodID  AS nvarchar(50), 
                    @TranMonth AS INT, 
                    @TranYear AS INT, 
                    @MaterialTypeID  AS nvarchar(50), 
                    @ApportionID  AS nvarchar(50)

AS
DECLARE  @ConvertedDecimal INT
    
SET @ConvertedDecimal = (SELECT ConvertDecimal FROM MT0000 where DivisionID IN (SELECT DivisionID FROM dbo.GetDivisionID(@DivisionID)))
       
CREATE TABLE #TMP_MV5103(DivisionID NVARCHAR(50), ProductID NVARCHAR(50), MaterialID NVARCHAR(50), QuantityUnit DECIMAL(28,8),
						 ConvertedUnit DECIMAL(28,8), ProductQuantity DECIMAL(28,8), UnitID NVARCHAR(50),IsExtraMaterial INT,
						  MaterialGroupID NVARCHAR(50), ProductQuantityUnit DECIMAL(28,8), ProductConvertedUnit DECIMAL(28,8),
						PS01ID NVARCHAR(50), PS02ID NVARCHAR(50), PS03ID NVARCHAR(50), PS04ID NVARCHAR(50), PS05ID NVARCHAR(50),
						PS06ID NVARCHAR(50), PS07ID NVARCHAR(50), PS08ID NVARCHAR(50), PS09ID NVARCHAR(50), PS10ID NVARCHAR(50),
						PS11ID NVARCHAR(50), PS12ID NVARCHAR(50), PS13ID NVARCHAR(50), PS14ID NVARCHAR(50), PS15ID NVARCHAR(50),
						PS16ID NVARCHAR(50), PS17ID NVARCHAR(50), PS18ID NVARCHAR(50), PS19ID NVARCHAR(50), PS20ID NVARCHAR(50),
						S01ID NVARCHAR(50), S02ID NVARCHAR(50), S03ID NVARCHAR(50), S04ID NVARCHAR(50), S05ID NVARCHAR(50),
						S06ID NVARCHAR(50), S07ID NVARCHAR(50), S08ID NVARCHAR(50), S09ID NVARCHAR(50), S10ID NVARCHAR(50),
						S11ID NVARCHAR(50), S12ID NVARCHAR(50), S13ID NVARCHAR(50), S14ID NVARCHAR(50), S15ID NVARCHAR(50),
						S16ID NVARCHAR(50), S17ID NVARCHAR(50), S18ID NVARCHAR(50), S19ID NVARCHAR(50), S20ID NVARCHAR(50))

CREATE TABLE #TMP_MV6103(DivisionID NVARCHAR(50),MaterialID NVARCHAR(100) , ProductID NVARCHAR(50), MaterialQuantity DECIMAL(28,8), ConvertedAmount DECIMAL(28,8),
				PS01ID NVARCHAR(50), PS02ID NVARCHAR(50), PS03ID NVARCHAR(50), PS04ID NVARCHAR(50), PS05ID NVARCHAR(50),
				PS06ID NVARCHAR(50), PS07ID NVARCHAR(50), PS08ID NVARCHAR(50), PS09ID NVARCHAR(50), PS10ID NVARCHAR(50),
				PS11ID NVARCHAR(50), PS12ID NVARCHAR(50), PS13ID NVARCHAR(50), PS14ID NVARCHAR(50), PS15ID NVARCHAR(50),
				PS16ID NVARCHAR(50), PS17ID NVARCHAR(50), PS18ID NVARCHAR(50), PS19ID NVARCHAR(50), PS20ID NVARCHAR(50),
				S01ID NVARCHAR(50), S02ID NVARCHAR(50), S03ID NVARCHAR(50), S04ID NVARCHAR(50), S05ID NVARCHAR(50),
				S06ID NVARCHAR(50), S07ID NVARCHAR(50), S08ID NVARCHAR(50), S09ID NVARCHAR(50), S10ID NVARCHAR(50),
				S11ID NVARCHAR(50), S12ID NVARCHAR(50), S13ID NVARCHAR(50), S14ID NVARCHAR(50), S15ID NVARCHAR(50),
				S16ID NVARCHAR(50), S17ID NVARCHAR(50), S18ID NVARCHAR(50), S19ID NVARCHAR(50), S20ID NVARCHAR(50))	
				
		INSERT INTO #TMP_MV5103(DivisionID, ProductID,MaterialID,QuantityUnit,ConvertedUnit,ProductQuantity,UnitID,IsExtraMaterial,MaterialGroupID,ProductQuantityUnit,ProductConvertedUnit,
								PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID, PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID,
								S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID, S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID )
			Select MT0136.DivisionID, MT0136.ProductID, MaterialID, QuantityUnit, ConvertedUnit, MT2222.ProductQuantity, 
			MT2222.UnitID, IsExtraMaterial, MaterialGroupID, 
			QuantityUnit*MT2222.ProductQuantity AS ProductQuantityUnit, 
			ConvertedUnit*MT2222.ProductQuantity AS ProductConvertedUnit,
			MT0136.S01ID, MT0136.S02ID, MT0136.S03ID, MT0136.S04ID, MT0136.S05ID, MT0136.S06ID, MT0136.S07ID, MT0136.S08ID, MT0136.S09ID, MT0136.S10ID,
			MT0136.S11ID, MT0136.S12ID, MT0136.S13ID, MT0136.S14ID, MT0136.S15ID, MT0136.S16ID, MT0136.S17ID, MT0136.S18ID, MT0136.S19ID, MT0136.S20ID,
			MT0137.DS01ID, MT0137.DS02ID, MT0137.DS03ID, MT0137.DS04ID, MT0137.DS05ID, MT0137.DS06ID, MT0137.DS07ID, MT0137.DS08ID, MT0137.DS09ID, MT0137.DS10ID,
			MT0137.DS11ID, MT0137.DS12ID, MT0137.DS13ID, MT0137.DS14ID, MT0137.DS15ID, MT0137.DS16ID, MT0137.DS17ID, MT0137.DS18ID, MT0137.DS19ID, MT0137.DS20ID
		FROM MT0136 
		INNER JOIN MT2222 ON MT2222.DivisionID = MT0136.DivisionID AND MT2222.ProductID = MT0136.ProductID AND 
						ISNULL(MT0136.S01ID,'') = ISNULL(MT2222.PS01ID,'') AND
						ISNULL(MT0136.S02ID,'') = ISNULL(MT2222.PS02ID,'') AND
						ISNULL(MT0136.S03ID,'') = ISNULL(MT2222.PS03ID,'') AND
						ISNULL(MT0136.S04ID,'') = ISNULL(MT2222.PS04ID,'') AND
						ISNULL(MT0136.S05ID,'') = ISNULL(MT2222.PS05ID,'') AND
						ISNULL(MT0136.S06ID,'') = ISNULL(MT2222.PS06ID,'') AND
						ISNULL(MT0136.S07ID,'') = ISNULL(MT2222.PS07ID,'') AND
						ISNULL(MT0136.S08ID,'') = ISNULL(MT2222.PS08ID,'') AND
						ISNULL(MT0136.S09ID,'') = ISNULL(MT2222.PS09ID,'') AND
						ISNULL(MT0136.S10ID,'') = ISNULL(MT2222.PS10ID,'') AND
						ISNULL(MT0136.S11ID,'') = ISNULL(MT2222.PS11ID,'') AND
						ISNULL(MT0136.S12ID,'') = ISNULL(MT2222.PS12ID,'') AND
						ISNULL(MT0136.S13ID,'') = ISNULL(MT2222.PS13ID,'') AND
						ISNULL(MT0136.S14ID,'') = ISNULL(MT2222.PS14ID,'') AND
						ISNULL(MT0136.S15ID,'') = ISNULL(MT2222.PS15ID,'') AND
						ISNULL(MT0136.S16ID,'') = ISNULL(MT2222.PS16ID,'') AND
						ISNULL(MT0136.S17ID,'') = ISNULL(MT2222.PS17ID,'') AND
						ISNULL(MT0136.S18ID,'') = ISNULL(MT2222.PS18ID,'') AND
						ISNULL(MT0136.S19ID,'') = ISNULL(MT2222.PS19ID,'') AND
						ISNULL(MT0136.S20ID,'') = ISNULL(MT2222.PS20ID,'')
		INNER JOIN MT0137 ON MT0137.DivisionID = MT0136.DivisionID AND MT0137.ProductID = MT0136.ProductID AND MT0137.ReTransactionID = MT0136.TransactionID
		WHERE     MT0136.ApportionID = @ApportionID
			AND MT0136.DivisionID = @DivisionID
			AND ExpenseID ='COST001'
			AND MT2222.PeriodID = @PeriodID

		UNION	--- Bổ sung NVL thay thế
		Select DivisionID, ProductID, MaterialID, QuantityUnit, ConvertedUnit, ProductQuantity, 
			UnitID, 1 as IsExtraMaterial, MaterialGroupID, 
			QuantityUnit*ProductQuantity AS ProductQuantityUnit, 
			ConvertedUnit*ProductQuantity AS ProductConvertedUnit,
			S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
			S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID,
			DS01ID, DS02ID, DS03ID, DS04ID, DS05ID, DS06ID, DS07ID, DS08ID, DS09ID, DS10ID,
			DS11ID, DS12ID, DS13ID, DS14ID, DS15ID, DS16ID, DS17ID, DS18ID, DS19ID, DS20ID
		FROM
		(Select MT0136.DivisionID, MT0136.ProductID, MT0007.MaterialID, MT0007.CoValues as QuantityUnit,
		MT0137.ConvertedUnit as ConvertedUnit, MT2222.ProductQuantity, MT2222.UnitID, MT0137.MaterialGroupID,
		MT0136.S01ID, MT0136.S02ID, MT0136.S03ID, MT0136.S04ID, MT0136.S05ID, MT0136.S06ID, MT0136.S07ID, MT0136.S08ID, MT0136.S09ID, MT0136.S10ID,
		MT0136.S11ID, MT0136.S12ID, MT0136.S13ID, MT0136.S14ID, MT0136.S15ID, MT0136.S16ID, MT0136.S17ID, MT0136.S18ID, MT0136.S19ID, MT0136.S20ID,
		MT0137.DS01ID, MT0137.DS02ID, MT0137.DS03ID, MT0137.DS04ID, MT0137.DS05ID, MT0137.DS06ID, MT0137.DS07ID, MT0137.DS08ID, MT0137.DS09ID, MT0137.DS10ID,
		MT0137.DS11ID, MT0137.DS12ID, MT0137.DS13ID, MT0137.DS14ID, MT0137.DS15ID, MT0137.DS16ID, MT0137.DS17ID, MT0137.DS18ID, MT0137.DS19ID, MT0137.DS20ID
		FROM MT0136 
		INNER JOIN MT2222 ON MT2222.DivisionID = MT0136.DivisionID AND MT2222.ProductID = MT0136.ProductID AND
							ISNULL(MT0136.S01ID,'') = ISNULL(MT2222.PS01ID,'') AND
							ISNULL(MT0136.S02ID,'') = ISNULL(MT2222.PS02ID,'') AND
							ISNULL(MT0136.S03ID,'') = ISNULL(MT2222.PS03ID,'') AND
							ISNULL(MT0136.S04ID,'') = ISNULL(MT2222.PS04ID,'') AND
							ISNULL(MT0136.S05ID,'') = ISNULL(MT2222.PS05ID,'') AND
							ISNULL(MT0136.S06ID,'') = ISNULL(MT2222.PS06ID,'') AND
							ISNULL(MT0136.S07ID,'') = ISNULL(MT2222.PS07ID,'') AND
							ISNULL(MT0136.S08ID,'') = ISNULL(MT2222.PS08ID,'') AND
							ISNULL(MT0136.S09ID,'') = ISNULL(MT2222.PS09ID,'') AND
							ISNULL(MT0136.S10ID,'') = ISNULL(MT2222.PS10ID,'') AND
							ISNULL(MT0136.S11ID,'') = ISNULL(MT2222.PS11ID,'') AND
							ISNULL(MT0136.S12ID,'') = ISNULL(MT2222.PS12ID,'') AND
							ISNULL(MT0136.S13ID,'') = ISNULL(MT2222.PS13ID,'') AND
							ISNULL(MT0136.S14ID,'') = ISNULL(MT2222.PS14ID,'') AND
							ISNULL(MT0136.S15ID,'') = ISNULL(MT2222.PS15ID,'') AND
							ISNULL(MT0136.S16ID,'') = ISNULL(MT2222.PS16ID,'') AND
							ISNULL(MT0136.S17ID,'') = ISNULL(MT2222.PS17ID,'') AND
							ISNULL(MT0136.S18ID,'') = ISNULL(MT2222.PS18ID,'') AND
							ISNULL(MT0136.S19ID,'') = ISNULL(MT2222.PS19ID,'') AND
							ISNULL(MT0136.S20ID,'') = ISNULL(MT2222.PS20ID,'')
		INNER JOIN MT0137 ON MT0137.DivisionID = MT0136.DivisionID AND MT0137.ProductID = MT0136.ProductID AND MT0137.ReTransactionID = MT0136.TransactionID
		INNER JOIN MT0007 On MT0137.DivisionID = MT0007.DivisionID AND MT0137.IsExtraMaterial = 1 And MT0137.MaterialGroupID = MT0007.MaterialGroupID
		WHERE     MT0136.ApportionID = @ApportionID
			AND MT0136.DivisionID = @DivisionID
			AND ExpenseID ='COST001'
			AND MT2222.PeriodID = @PeriodID
		) MT0137

		INSERT INTO #TMP_MV6103 (DivisionID, MaterialID, ProductID, MaterialQuantity, ConvertedAmount, PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
			PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID, S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
								S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID)
		SELECT DivisionID, InventoryID AS MaterialID, ProductID,
			SUM( Case D_C  when  'D' then ISNULL(Quantity, 0) ELSE - ISNULL(Quantity, 0) END) AS MaterialQuantity, 
			SUM( Case D_C  when  'D' then   ISNULL(ConvertedAmount, 0) ELSE - ISNULL(ConvertedAmount, 0) END) AS ConvertedAmount,
			PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
			PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID,
			S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
			S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID    
		FROM MV9000
		WHERE     PeriodID = @PeriodID
			AND ExpenseID ='COST001' 
			AND MaterialTypeID =@MaterialTypeID
			AND DivisionID = @DivisionID
		GROUP BY DivisionID, InventoryID, ProductID,
			PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
			PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID,
			S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
			S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID  
	
--- INSERT DU LIEU

	INSERT MT0621 (DivisionID, MaterialID, ProductID, UnitID, ExpenseID, Quantity, QuantityUnit,
				   MaterialTypeID, ConvertedAmount, ConvertedUnit, ProductQuantity, Rate,
				   PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
				   PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID,
				   S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
				   S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID)    
	
	SELECT	DivisionID, MaterialID, ProductID, UnitID, ExpenseID, 
			MaterialQuantityUnit AS Quantity,
			CASE WHEN ISNULL(ProductQuantity, 0) <> 0  THEN MaterialQuantityUnit/ProductQuantity ELSE 0 END [QuantityUnit],
			@MaterialTypeID,
			MaterialConvertedUnit AS ConvertedAmount,
			CASE WHEN ISNULL(ProductQuantity, 0) <> 0 THEN MaterialConvertedUnit/ProductQuantity ELSE 0 END [ConvertedUnit],  
			ProductQuantity
			, NULL,
			PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
			PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID,
			S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
			S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID
	FROM (		
		
		SELECT  MV5103.DivisionID, MV5103.MaterialID, MV5103.ProductID,MV5103.UnitID,'COST001' [ExpenseID],
						CASE WHEN ISNULL(SumProductQuantity, 0) <> 0 THEN (ISNULL(MV6103.MaterialQuantity, 0)*ISNULL(MV5103.ProductQuantityUnit, 0)/ SumProductQuantity) ELSE 0 END [MaterialQuantityUnit], 
						CASE WHEN ISNULL(SumProductQuantity, 0) <> 0 THEN round(ISNULL(MV6103.ConvertedAmount, 0)*ISNULL(MV5103.ProductQuantityUnit, 0)/ SumProductQuantity, @ConvertedDecimal) ELSE 0 END [MaterialConvertedUnit], 
			
						MV6103.ConvertedAmount, 
						MV6103.MaterialQuantity, MV5103.ProductQuantity,     
						MV5103.ProductQuantityUnit, MV5103.ProductConvertedUnit, 
						M03.SumProductQuantity ,
						M03.SumProductConverted,
						MV5103.PS01ID, MV5103.PS02ID, MV5103.PS03ID, MV5103.PS04ID, MV5103.PS05ID, MV5103.PS06ID, MV5103.PS07ID, MV5103.PS08ID, MV5103.PS09ID, MV5103.PS10ID,
						MV5103.PS11ID, MV5103.PS12ID, MV5103.PS13ID, MV5103.PS14ID, MV5103.PS15ID, MV5103.PS16ID, MV5103.PS17ID, MV5103.PS18ID, MV5103.PS19ID, MV5103.PS20ID,
						MV5103.S01ID, MV5103.S02ID, MV5103.S03ID, MV5103.S04ID, MV5103.S05ID, MV5103.S06ID, MV5103.S07ID, MV5103.S08ID, MV5103.S09ID, MV5103.S10ID,
						MV5103.S11ID, MV5103.S12ID, MV5103.S13ID, MV5103.S14ID, MV5103.S15ID, MV5103.S16ID, MV5103.S17ID, MV5103.S18ID, MV5103.S19ID, MV5103.S20ID 
				FROM #TMP_MV5103 MV5103				
				INNER JOIN  #TMP_MV6103 MV6103
					ON MV5103.DivisionID = MV6103.DivisionID 
						AND MV5103.MaterialID = MV6103.MaterialID AND MV5103.ProductID = MV6103.ProductID AND 
						ISNULL(MV5103.PS01ID,'') = ISNULL(MV6103.PS01ID,'') AND
						ISNULL(MV5103.PS02ID,'') = ISNULL(MV6103.PS02ID,'') AND
						ISNULL(MV5103.PS03ID,'') = ISNULL(MV6103.PS03ID,'') AND
						ISNULL(MV5103.PS04ID,'') = ISNULL(MV6103.PS04ID,'') AND
						ISNULL(MV5103.PS05ID,'') = ISNULL(MV6103.PS05ID,'') AND
						ISNULL(MV5103.PS06ID,'') = ISNULL(MV6103.PS06ID,'') AND
						ISNULL(MV5103.PS07ID,'') = ISNULL(MV6103.PS07ID,'') AND
						ISNULL(MV5103.PS08ID,'') = ISNULL(MV6103.PS08ID,'') AND
						ISNULL(MV5103.PS09ID,'') = ISNULL(MV6103.PS09ID,'') AND
						ISNULL(MV5103.PS10ID,'') = ISNULL(MV6103.PS10ID,'') AND
						ISNULL(MV5103.PS11ID,'') = ISNULL(MV6103.PS11ID,'') AND
						ISNULL(MV5103.PS12ID,'') = ISNULL(MV6103.PS12ID,'') AND
						ISNULL(MV5103.PS13ID,'') = ISNULL(MV6103.PS13ID,'') AND
						ISNULL(MV5103.PS14ID,'') = ISNULL(MV6103.PS14ID,'') AND
						ISNULL(MV5103.PS15ID,'') = ISNULL(MV6103.PS15ID,'') AND
						ISNULL(MV5103.PS16ID,'') = ISNULL(MV6103.PS16ID,'') AND
						ISNULL(MV5103.PS17ID,'') = ISNULL(MV6103.PS17ID,'') AND
						ISNULL(MV5103.PS18ID,'') = ISNULL(MV6103.PS18ID,'') AND
						ISNULL(MV5103.PS19ID,'') = ISNULL(MV6103.PS19ID,'') AND
						ISNULL(MV5103.PS20ID,'') = ISNULL(MV6103.PS20ID,'') AND
						
						ISNULL(MV5103.S01ID,'') = ISNULL(MV6103.S01ID,'') AND
						ISNULL(MV5103.S02ID,'') = ISNULL(MV6103.S02ID,'') AND
						ISNULL(MV5103.S03ID,'') = ISNULL(MV6103.S03ID,'') AND
						ISNULL(MV5103.S04ID,'') = ISNULL(MV6103.S04ID,'') AND
						ISNULL(MV5103.S05ID,'') = ISNULL(MV6103.S05ID,'') AND
						ISNULL(MV5103.S06ID,'') = ISNULL(MV6103.S06ID,'') AND
						ISNULL(MV5103.S07ID,'') = ISNULL(MV6103.S07ID,'') AND
						ISNULL(MV5103.S08ID,'') = ISNULL(MV6103.S08ID,'') AND
						ISNULL(MV5103.S09ID,'') = ISNULL(MV6103.S09ID,'') AND
						ISNULL(MV5103.S10ID,'') = ISNULL(MV6103.S10ID,'') AND
						ISNULL(MV5103.S11ID,'') = ISNULL(MV6103.S11ID,'') AND
						ISNULL(MV5103.S12ID,'') = ISNULL(MV6103.S12ID,'') AND
						ISNULL(MV5103.S13ID,'') = ISNULL(MV6103.S13ID,'') AND
						ISNULL(MV5103.S14ID,'') = ISNULL(MV6103.S14ID,'') AND
						ISNULL(MV5103.S15ID,'') = ISNULL(MV6103.S15ID,'') AND
						ISNULL(MV5103.S16ID,'') = ISNULL(MV6103.S16ID,'') AND
						ISNULL(MV5103.S17ID,'') = ISNULL(MV6103.S17ID,'') AND
						ISNULL(MV5103.S18ID,'') = ISNULL(MV6103.S18ID,'') AND
						ISNULL(MV5103.S19ID,'') = ISNULL(MV6103.S19ID,'') AND
						ISNULL(MV5103.S20ID,'') = ISNULL(MV6103.S20ID,'')
				LEFT JOIN	(	
					
					Select MaterialID,SUM (ISNULL(ProductQuantityUnit, 0)) SumProductQuantity,
									   SUM (ISNULL(ProductConvertedUnit, 0)) SumProductConverted, M03.ProductID,
									   M03.S01ID, M03.S02ID, M03.S03ID, M03.S04ID, M03.S05ID, M03.S06ID, M03.S07ID, M03.S08ID, M03.S09ID, M03.S10ID,
									   M03.S11ID, M03.S12ID, M03.S13ID, M03.S14ID, M03.S15ID, M03.S16ID, M03.S17ID, M03.S18ID, M03.S19ID, M03.S20ID,
									   M03.PS01ID, M03.PS02ID, M03.PS03ID, M03.PS04ID, M03.PS05ID, M03.PS06ID, M03.PS07ID, M03.PS08ID, M03.PS09ID, M03.PS10ID,
									   M03.PS11ID, M03.PS12ID, M03.PS13ID, M03.PS14ID, M03.PS15ID, M03.PS16ID, M03.PS17ID, M03.PS18ID, M03.PS19ID, M03.PS20ID
								FROM #TMP_MV5103 M03
								GROUP BY M03.MaterialID, M03.ProductID,
									   M03.S01ID, M03.S02ID, M03.S03ID, M03.S04ID, M03.S05ID, M03.S06ID, M03.S07ID, M03.S08ID, M03.S09ID, M03.S10ID,
									   M03.S11ID, M03.S12ID, M03.S13ID, M03.S14ID, M03.S15ID, M03.S16ID, M03.S17ID, M03.S18ID, M03.S19ID, M03.S20ID,
									   M03.PS01ID, M03.PS02ID, M03.PS03ID, M03.PS04ID, M03.PS05ID, M03.PS06ID, M03.PS07ID, M03.PS08ID, M03.PS09ID, M03.PS10ID,
									   M03.PS11ID, M03.PS12ID, M03.PS13ID, M03.PS14ID, M03.PS15ID, M03.PS16ID, M03.PS17ID, M03.PS18ID, M03.PS19ID, M03.PS20ID
							
				
				) M03 ON	M03.MaterialID = MV6103.MaterialID AND M03.ProductID = MV6103.ProductID AND 
										ISNULL(M03.PS01ID,'') = ISNULL(MV6103.PS01ID,'') AND
										ISNULL(M03.PS02ID,'') = ISNULL(MV6103.PS02ID,'') AND
										ISNULL(M03.PS03ID,'') = ISNULL(MV6103.PS03ID,'') AND
										ISNULL(M03.PS04ID,'') = ISNULL(MV6103.PS04ID,'') AND
										ISNULL(M03.PS05ID,'') = ISNULL(MV6103.PS05ID,'') AND
										ISNULL(M03.PS06ID,'') = ISNULL(MV6103.PS06ID,'') AND
										ISNULL(M03.PS07ID,'') = ISNULL(MV6103.PS07ID,'') AND
										ISNULL(M03.PS08ID,'') = ISNULL(MV6103.PS08ID,'') AND
										ISNULL(M03.PS09ID,'') = ISNULL(MV6103.PS09ID,'') AND
										ISNULL(M03.PS10ID,'') = ISNULL(MV6103.PS10ID,'') AND
										ISNULL(M03.PS11ID,'') = ISNULL(MV6103.PS11ID,'') AND
										ISNULL(M03.PS12ID,'') = ISNULL(MV6103.PS12ID,'') AND
										ISNULL(M03.PS13ID,'') = ISNULL(MV6103.PS13ID,'') AND
										ISNULL(M03.PS14ID,'') = ISNULL(MV6103.PS14ID,'') AND
										ISNULL(M03.PS15ID,'') = ISNULL(MV6103.PS15ID,'') AND
										ISNULL(M03.PS16ID,'') = ISNULL(MV6103.PS16ID,'') AND
										ISNULL(M03.PS17ID,'') = ISNULL(MV6103.PS17ID,'') AND
										ISNULL(M03.PS18ID,'') = ISNULL(MV6103.PS18ID,'') AND
										ISNULL(M03.PS19ID,'') = ISNULL(MV6103.PS19ID,'') AND
										ISNULL(M03.PS20ID,'') = ISNULL(MV6103.PS20ID,'') AND
										
										ISNULL(M03.S01ID,'') = ISNULL(MV6103.S01ID,'') AND
										ISNULL(M03.S02ID,'') = ISNULL(MV6103.S02ID,'') AND
										ISNULL(M03.S03ID,'') = ISNULL(MV6103.S03ID,'') AND
										ISNULL(M03.S04ID,'') = ISNULL(MV6103.S04ID,'') AND
										ISNULL(M03.S05ID,'') = ISNULL(MV6103.S05ID,'') AND
										ISNULL(M03.S06ID,'') = ISNULL(MV6103.S06ID,'') AND
										ISNULL(M03.S07ID,'') = ISNULL(MV6103.S07ID,'') AND
										ISNULL(M03.S08ID,'') = ISNULL(MV6103.S08ID,'') AND
										ISNULL(M03.S09ID,'') = ISNULL(MV6103.S09ID,'') AND
										ISNULL(M03.S10ID,'') = ISNULL(MV6103.S10ID,'') AND
										ISNULL(M03.S11ID,'') = ISNULL(MV6103.S11ID,'') AND
										ISNULL(M03.S12ID,'') = ISNULL(MV6103.S12ID,'') AND
										ISNULL(M03.S13ID,'') = ISNULL(MV6103.S13ID,'') AND
										ISNULL(M03.S14ID,'') = ISNULL(MV6103.S14ID,'') AND
										ISNULL(M03.S15ID,'') = ISNULL(MV6103.S15ID,'') AND
										ISNULL(M03.S16ID,'') = ISNULL(MV6103.S16ID,'') AND
										ISNULL(M03.S17ID,'') = ISNULL(MV6103.S17ID,'') AND
										ISNULL(M03.S18ID,'') = ISNULL(MV6103.S18ID,'') AND
										ISNULL(M03.S19ID,'') = ISNULL(MV6103.S19ID,'') AND
										ISNULL(M03.S20ID,'') = ISNULL(MV6103.S20ID,'')
    ) DATA
    
    --SELECT * FROM MT0621 m

--- Làm Tròn Dữ liệu
IF EXISTS (SELECT TOP 1 1 FROM AT0000 WHERE DefDivisionID = @DivisionID AND IsSpecificate = 1)
	UPDATE MT06
	SET MT06.ConvertedAmount = MT06.ConvertedAmount + AA.NewValue
	FROM MT0621 MT06
	INNER JOIN 
		(	
			SELECT MT06.ID,ROW_NUMBER() OVER( PARTITION BY MT06.MaterialID ORDER BY MT06.ConvertedAmount Desc)  [ROW]
		   ,ROUND(ISNULL(MV61.ConvertedAmount,0),@ConvertedDecimal) - MT061.ConvertedAmount [NewValue],
			MT06.S01ID, MT06.S02ID, MT06.S03ID, MT06.S04ID, MT06.S05ID, MT06.S06ID, MT06.S07ID, MT06.S08ID, MT06.S09ID, MT06.S10ID,
			MT06.S11ID, MT06.S12ID, MT06.S13ID, MT06.S14ID, MT06.S15ID, MT06.S16ID, MT06.S17ID, MT06.S18ID, MT06.S19ID, MT06.S20ID
			FROM MT0621 MT06	
			INNER JOIN				
			( 		Select MaterialTypeID,ExpenseID,DivisionID, ISNULL(MaterialID,'')  [MaterialID],
							SUM(Quantity) AS Quantity,
							SUM(ConvertedAmount) AS ConvertedAmount,
							S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
							S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID,
							ProductID,
							PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
							PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID
							
					FROM MT0621 
					WHERE MaterialTypeID = @MaterialTypeID
						AND ExpenseID ='COST001'
						AND DivisionID =  @DivisionID
					GROUP BY	MaterialTypeID,ExpenseID,DivisionID,ISNULL(MaterialID,''),
								S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
								S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID,
								ProductID,
								PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
								PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID			
			) MT061 
				ON	MT06.MaterialTypeID = MT061.MaterialTypeID AND 
					MT06.ExpenseID = MT061.ExpenseID AND MT06.DivisionID = MT061.DivisionID AND 
					MT06.MaterialID = MT061.MaterialID AND MT061.ProductID = MT06.ProductID AND
					ISNULL(MT061.S01ID,'') = ISNULL(MT06.S01ID,'') AND
					ISNULL(MT061.S02ID,'') = ISNULL(MT06.S02ID,'') AND
					ISNULL(MT061.S03ID,'') = ISNULL(MT06.S03ID,'') AND
					ISNULL(MT061.S04ID,'') = ISNULL(MT06.S04ID,'') AND
					ISNULL(MT061.S05ID,'') = ISNULL(MT06.S05ID,'') AND
					ISNULL(MT061.S06ID,'') = ISNULL(MT06.S06ID,'') AND
					ISNULL(MT061.S07ID,'') = ISNULL(MT06.S07ID,'') AND
					ISNULL(MT061.S08ID,'') = ISNULL(MT06.S08ID,'') AND
					ISNULL(MT061.S09ID,'') = ISNULL(MT06.S09ID,'') AND
					ISNULL(MT061.S10ID,'') = ISNULL(MT06.S10ID,'') AND
					ISNULL(MT061.S11ID,'') = ISNULL(MT06.S11ID,'') AND
					ISNULL(MT061.S12ID,'') = ISNULL(MT06.S12ID,'') AND
					ISNULL(MT061.S13ID,'') = ISNULL(MT06.S13ID,'') AND
					ISNULL(MT061.S14ID,'') = ISNULL(MT06.S14ID,'') AND
					ISNULL(MT061.S15ID,'') = ISNULL(MT06.S15ID,'') AND
					ISNULL(MT061.S16ID,'') = ISNULL(MT06.S16ID,'') AND
					ISNULL(MT061.S17ID,'') = ISNULL(MT06.S17ID,'') AND
					ISNULL(MT061.S18ID,'') = ISNULL(MT06.S18ID,'') AND
					ISNULL(MT061.S19ID,'') = ISNULL(MT06.S19ID,'') AND
					ISNULL(MT061.S20ID,'') = ISNULL(MT06.S20ID,'') AND 
					
					ISNULL(MT061.PS01ID,'') = ISNULL(MT06.PS01ID,'') AND
					ISNULL(MT061.PS02ID,'') = ISNULL(MT06.PS02ID,'') AND
					ISNULL(MT061.PS03ID,'') = ISNULL(MT06.PS03ID,'') AND
					ISNULL(MT061.PS04ID,'') = ISNULL(MT06.PS04ID,'') AND
					ISNULL(MT061.PS05ID,'') = ISNULL(MT06.PS05ID,'') AND
					ISNULL(MT061.PS06ID,'') = ISNULL(MT06.PS06ID,'') AND
					ISNULL(MT061.PS07ID,'') = ISNULL(MT06.PS07ID,'') AND
					ISNULL(MT061.PS08ID,'') = ISNULL(MT06.PS08ID,'') AND
					ISNULL(MT061.PS09ID,'') = ISNULL(MT06.PS09ID,'') AND
					ISNULL(MT061.PS10ID,'') = ISNULL(MT06.PS10ID,'') AND
					ISNULL(MT061.PS11ID,'') = ISNULL(MT06.PS11ID,'') AND
					ISNULL(MT061.PS12ID,'') = ISNULL(MT06.PS12ID,'') AND
					ISNULL(MT061.PS13ID,'') = ISNULL(MT06.PS13ID,'') AND
					ISNULL(MT061.PS14ID,'') = ISNULL(MT06.PS14ID,'') AND
					ISNULL(MT061.PS15ID,'') = ISNULL(MT06.PS15ID,'') AND
					ISNULL(MT061.PS16ID,'') = ISNULL(MT06.PS16ID,'') AND
					ISNULL(MT061.PS17ID,'') = ISNULL(MT06.PS17ID,'') AND
					ISNULL(MT061.PS18ID,'') = ISNULL(MT06.PS18ID,'') AND
					ISNULL(MT061.PS19ID,'') = ISNULL(MT06.PS19ID,'') AND
					ISNULL(MT061.PS20ID,'') = ISNULL(MT06.PS20ID,'')
			LEFT JOIN #TMP_MV6103 MV61 
				ON	ISNULL(MV61.MaterialID,0) = MT06.MaterialID AND MV61.ProductID = MT06.ProductID AND 
					ISNULL(MV61.S01ID,'') = ISNULL(MT06.S01ID,'') AND
					ISNULL(MV61.S02ID,'') = ISNULL(MT06.S02ID,'') AND
					ISNULL(MV61.S03ID,'') = ISNULL(MT06.S03ID,'') AND
					ISNULL(MV61.S04ID,'') = ISNULL(MT06.S04ID,'') AND
					ISNULL(MV61.S05ID,'') = ISNULL(MT06.S05ID,'') AND
					ISNULL(MV61.S06ID,'') = ISNULL(MT06.S06ID,'') AND
					ISNULL(MV61.S07ID,'') = ISNULL(MT06.S07ID,'') AND
					ISNULL(MV61.S08ID,'') = ISNULL(MT06.S08ID,'') AND
					ISNULL(MV61.S09ID,'') = ISNULL(MT06.S09ID,'') AND
					ISNULL(MV61.S10ID,'') = ISNULL(MT06.S10ID,'') AND
					ISNULL(MV61.S11ID,'') = ISNULL(MT06.S11ID,'') AND
					ISNULL(MV61.S12ID,'') = ISNULL(MT06.S12ID,'') AND
					ISNULL(MV61.S13ID,'') = ISNULL(MT06.S13ID,'') AND
					ISNULL(MV61.S14ID,'') = ISNULL(MT06.S14ID,'') AND
					ISNULL(MV61.S15ID,'') = ISNULL(MT06.S15ID,'') AND
					ISNULL(MV61.S16ID,'') = ISNULL(MT06.S16ID,'') AND
					ISNULL(MV61.S17ID,'') = ISNULL(MT06.S17ID,'') AND
					ISNULL(MV61.S18ID,'') = ISNULL(MT06.S18ID,'') AND
					ISNULL(MV61.S19ID,'') = ISNULL(MT06.S19ID,'') AND
					ISNULL(MV61.S20ID,'') = ISNULL(MT06.S20ID,'') AND
					
					ISNULL(MV61.PS01ID,'') = ISNULL(MT06.PS01ID,'') AND
					ISNULL(MV61.PS02ID,'') = ISNULL(MT06.PS02ID,'') AND
					ISNULL(MV61.PS03ID,'') = ISNULL(MT06.PS03ID,'') AND
					ISNULL(MV61.PS04ID,'') = ISNULL(MT06.PS04ID,'') AND
					ISNULL(MV61.PS05ID,'') = ISNULL(MT06.PS05ID,'') AND
					ISNULL(MV61.PS06ID,'') = ISNULL(MT06.PS06ID,'') AND
					ISNULL(MV61.PS07ID,'') = ISNULL(MT06.PS07ID,'') AND
					ISNULL(MV61.PS08ID,'') = ISNULL(MT06.PS08ID,'') AND
					ISNULL(MV61.PS09ID,'') = ISNULL(MT06.PS09ID,'') AND
					ISNULL(MV61.PS10ID,'') = ISNULL(MT06.PS10ID,'') AND
					ISNULL(MV61.PS11ID,'') = ISNULL(MT06.PS11ID,'') AND
					ISNULL(MV61.PS12ID,'') = ISNULL(MT06.PS12ID,'') AND
					ISNULL(MV61.PS13ID,'') = ISNULL(MT06.PS13ID,'') AND
					ISNULL(MV61.PS14ID,'') = ISNULL(MT06.PS14ID,'') AND
					ISNULL(MV61.PS15ID,'') = ISNULL(MT06.PS15ID,'') AND
					ISNULL(MV61.PS16ID,'') = ISNULL(MT06.PS16ID,'') AND
					ISNULL(MV61.PS17ID,'') = ISNULL(MT06.PS17ID,'') AND
					ISNULL(MV61.PS18ID,'') = ISNULL(MT06.PS18ID,'') AND
					ISNULL(MV61.PS19ID,'') = ISNULL(MT06.PS19ID,'') AND
					ISNULL(MV61.PS20ID,'') = ISNULL(MT06.PS20ID,'')		
			GROUP BY MT06.ID,MT06.MaterialID,MV61.ConvertedAmount,MT061.ConvertedAmount,MT06.ConvertedAmount,
					MT06.S01ID, MT06.S02ID, MT06.S03ID, MT06.S04ID, MT06.S05ID, MT06.S06ID, MT06.S07ID, MT06.S08ID, MT06.S09ID, MT06.S10ID,
					MT06.S11ID, MT06.S12ID, MT06.S13ID, MT06.S14ID, MT06.S15ID, MT06.S16ID, MT06.S17ID, MT06.S18ID, MT06.S19ID, MT06.S20ID
			HAVING (ROUND(ISNULL(MV61.ConvertedAmount,0),@ConvertedDecimal) - MT061.ConvertedAmount) <> 0
		) AA ON AA.ID = MT06.ID AND AA.[ROW] = 1

-- SINH SỐ CHỨNG TỪ PHÂN BỔ TỰ ĐỘNG
DECLARE @Enabled1 TINYINT,
		@Enabled2 TINYINT,
		@Enabled3 TINYINT,
		@S1 NVARCHAR(50),
		@S2 NVARCHAR(50),
		@S3 NVARCHAR(50),
		@S1Type TINYINT,
		@S2Type TINYINT,
		@S3Type TINYINT,
		@VoucherNo NVARCHAR(50),
		@StringKey1 nvarchar(50),
		@StringKey2 nvarchar(50),
		@StringKey3 nvarchar(50), 
		@OutputLen int, 
		@OutputOrder int,
		@Separated int, 
		@Separator char(1),
		@ExpenseVoucherTypeID VARCHAR(50),
		@DistributeDescription NVARCHAR(1000),
		@PeriodStr VARCHAR(20)

SET @ExpenseVoucherTypeID = (SELECT ISNULL(ExpenseVoucherTypeID,'PBO') FROM MT0000 WHERE DivisionID = @DivisionID)
SET @DistributeDescription = (SELECT ISNULL(DistributeDescription + ' ',N'Phân bổ chi phí ') FROM MT0000 WITH (NOLOCK) WHERE DivisionID = @DivisionID)
SET @PeriodStr = CASE WHEN @TranMonth < 10 THEN '0' + ltrim(@TranMonth) + ltrim(@TranYear) ELSE ltrim(@TranMonth) + ltrim(@TranYear) END

--LẤY CHỈ SỐ TĂNG SỐ CHỨNG TỪ
Select	@Enabled1=Enabled1, @Enabled2=Enabled2, @Enabled3=Enabled3, @S1=S1, @S2=S2, @S3=S3, @S1Type=S1Type, @S2Type=S2Type, @S3Type=S3Type,
		@OutputLen=OutputLength, @OutputOrder=OutputOrder, @Separated=Separated, @Separator=Separator
From AT1007 WITH (NOLOCK) Where DivisionID = @DivisionID AND VoucherTypeID = @ExpenseVoucherTypeID

If @Enabled1 = 1
	SET @StringKey1 = 
	Case @S1Type 
	When 1 Then Case When @TranMonth <10 Then '0' + ltrim(@TranMonth) Else ltrim(@TranMonth) End
	When 2 Then ltrim(@TranYear)
	When 3 Then @ExpenseVoucherTypeID
	When 4 Then @DivisionID
	When 5 Then @S1
	Else '' End
Else
	SET @StringKey1 = ''

If @Enabled2 = 1
	SET @StringKey2 = 
	Case @S2Type 
	When 1 Then Case When @TranMonth <10 Then '0' + ltrim(@TranMonth) Else ltrim(@TranMonth) End
	When 2 Then ltrim(@TranYear)
	When 3 Then @ExpenseVoucherTypeID
	When 4 Then @DivisionID
	When 5 Then @S2
	Else '' End
Else
	SET @StringKey2 = ''

If @Enabled3 = 1
	SET @StringKey3 = 
	Case @S3Type 
	When 1 Then Case When @TranMonth <10 Then '0' + ltrim(@TranMonth) Else ltrim(@TranMonth) End
	When 2 Then ltrim(@TranYear)
	When 3 Then @ExpenseVoucherTypeID
	When 4 Then @DivisionID
	When 5 Then @S3
	Else '' End
Else
	SET @StringKey3 = ''

Recal:
--- SINH SỐ CHỨNG TỪ PHÂN BỔ
Exec AP0000  @DivisionID, @VoucherNo OUTPUT, 'MT0400', @StringKey1, @StringKey2, @StringKey3, @OutputLen, @OutputOrder, @Separated, @Separator

IF EXISTS (SELECT 1 FROM MT0400 WITH (NOLOCK) WHERE DivisionID = @DivisionID AND VoucherNo = @VoucherNo)
	GOTO Recal

--INSERT VÀO BẢNG KẾT QUẢ PHÂN BỔ - MT0400
INSERT INTO MT0400 (ApportionCostID, PeriodID, MaterialQuantity, ProductQuantity, ConvertedAmount, ConvertedUnit, QuantityUnit, ProductID, MaterialID,ExpenseID, TranMonth, TranYear,
					Description, DivisionID, VoucherNo, VoucherDate, MaterialTypeID, VoucherTypeID, EmployeeID, PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
					PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID)

SELECT NEWID(), @PeriodID, Quantity, ProductQuantity, ConvertedAmount, ConvertedUnit, QuantityUnit, ProductID, MaterialID, ExpenseID, @TranMonth, @TranYear,
				@DistributeDescription + @PeriodStr, @DivisionID, @VoucherNo, GETDATE(), @MaterialTypeID, @ExpenseVoucherTypeID, @UserID, PS01ID, PS02ID, PS03ID, PS04ID, PS05ID, PS06ID, PS07ID, PS08ID, PS09ID, PS10ID,
					PS11ID, PS12ID, PS13ID, PS14ID, PS15ID, PS16ID, PS17ID, PS18ID, PS19ID, PS20ID
FROM MT0621	
WHERE ExpenseID = 'COST001'  AND MaterialTypeID = @MaterialTypeID

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
