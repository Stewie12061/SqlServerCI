IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[EDMP2029]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[EDMP2029]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO





-- <Summary>
---- KIỂM TRA 1 HỌC SINH 1 NĂM CHỈ ĐƯỢC HỌC 1 LỚP 
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
-- <History>
----Created by: Hồng Thảo, Date: 25/9/2019
-- <Example>
---- 
/*-- <Example>
	EDMP2029 @DivisionID = 'BE',  @UserID = 'HONGTHAO', @SchoolYearID = '2018-2019',@StudentID = '0000248', @APK = 'EA60A3C3-F252-428D-9AD0-391BA8837262' 
	 

----*/
CREATE PROCEDURE EDMP2029
( 
	 @DivisionID VARCHAR(50),
	 @UserID VARCHAR(50), 
	 @SchoolYearID VARCHAR(50),
	 @StudentID VARCHAR(50),
	 @APK VARCHAR(50) 

)
AS 

DECLARE @sSQL NVARCHAR(MAX),
		@IsTransfer VARCHAR(50)



IF ISNULL(@APK,'') = ''
BEGIN 

SELECT EDMT2021.StudentID, EDMT1020.ClassName
FROM EDMT2020 WITH (NOLOCK)
INNER JOIN EDMT2021 WITH (NOLOCK) ON EDMT2020.APK = EDMT2021.APKMaster
LEFT JOIN EDMT1020 WITH (NOLOCK) ON EDMT1020.DivisionID IN (@DivisionID,'@@@') AND EDMT1020.ClassID = EDMT2020.ClassID
WHERE EDMT2020.DivisionID = @DivisionID AND EDMT2020.DeleteFlg = 0 AND EDMT2021.DeleteFlg = 0 AND EDMT2020.SchoolYearID = @SchoolYearID AND EDMT2021.IsTransfer IN ('0','2')
AND EDMT2021.StudentID = @StudentID
AND CONVERT (VARCHAR(50),EDMT2020.APK)  != @APK 


END 



IF  ISNULL(@APK,'') != ''
BEGIN 

SELECT @IsTransfer = IsTransfer FROM EDMT2021 WHERE APKMaster = @APK AND StudentID = @StudentID AND DeleteFlg = 0


IF @IsTransfer = 0 OR @IsTransfer = 2 OR  ISNULL (@IsTransfer,'') = ''
BEGIN 

SELECT EDMT2021.StudentID, EDMT1020.ClassName
FROM EDMT2020 WITH (NOLOCK)
INNER JOIN EDMT2021 WITH (NOLOCK) ON EDMT2020.APK = EDMT2021.APKMaster
LEFT JOIN EDMT1020 WITH (NOLOCK) ON EDMT1020.DivisionID IN (@DivisionID,'@@@') AND EDMT1020.ClassID = EDMT2020.ClassID
WHERE EDMT2020.DivisionID = @DivisionID AND EDMT2020.DeleteFlg = 0 AND EDMT2021.DeleteFlg = 0 AND EDMT2020.SchoolYearID = @SchoolYearID AND EDMT2021.IsTransfer IN ('0','2')
AND EDMT2021.StudentID = @StudentID
AND CONVERT (VARCHAR(50),EDMT2020.APK)  != @APK 
END 


END 







GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
