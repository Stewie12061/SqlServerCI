IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[LMP2065]') AND OBJECTPROPERTY(ID, N'IsProcedure') = 1)
DROP PROCEDURE [DBO].[LMP2065]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO


-- <Summary>
---- Đổ nguồn dữ liệu của hợp đồng vay vào màn hình giải chấp (LMF2061)
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
-- <History>
----Created on 20/10/2017 by Hải Long
----Modify on
-- <Example>
/*  
 EXEC LMP2065 @DivisionID = 'AS', @UserID = 'ASOFTADMIN',@LoanVoucherID = 'a92b4c20-1351-43a2-b06c-eec5bd40c7fa', @Mode = 0
 EXEC LMP2065 @DivisionID = 'AS', @UserID = 'ASOFTADMIN',@LoanVoucherID = 'a92b4c20-1351-43a2-b06c-eec5bd40c7fa', @Mode = 1
*/
----
CREATE PROCEDURE [LMP2065] 
( 
	@DivisionID NVARCHAR(50),
	@UserID NVARCHAR(50),
	@LoanVoucherID NVARCHAR(50)
) 
AS

DECLARE	@sSQL1 VARCHAR (MAX) = '',
		@sSQL2 VARCHAR (MAX) = ''

SET @sSQL1 = '
SELECT LMT2003.VoucherID AS LoanVoucherID, LMT2003.TransactionID AS LoanTransactionID, LMT2003.TransactionID, LMT2003.SourceID, LMT0099.[Description] as SourceName, LMT2003.AssetID, LMT1020.AssetName, LMT2003.ConvertedAmount AS MortgageAmount,
LMT1020.AccountingValue, LMT1020.LoanLimitRate, LMT1020.LoanLimitAmount, LMT1020.EvaluationValue,
LMT2003.Ana01ID, LMT2003.Ana02ID, LMT2003.Ana03ID, LMT2003.Ana04ID, LMT2003.Ana05ID, 
LMT2003.Ana06ID, LMT2003.Ana07ID, LMT2003.Ana08ID, LMT2003.Ana09ID, LMT2003.Ana10ID,
A11.AnaName as Ana01Name, A12.AnaName as Ana02Name, A13.AnaName as Ana03Name, A14.AnaName as Ana04Name, A15.AnaName as Ana05Name,
A16.AnaName as Ana06Name, A17.AnaName as Ana07Name, A18.AnaName as Ana08Name, A19.AnaName as Ana09Name, A20.AnaName as Ana10Name,
LMT2003.ConvertedAmount - ISNULL(TB.UnwindAmount, 0) AS RemainAmount
FROM LMT2003 WITH (NOLOCK)
LEFT JOIN LMT1020 ON LMT1020.SourceID = LMT2003.SourceID And LMT1020.AssetID = LMT2003.AssetID
LEFT JOIN LMT0099 ON LMT1020.SourceID = LMT0099.ID And LMT0099.CodeMaster = ''LMT00000004''
LEFT JOIN AT1011 A11 WITH (NOLOCK) ON A11.AnaID  = LMT2003.Ana01ID AND A11.AnaTypeID = ''A01''
LEFT JOIN AT1011 A12 WITH (NOLOCK) ON A12.AnaID  = LMT2003.Ana02ID AND A12.AnaTypeID = ''A02''
LEFT JOIN AT1011 A13 WITH (NOLOCK) ON A13.AnaID  = LMT2003.Ana03ID AND A13.AnaTypeID = ''A03''
LEFT JOIN AT1011 A14 WITH (NOLOCK) ON A14.AnaID  = LMT2003.Ana04ID AND A14.AnaTypeID = ''A04''
LEFT JOIN AT1011 A15 WITH (NOLOCK) ON A15.AnaID  = LMT2003.Ana05ID AND A15.AnaTypeID = ''A05''
LEFT JOIN AT1011 A16 WITH (NOLOCK) ON A16.AnaID  = LMT2003.Ana06ID AND A16.AnaTypeID = ''A06''
LEFT JOIN AT1011 A17 WITH (NOLOCK) ON A17.AnaID  = LMT2003.Ana07ID AND A17.AnaTypeID = ''A07''
LEFT JOIN AT1011 A18 WITH (NOLOCK) ON A18.AnaID  = LMT2003.Ana08ID AND A18.AnaTypeID = ''A08''
LEFT JOIN AT1011 A19 WITH (NOLOCK) ON A19.AnaID  = LMT2003.Ana09ID AND A19.AnaTypeID = ''A09''
LEFT JOIN AT1011 A20 WITH (NOLOCK) ON A20.AnaID  = LMT2003.Ana10ID AND A20.AnaTypeID = ''A10''
LEFT JOIN
(
	SELECT LMT2061.DivisionID, LMT2061.LoanVoucherID, LMT2061.LoanTransactionID, SUM(LMT2061.UnwindAmount) AS UnwindAmount 
	FROM LMT2061 WITH (NOLOCK)
	GROUP BY LMT2061.DivisionID, LMT2061.LoanVoucherID, LMT2061.LoanTransactionID
) TB ON TB.DivisionID = LMT1020.DivisionID AND TB.LoanTransactionID = LMT2003.TransactionID AND TB.LoanVoucherID = LMT2003.VoucherID
WHERE LMT2003.DivisionID = ''' + @DivisionID + '''
AND LMT2003.VoucherID = ''' + @LoanVoucherID + ''''


--PRINT @sSQL1
--PRINT @sSQL2
EXEC (@sSQL1)


GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO

