IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[CMNP9008]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[CMNP9008]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO








-- <Summary>
---- Chọn dự án 
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
---- 
-- <History>
----Created by: Như Hàn on 06/12/2018
----Modify by: Kiều Nga on 13/07/2021 : Điều chỉnh đk lọc @DivisionID

-- <Example>
---- 
/*-- <Example>
	EXEC CMNP9008 @DivisionID, @UserID, @PageNumber, @PageSize, @txtSearch, @AnaTypeID
	EXEC CMNP9008 'AIC', 'ASOFTADMIN', 1, 20, '', 'A01'
----*/
CREATE PROCEDURE CMNP9008
( 
	 @DivisionID VARCHAR(50),
	 @UserID VARCHAR(50),
	 @PageNumber INT,
	 @PageSize INT,
	 @txtSearch NVARCHAR(100), 
	 @AnaTypeID VARCHAR(50)


)

AS 
DECLARE @sSQL NVARCHAR(MAX) = N'', 
		@OrderBy NVARCHAR(MAX) = N'', 
		@TotalRow NVARCHAR(50) = N'',
		@sWhere NVARCHAR(MAX) = N''

 SELECT *, 
		Convert(NVarchar(50),'') AS Ana01ID,
		Convert(NVarchar(50),'') AS ReAnaType01ID,
		Convert(NVarchar(50),'') AS Ana02ID,
		Convert(NVarchar(50),'') AS ReAnaType02ID,
		Convert(NVarchar(50),'') AS Ana03ID,
		Convert(NVarchar(50),'') AS ReAnaType03ID,
		Convert(NVarchar(50),'') AS Ana04ID,
		Convert(NVarchar(50),'') AS ReAnaType04ID,
		Convert(NVarchar(50),'') AS Ana05ID,
		Convert(NVarchar(50),'') AS ReAnaType05ID,
		Convert(NVarchar(50),'') AS Ana06ID,
		Convert(NVarchar(50),'') AS ReAnaType06ID,
		Convert(NVarchar(50),'') AS Ana07ID,
		Convert(NVarchar(50),'') AS ReAnaType07ID,
		Convert(NVarchar(50),'') AS Ana08ID,
		Convert(NVarchar(50),'') AS ReAnaType08ID,
		Convert(NVarchar(50),'') AS Ana09ID,
		Convert(NVarchar(50),'') AS ReAnaType09ID,
		Convert(NVarchar(50),'') AS Ana10ID,
		Convert(NVarchar(50),'') AS ReAnaType10ID
INTO #AT1011
FROM AT1011
WHERE Disabled = 0
AND DivisionID IN('@@@',@DivisionID) -- AND AnaTypeID = 'A03'
ORDER BY AnaID
UPDATE T1
SET  T1.Ana01ID = CASE T2.ReTypeID WHEN  'A01' THEN T3.AnaID ELSE '' END,
	T1.Ana02ID = CASE T2.ReTypeID WHEN  'A02' THEN T3.AnaID ELSE '' END,
	T1.Ana03ID = CASE T2.ReTypeID WHEN  'A03' THEN T3.AnaID ELSE '' END,
	T1.Ana04ID = CASE T2.ReTypeID WHEN  'A04' THEN T3.AnaID ELSE '' END,
	T1.Ana05ID = CASE T2.ReTypeID WHEN  'A05' THEN T3.AnaID ELSE '' END,
	T1.Ana06ID = CASE T2.ReTypeID WHEN  'A06' THEN T3.AnaID ELSE '' END,	
	T1.Ana07ID = CASE T2.ReTypeID WHEN  'A07' THEN T3.AnaID ELSE '' END,
	T1.Ana08ID = CASE T2.ReTypeID WHEN  'A08' THEN T3.AnaID ELSE '' END,
	T1.Ana09ID = CASE T2.ReTypeID WHEN  'A09' THEN T3.AnaID ELSE '' END,
	T1.Ana10ID = CASE T2.ReTypeID WHEN  'A10' THEN T3.AnaID ELSE '' END,
	T1.ReAnaType01ID = CASE WHEN T2.ReTypeID = 'A01' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType02ID = CASE WHEN T2.ReTypeID = 'A02' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType03ID = CASE WHEN T2.ReTypeID = 'A03' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType04ID = CASE WHEN T2.ReTypeID = 'A04' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType05ID = CASE WHEN T2.ReTypeID = 'A05' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType06ID = CASE WHEN T2.ReTypeID = 'A06' THEN T2.ReTypeID ELSE '' END,	
	T1.ReAnaType07ID = CASE WHEN T2.ReTypeID = 'A07' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType08ID = CASE WHEN T2.ReTypeID = 'A08' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType09ID = CASE WHEN T2.ReTypeID = 'A09' THEN T2.ReTypeID ELSE '' END,
	T1.ReAnaType10ID = CASE WHEN T2.ReTypeID = 'A10' THEN T2.ReTypeID ELSE '' END
FROM #AT1011 T1
INNER JOIN AT0005 T2 on T1.AnaTypeID = T2.TypeID
INNER JOIN AT1011 T3 on T3.AnaTypeID = T2.ReTypeID AND T1.ReAnaID = T3.AnaID
	
DECLARE @i INT = 1, @N INT

SELECT @n = Count(1)
FROM AT0005
WHERE isnull(ReTypeID,'') <> ''
	
WHILE (@i <=@n)
BEGIN
	UPDATE T1
	SET	T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,	
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,		
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana01ID = T2.AnaID and T1.ReAnaType01ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana01ID,'') <> ''


	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,	
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana02ID = T2.AnaID and T1.ReAnaType02ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana02ID,'') <> ''

	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID  WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana04ID = CASE T3.ReTypeID  WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID  WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,
		T1.Ana06ID = CASE T3.ReTypeID  WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,	
		T1.Ana07ID = CASE T3.ReTypeID  WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID  WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID  WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana03ID = T2.AnaID and T1.ReAnaType03ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana03ID,'') <> ''
	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,	
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID  END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID  END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID  END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID  END,
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID  END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID  END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID  END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID  END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID  END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana04ID = T2.AnaID and T1.ReAnaType04ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana04ID,'') <> ''
	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,	
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana05ID = T2.AnaID and T1.ReAnaType05ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana05ID,'') <> ''
	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,	
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,	
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana06ID = T2.AnaID and T1.ReAnaType06ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana06ID,'') <> ''
	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,	
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,	
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana07ID = T2.AnaID and T1.ReAnaType07ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana07ID,'') <> ''

	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,	
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,	
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana08ID = T2.AnaID and T1.ReAnaType08ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana08ID,'') <> ''

	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,	
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana10ID = CASE T3.ReTypeID WHEN  'A10' THEN T2.ReAnaID ELSE T1.Ana10ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,	
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType10ID = CASE WHEN T3.ReTypeID = 'A10' THEN T3.ReTypeID ELSE T1.ReAnaType10ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana09ID = T2.AnaID and T1.ReAnaType09ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana09ID,'') <> ''

	UPDATE T1
	SET	T1.Ana01ID = CASE T3.ReTypeID WHEN  'A01' THEN T2.ReAnaID ELSE T1.Ana01ID END,
		T1.Ana02ID = CASE T3.ReTypeID WHEN  'A02' THEN T2.ReAnaID ELSE T1.Ana02ID END,
		T1.Ana03ID = CASE T3.ReTypeID WHEN  'A03' THEN T2.ReAnaID ELSE T1.Ana03ID END,
		T1.Ana04ID = CASE T3.ReTypeID WHEN  'A04' THEN T2.ReAnaID ELSE T1.Ana04ID END,
		T1.Ana05ID = CASE T3.ReTypeID WHEN  'A05' THEN T2.ReAnaID ELSE T1.Ana05ID END,	
		T1.Ana06ID = CASE T3.ReTypeID WHEN  'A06' THEN T2.ReAnaID ELSE T1.Ana06ID END,
		T1.Ana07ID = CASE T3.ReTypeID WHEN  'A07' THEN T2.ReAnaID ELSE T1.Ana07ID END,
		T1.Ana08ID = CASE T3.ReTypeID WHEN  'A08' THEN T2.ReAnaID ELSE T1.Ana08ID END,
		T1.Ana09ID = CASE T3.ReTypeID WHEN  'A09' THEN T2.ReAnaID ELSE T1.Ana09ID END,
		T1.ReAnaType01ID = CASE WHEN T3.ReTypeID = 'A01' THEN T3.ReTypeID ELSE T1.ReAnaType01ID END,
		T1.ReAnaType02ID = CASE WHEN T3.ReTypeID = 'A02' THEN T3.ReTypeID ELSE T1.ReAnaType02ID END,
		T1.ReAnaType03ID = CASE WHEN T3.ReTypeID = 'A03' THEN T3.ReTypeID ELSE T1.ReAnaType03ID END,
		T1.ReAnaType04ID = CASE WHEN T3.ReTypeID = 'A04' THEN T3.ReTypeID ELSE T1.ReAnaType04ID END,
		T1.ReAnaType05ID = CASE WHEN T3.ReTypeID = 'A05' THEN T3.ReTypeID ELSE T1.ReAnaType05ID END,	
		T1.ReAnaType06ID = CASE WHEN T3.ReTypeID = 'A06' THEN T3.ReTypeID ELSE T1.ReAnaType06ID END,
		T1.ReAnaType07ID = CASE WHEN T3.ReTypeID = 'A07' THEN T3.ReTypeID ELSE T1.ReAnaType07ID END,
		T1.ReAnaType08ID = CASE WHEN T3.ReTypeID = 'A08' THEN T3.ReTypeID ELSE T1.ReAnaType08ID END,
		T1.ReAnaType09ID = CASE WHEN T3.ReTypeID = 'A09' THEN T3.ReTypeID ELSE T1.ReAnaType09ID END
	FROM #AT1011 T1
	INNER JOIN AT1011 T2 on T1.Ana10ID = T2.AnaID and T1.ReAnaType10ID = T2.AnaTypeID
	INNER JOIN AT0005 T3 on T2.AnaTypeID = T3.TypeID
	WHERE	isnull(T1.Ana10ID,'') <> ''
SET @i = @i+1
END

--Lọc dự án còn hiệu lực (Mã phân tích dự án) 
--Trạng thái hết hiệu lực của dự án: 
--- Hoàn thành (TTDA0003).
--- Hủy (TTDA0010).
--- Thất bại (TTDA0004)

if @AnaTypeID = 'A01' and dbo.GetCustomizeIndex() = 114
BEGIN
	SELECT CONVERT(INT, ROW_NUMBER() OVER (ORDER BY AnaID )) AS RowNum, COUNT(*) OVER () AS TotalRow, 
	* FROM #AT1011
	inner join OOT2100 WITH(NOLOCK) on #AT1011.AnaID = OOT2100.ProjectID
	WHERE AnaTypeID = @AnaTypeID AND (AnaID LIKE '%'+ISNULL(@txtSearch,'%')+'%' OR AnaName LIKE '%'+ISNULL(@txtSearch,'%')+'%')
	AND #AT1011.AnaTypeID = @AnaTypeID and OOT2100.StatusID not in ('TTDA0003', 'TTDA0010','TTDA0004')
	ORDER BY AnaID
	OFFSET (@PageNumber-1) * @PageSize ROWS
	FETCH NEXT @PageSize ROWS ONLY
END
ELSE
BEGIN
	SELECT CONVERT(INT, ROW_NUMBER() OVER (ORDER BY AnaID )) AS RowNum, COUNT(*) OVER () AS TotalRow, 
	* FROM #AT1011
	WHERE AnaTypeID = @AnaTypeID AND (AnaID LIKE '%'+ISNULL(@txtSearch,'%')+'%' OR AnaName LIKE '%'+ISNULL(@txtSearch,'%')+'%')
	ORDER BY AnaID
	OFFSET (@PageNumber-1) * @PageSize ROWS
	FETCH NEXT @PageSize ROWS ONLY
END

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
