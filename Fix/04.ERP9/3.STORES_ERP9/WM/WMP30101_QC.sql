IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[WMP30101_QC]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[WMP30101_QC]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




---- Created by Hoài Bảo ON 13/03/2023
---- Purpose: In báo cáo nhập xuất tồn theo kho (tất cả các kho) theo quy cách hàng hóa (Copy From AP3009)
---- Modified by ... ON ...

-- <Example>
---- EXEC WMP30101_QC @DivisionID=N''1B'',@DivisionIDList=''1B'',@WareHouseID=''CCDC'''',''''HH'',@InventoryID=N''ABC001'',@FromDate=N''2023-03-14 00:00:00'',@ToDate=N''2023-03-14 00:00:00'',@PeriodList=NULL,@IsPeriod=0,@IsGroupID=1,@GroupID1=NULL,@GroupID2=N''I03'',@UserID=N''ASOFTADMIN''

CREATE PROCEDURE WMP30101_QC
(
    @DivisionID		  AS NVARCHAR(50)  = '',
	@DivisionIDList	  AS NVARCHAR(MAX) = '',
    @WareHouseID      AS NVARCHAR(MAX) = '',
    @InventoryID	  AS NVARCHAR(MAX) = '',
    @FromDate         AS DATETIME = NULL,
    @ToDate           AS DATETIME = NULL,
	@PeriodList		  AS NVARCHAR(MAX) = '',
    @IsPeriod         AS TINYINT = 0, -- 0: Theo ngày, 1: Theo kỳ
    @IsGroupID		  AS TINYINT, --- 0 Khong nhom; 1 Nhom 1 cap; 2 Nhom 2 cap
    @GroupID1		  AS NVARCHAR(50),
    @GroupID2		  AS NVARCHAR(50),--- Note : GroupID nhan cac gia tri S1, S2, S3, CI1, CI2, CI3
	@UserID			  AS VARCHAR(50)
)
AS
DECLARE
	@sWhere AS NVARCHAR(MAX),
	@sSQL1 AS NVARCHAR(4000),
	@sSQL1a AS NVARCHAR(4000),
	@sSQL2 AS NVARCHAR(4000),
	@sSQL2a AS NVARCHAR(4000),
	@sSQL3 AS NVARCHAR(4000),
	@sSQL3a AS NVARCHAR(4000),
	@sSQL4 AS NVARCHAR(4000),
	@GroupField1 AS NVARCHAR(20),
	@GroupField2 AS NVARCHAR(20),
	@FromDateText NVARCHAR(20),
	@ToDateText NVARCHAR(20),
	@GroupID VARCHAR(50)

SET @sWhere = ''
SET @GroupID = (SELECT TOP 1 AT1402.GroupID FROM AT1402 WITH(NOLOCK) WHERE AT1402.UserID = @UserID)
SET @FromDateText = CONVERT(NVARCHAR(20), @FromDate, 101)
SET @ToDateText = CONVERT(NVARCHAR(20), @ToDate, 101) + ' 23:59:59'

-- Check Para FromDate và ToDate
-- Trường hợp search theo từ ngày đến ngày
IF @IsPeriod = 0
BEGIN
	IF(ISNULL(@FromDate,'') != '' AND ISNULL(@ToDate,'') = '' )
		BEGIN
			SET @sWhere = @sWhere + ' AND (AV7000.VoucherDate >= ''' + @FromDateText + ''')'
		END
	ELSE IF(ISNULL(@FromDate,'') = '' AND ISNULL(@ToDate,'') != '')
		BEGIN
			SET @sWhere = @sWhere + ' AND (AV7000.VoucherDate <= ''' + @ToDateText + ''')'
		END
	ELSE IF(ISNULL(@FromDate, '') != '' AND ISNULL(@ToDate, '') != '')
		BEGIN
			SET @sWhere = @sWhere + ' AND (AV7000.VoucherDate BETWEEN ''' + @FromDateText + ''' AND ''' + @ToDateText + ''') '
		END
END
ELSE IF @IsPeriod = 1 AND ISNULL(@PeriodList, '') != ''
	BEGIN
		SET @sWhere = @sWhere + ' AND ((SELECT FORMAT(AV7000.VoucherDate, ''MM/yyyy'')) IN (''' + @PeriodList + ''')'
	END

--- Xóa các bảng tạm nếu đã tồn tại
IF EXISTS (SELECT *	FROM tempdb.dbo.sysobjects WHERE ID = OBJECT_ID(N'tempdb.dbo.##AV7016'))
	DROP TABLE ##AV7016

IF EXISTS (SELECT *	FROM tempdb.dbo.sysobjects WHERE ID = OBJECT_ID(N'tempdb.dbo.##AV3088'))
	DROP TABLE ##AV3088

IF EXISTS (SELECT *	FROM tempdb.dbo.sysobjects WHERE ID = OBJECT_ID(N'tempdb.dbo.##AV3098'))
	DROP TABLE ##AV3098

IF @IsPeriod = 1 --theo ky
BEGIN
	SET @sSQL1 = N' 
		SELECT AT2008.InventoryID, AT1302.InventoryName, AT1302.UnitID, AT1302.VATPercent, AT1309.UnitID AS ConversionUnitID, AT1309.ConversionFactor, AT1309.Operator,
		AT1302.S1, AT1302.S2, AT1302.S3, AT1302.I01ID, AT1302.I02ID, AT1302.I03ID, AT1302.I04ID, AT1302.I05ID, AT1302.InventoryTypeID, AT1302.Specification,
		AT1302.Notes01, AT1302.Notes02, AT1302.Notes03, AT1302.Varchar01, AT1302.Varchar02, AT1302.Varchar03, AT1302.Varchar04, AT1302.Varchar05, AT1304.UnitName,
		SUM(CASE WHEN (CONCAT(TranMonth, ''/'', TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''') THEN ISNULL(BeginQuantity, 0) ELSE 0 END) AS BeginQuantity,
		SUM(CASE WHEN (CONCAT(TranMonth, ''/'', TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''') THEN ISNULL(EndQuantity, 0) ELSE 0 END) AS EndQuantity,
		SUM(ISNULL(DebitQuantity, 0) - ISNULL(InDebitQuantity, 0)) AS DebitQuantity,
		SUM(ISNULL(CreditQuantity, 0) - ISNULL(InCreditQuantity, 0)) AS CreditQuantity,
		SUM(CASE WHEN (CONCAT(TranMonth, ''/'', TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''') THEN ISNULL(BeginAmount, 0) ELSE 0 END) AS BeginAmount,
		SUM(CASE WHEN (CONCAT(TranMonth, ''/'', TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''') THEN ISNULL(EndAmount, 0) ELSE 0 END) AS EndAmount,
		SUM(ISNULL(DebitAmount, 0) - ISNULL(InDebitAmount, 0)) AS DebitAmount, SUM(ISNULL(CreditAmount, 0) - ISNULL(InCreditAmount, 0)) AS CreditAmount,
		SUM(ISNULL(InDebitAmount, 0)) AS InDebitAmount, SUM(ISNULL(InCreditAmount, 0)) AS InCreditAmount, SUM(ISNULL(InDebitQuantity, 0)) AS InDebitQuantity,
		SUM(ISNULL(InCreditQuantity, 0)) AS InCreditQuantity, AT2008.DivisionID, AT2008.S01ID, AT2008.S02ID, AT2008.S03ID, AT2008.S04ID, AT2008.S05ID,
		AT2008.S06ID, AT2008.S07ID, AT2008.S08ID, AT2008.S09ID, AT2008.S10ID, AT2008.S11ID, AT2008.S12ID, AT2008.S13ID, AT2008.S14ID, AT2008.S15ID, AT2008.S16ID,
		AT2008.S17ID, AT2008.S18ID, AT2008.S19ID, AT2008.S20ID, AT1303.WareHouseID, AT1303.WarehouseName
		'
	SET @sSQL2 = N' INTO ##AV3098
		FROM AT2008_QC AT2008 WITH(NOLOCK)
		INNER JOIN AT1302 WITH(NOLOCK) ON AT1302.DivisionID IN (AT2008.DivisionID,''@@@'') AND AT1302.InventoryID = AT2008.InventoryID
		INNER JOIN AT1304 WITH(NOLOCK) ON AT1302.DivisionID IN (AT1304.DivisionID,''@@@'') AND AT1304.UnitID = AT1302.UnitID
		INNER JOIN AT1303 WITH(NOLOCK) ON AT1303.WareHouseID = AT2008.WareHouseID
		LEFT JOIN AT1309 WITH(NOLOCK) ON AT1309.InventoryID = AT2008.InventoryID AND AT1302.DivisionID IN (AT1309.DivisionID,''@@@'') AND AT1309.UnitID = AT1302.UnitID
		AND ISNULL(AT2008.S01ID,'''') = ISNULL(AT1309.S01ID,'''') AND ISNULL(AT2008.S02ID,'''') = ISNULL(AT1309.S02ID,'''')
		AND ISNULL(AT2008.S03ID,'''') = ISNULL(AT1309.S03ID,'''') AND ISNULL(AT2008.S04ID,'''') = ISNULL(AT1309.S04ID,'''')
		AND ISNULL(AT2008.S05ID,'''') = ISNULL(AT1309.S05ID,'''') AND ISNULL(AT2008.S06ID,'''') = ISNULL(AT1309.S06ID,'''')
		AND ISNULL(AT2008.S07ID,'''') = ISNULL(AT1309.S07ID,'''') AND ISNULL(AT2008.S08ID,'''') = ISNULL(AT1309.S08ID,'''')
		AND ISNULL(AT2008.S09ID,'''') = ISNULL(AT1309.S09ID,'''') AND ISNULL(AT2008.S10ID,'''') = ISNULL(AT1309.S10ID,'''')
		AND ISNULL(AT2008.S11ID,'''') = ISNULL(AT1309.S11ID,'''') AND ISNULL(AT2008.S12ID,'''') = ISNULL(AT1309.S12ID,'''')
		AND ISNULL(AT2008.S13ID,'''') = ISNULL(AT1309.S13ID,'''') AND ISNULL(AT2008.S14ID,'''') = ISNULL(AT1309.S14ID,'''')
		AND ISNULL(AT2008.S15ID,'''') = ISNULL(AT1309.S15ID,'''') AND ISNULL(AT2008.S16ID,'''') = ISNULL(AT1309.S16ID,'''')
		AND ISNULL(AT2008.S17ID,'''') = ISNULL(AT1309.S17ID,'''') AND ISNULL(AT2008.S18ID,'''') = ISNULL(AT1309.S18ID,'''')
		AND ISNULL(AT2008.S19ID,'''') = ISNULL(AT1309.S19ID,'''') AND ISNULL(AT2008.S20ID,'''') = ISNULL(AT1309.S20ID,'''')
		WHERE AT1303.IsTemp = 0 AND AT2008.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''')
		AND AT2008.WareHouseID IN (N''' + @WareHouseID + ''')
		AND AT2008.InventoryID IN (SELECT Value FROM dbo.StringSplit(''' +@InventoryID+ ''', '',''))
		AND (CONCAT(AT2008.TranMonth, ''/'', AT2008.TranYear)) IN (''' + @PeriodList + ''')
		GROUP BY AT2008.InventoryID, InventoryName, AT1302.UnitID, AT1304.UnitName, AT1302.VATPercent, AT1309.UnitID, AT1309.ConversionFactor, AT1309.Operator,
		AT1302.S1, AT1302.S2, AT1302.S3, AT1302.I01ID, AT1302.I02ID, AT1302.I03ID, AT1302.I04ID, AT1302.I05ID, AT1302.InventoryTypeID, AT1302.Specification,
		AT1302.Notes01, AT1302.Notes02, AT1302.Notes03, AT1302.Varchar01, AT1302.Varchar02, AT1302.Varchar03, AT1302.Varchar04, AT1302.Varchar05, AT2008.DivisionID,
		AT2008.S01ID, AT2008.S02ID, AT2008.S03ID, AT2008.S04ID, AT2008.S05ID, AT2008.S06ID, AT2008.S07ID, AT2008.S08ID, AT2008.S09ID, AT2008.S10ID, AT2008.S11ID,
		AT2008.S12ID, AT2008.S13ID, AT2008.S14ID, AT2008.S15ID, AT2008.S16ID, AT2008.S17ID, AT2008.S18ID, AT2008.S19ID, AT2008.S20ID, AT1303.WareHouseID, AT1303.WarehouseName
		'
END
ELSE -- theo ngay
BEGIN
	SET @sSQL1 = N'
		SELECT V7.InventoryID, V7.InventoryName, V7.UnitID, V7.S1, V7.S2, V7.S3, V7.I01ID, V7.I02ID, V7.I03ID, V7.I04ID, V7.I05ID, V7.UnitName, V7.VATPercent, V7.InventoryTypeID, V7.Specification,
		V7.Notes01, V7.Notes02, V7.Notes03, V7.Varchar01,V7.Varchar02,V7.Varchar03,V7.Varchar04,V7.Varchar05, SUM(SignQuantity) AS BeginQuantity,
		SUM(SignAmount) AS BeginAmount, V7.DivisionID, V7.S01ID, V7.S02ID, V7.S03ID, V7.S04ID, V7.S05ID, V7.S06ID, V7.S07ID, V7.S08ID, V7.S09ID, V7.S10ID,
		V7.S11ID, V7.S12ID, V7.S13ID, V7.S14ID, V7.S15ID, V7.S16ID, V7.S17ID, V7.S18ID, V7.S19ID, V7.S20ID, D03.WareHouseID, D03.WarehouseName
		'
	SET @sSQL2 = ' INTO ##AV7016
		FROM AV7002 V7
		LEFT JOIN AT1303 AS D03 WITH (NOLOCK) ON D03.WareHouseID = V7.WareHouseID
		WHERE V7.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''') AND (V7.VoucherDate < ''' + @FromDateText + ''' OR D_C = ''BD'')
		AND V7.WareHouseID IN (N''' + @WareHouseID + ''')
		AND V7.InventoryID IN (SELECT Value FROM dbo.StringSplit(''' +@InventoryID+ ''', '',''))
		GROUP BY V7.InventoryID, V7.InventoryName, V7.UnitID, V7.S1, V7.S2, V7.S3, V7.I01ID, V7.I02ID, V7.I03ID, V7.I04ID, V7.I05ID, V7.UnitName, V7.VATPercent, V7.InventoryTypeID, V7.Specification,
		V7.Notes01, V7.Notes02, V7.Notes03, V7.Varchar01,V7.Varchar02,V7.Varchar03,V7.Varchar04,V7.Varchar05, V7.DivisionID,
		V7.S01ID, V7.S02ID, V7.S03ID, V7.S04ID, V7.S05ID, V7.S06ID, V7.S07ID, V7.S08ID, V7.S09ID, V7.S10ID,
		V7.S11ID, V7.S12ID, V7.S13ID, V7.S14ID, V7.S15ID, V7.S16ID, V7.S17ID, V7.S18ID, V7.S19ID, V7.S20ID, D03.WareHouseID, D03.WarehouseName
		'
		
	PRINT(@sSQL1 + @sSQL2)
	EXEC(@sSQL1 + @sSQL2)
		
	SET @sSQL1 = N'
	SELECT InventoryID, InventoryName, UnitID, S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, VATPercent, InventoryTypeID, Specification, 
	Notes01, Notes02, Notes03, Varchar01, Varchar02, Varchar03, Varchar04, Varchar05, UnitName, BeginQuantity, BeginAmount, 0 AS DebitQuantity, 
	0 AS CreditQuantity, 0 AS DebitAmount, 0 AS CreditAmount, 0 AS EndQuantity, 0 AS EndAmount, AV7016.DivisionID,
	AV7016.S01ID, AV7016.S02ID, AV7016.S03ID, AV7016.S04ID, AV7016.S05ID, AV7016.S06ID, AV7016.S07ID, AV7016.S08ID, AV7016.S09ID, AV7016.S10ID,
	AV7016.S11ID, AV7016.S12ID, AV7016.S13ID, AV7016.S14ID, AV7016.S15ID, AV7016.S16ID, AV7016.S17ID, AV7016.S18ID, AV7016.S19ID, AV7016.S20ID,
	AV7016.WareHouseID, AV7016.WarehouseName
	'
	SET @sSQL2 = N' INTO ##AV3088
	FROM ##AV7016 AV7016
	'
	SET @sSQL3 = N'
	UNION ALL
	SELECT AV7000.InventoryID, AV7000.InventoryName, AV7000.UnitID, AV7000.S1, AV7000.S2, AV7000.S3, AV7000.I01ID, AV7000.I02ID, AV7000.I03ID, AV7000.I04ID, AV7000.I05ID, 
	AV7000.VATPercent, AV7000.InventoryTypeID, AV7000.Specification, AV7000.Notes01, AV7000.Notes02, AV7000.Notes03,
	AV7000.Varchar01,AV7000.Varchar02,AV7000.Varchar03,AV7000.Varchar04,AV7000.Varchar05, AV7000.UnitName, 
	0 AS BeginQuantity, 0 AS BeginAmount, 
	SUM(CASE WHEN D_C = ''D'' THEN ISNULL(AV7000.ActualQuantity, 0) ELSE 0 END) AS DebitQuantity, 
	SUM(CASE WHEN D_C = ''C'' THEN ISNULL(AV7000.ActualQuantity, 0) ELSE 0 END) AS CreditQuantity, 
	SUM(CASE WHEN D_C = ''D'' THEN ISNULL(AV7000.ConvertedAmount, 0) ELSE 0 END) AS DebitAmount, 
	SUM(CASE WHEN D_C = ''C'' THEN ISNULL(AV7000.ConvertedAmount, 0) ELSE 0 END) AS CreditAmount, 
	0 AS EndQuantity, 0 AS EndAmount, AV7000.DivisionID,
	AV7000.S01ID, AV7000.S02ID, AV7000.S03ID, AV7000.S04ID, AV7000.S05ID, AV7000.S06ID, AV7000.S07ID, AV7000.S08ID, AV7000.S09ID, AV7000.S10ID,
	AV7000.S11ID, AV7000.S12ID, AV7000.S13ID, AV7000.S14ID, AV7000.S15ID, AV7000.S16ID, AV7000.S17ID, AV7000.S18ID, AV7000.S19ID, AV7000.S20ID,
	D03.WareHouseID, D03.WarehouseName
	'

	SET @sSQL4 =N'
	FROM AV7003 AV7000 
	LEFT JOIN AT1303 AS D03 WITH (NOLOCK) ON D03.WareHouseID = AV7000.WareHouseID
	--LEFT JOIN AV7016 ON AV7000.InventoryID = AV7016.InventoryID AND AV7000.UnitID = AV7016.UnitID AND AV7016.DivisionID = AV7000.DivisionID

	WHERE AV7000.IsTemp = 0 AND AV7000.D_C IN (''D'', ''C'') AND AV7000.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''')
	AND AV7000.WareHouseID IN (N''' + @WareHouseID + ''')
	AND AV7000.InventoryID IN (SELECT Value FROM dbo.StringSplit(''' +@InventoryID+ ''', '',''))
	' +@sWhere+ '
	GROUP BY AV7000.InventoryID, AV7000.InventoryName, AV7000.UnitID, AV7000.UnitName, ---AV7016.BeginQuantity, AV7016.BeginAmount, 
	AV7000.S1, AV7000.S2, AV7000.S3, AV7000.I01ID, AV7000.I02ID, AV7000.I03ID, AV7000.I04ID, AV7000.I05ID, AV7000.VATPercent,
	AV7000.InventoryTypeID, AV7000.Specification, AV7000.Notes01, AV7000.Notes02, AV7000.Notes03, AV7000.Varchar01, AV7000.Varchar02,
	AV7000.Varchar03,AV7000.Varchar04,AV7000.Varchar05, AV7000.DivisionID, AV7000.S01ID, AV7000.S02ID, AV7000.S03ID, AV7000.S04ID,
	AV7000.S05ID, AV7000.S06ID, AV7000.S07ID, AV7000.S08ID, AV7000.S09ID, AV7000.S10ID, AV7000.S11ID, AV7000.S12ID, AV7000.S13ID,
	AV7000.S14ID, AV7000.S15ID, AV7000.S16ID, AV7000.S17ID, AV7000.S18ID, AV7000.S19ID, AV7000.S20ID, D03.WareHouseID, D03.WarehouseName
	'
	PRINT(@sSQL1)
	PRINT(@sSQL2)
	PRINT(@sSQL3)
	PRINT(@sSQL4)
	EXEC(@sSQL1 + @sSQL2 + @sSQL3 + @sSQL4)
		
	SET @sSQL1 = N'
	SELECT AV3088.InventoryID, InventoryName, AV3088.UnitID, UnitName, AV3088.VATPercent, AV3088.InventoryTypeID, Specification, 
	AV3088.Notes01, AV3088.Notes02, AV3088.Notes03, AV3088.Varchar01,AV3088.Varchar02,AV3088.Varchar03,AV3088.Varchar04,AV3088.Varchar05, 
	AT1309.UnitID AS ConversionUnitID, AT1309.ConversionFactor, AT1309.Operator, S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, 
	SUM(BeginQuantity) AS BeginQuantity, SUM(BeginAmount) AS BeginAmount, DebitQuantity, CreditQuantity, DebitAmount, CreditAmount, 
	0 AS InDebitAmount, 0 AS InCreditAmount, 0 AS InDebitQuantity, 0 AS InCreditQuantity, SUM(BeginQuantity) + DebitQuantity - CreditQuantity AS EndQuantity, 
	SUM(BeginAmount) + DebitAmount - CreditAmount AS EndAmount, AV3088.DivisionID, AV3088.S01ID, AV3088.S02ID, AV3088.S03ID, AV3088.S04ID,
	AV3088.S05ID, AV3088.S06ID, AV3088.S07ID, AV3088.S08ID, AV3088.S09ID, AV3088.S10ID, AV3088.S11ID, AV3088.S12ID, AV3088.S13ID, AV3088.S14ID,
	AV3088.S15ID, AV3088.S16ID, AV3088.S17ID, AV3088.S18ID, AV3088.S19ID, AV3088.S20ID, AV3088.WareHouseID, AV3088.WareHouseName
	'
	SET @sSQL2 = N'INTO ##AV3098
	FROM ##AV3088 AV3088
	LEFT JOIN AT1309 WITH(NOLOCK) ON AT1309.InventoryID = AV3088.InventoryID AND AT1309.UnitID = AV3088.UnitID
	AND ISNULL(AV3088.S01ID,'''') = ISNULL(AT1309.S01ID,'''') AND ISNULL(AV3088.S02ID,'''') = ISNULL(AT1309.S02ID,'''')
	AND ISNULL(AV3088.S03ID,'''') = ISNULL(AT1309.S03ID,'''') AND ISNULL(AV3088.S04ID,'''') = ISNULL(AT1309.S04ID,'''')
	AND ISNULL(AV3088.S05ID,'''') = ISNULL(AT1309.S05ID,'''') AND ISNULL(AV3088.S06ID,'''') = ISNULL(AT1309.S06ID,'''')
	AND ISNULL(AV3088.S07ID,'''') = ISNULL(AT1309.S07ID,'''') AND ISNULL(AV3088.S08ID,'''') = ISNULL(AT1309.S08ID,'''') 
	AND ISNULL(AV3088.S09ID,'''') = ISNULL(AT1309.S09ID,'''') AND ISNULL(AV3088.S10ID,'''') = ISNULL(AT1309.S10ID,'''') 
	AND ISNULL(AV3088.S11ID,'''') = ISNULL(AT1309.S11ID,'''') AND ISNULL(AV3088.S12ID,'''') = ISNULL(AT1309.S12ID,'''') 
	AND ISNULL(AV3088.S13ID,'''') = ISNULL(AT1309.S13ID,'''') AND ISNULL(AV3088.S14ID,'''') = ISNULL(AT1309.S14ID,'''') 
	AND ISNULL(AV3088.S15ID,'''') = ISNULL(AT1309.S15ID,'''') AND ISNULL(AV3088.S16ID,'''') = ISNULL(AT1309.S16ID,'''') 
	AND ISNULL(AV3088.S17ID,'''') = ISNULL(AT1309.S17ID,'''') AND ISNULL(AV3088.S18ID,'''') = ISNULL(AT1309.S18ID,'''') 
	AND ISNULL(AV3088.S19ID,'''') = ISNULL(AT1309.S19ID,'''') AND ISNULL(AV3088.S20ID,'''') = ISNULL(AT1309.S20ID,'''')
	GROUP BY S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, AV3088.InventoryID, InventoryName, AV3088.UnitID, UnitName, 
	AT1309.UnitID, AT1309.ConversionFactor, AT1309.Operator, DebitQuantity, DebitAmount, CreditQuantity, CreditAmount, 
	AV3088.VATPercent, AV3088.InventoryTypeID, Specification, AV3088.Notes01, AV3088.Notes02, AV3088.Notes03, AV3088.Varchar01,
	AV3088.Varchar02, AV3088.Varchar03, AV3088.Varchar04, AV3088.Varchar05, AV3088.DivisionID, AV3088.S01ID, AV3088.S02ID,
	AV3088.S03ID, AV3088.S04ID, AV3088.S05ID, AV3088.S06ID, AV3088.S07ID, AV3088.S08ID, AV3088.S09ID, AV3088.S10ID, AV3088.S11ID,
	AV3088.S12ID, AV3088.S13ID, AV3088.S14ID, AV3088.S15ID, AV3088.S16ID, AV3088.S17ID, AV3088.S18ID, AV3088.S19ID, AV3088.S20ID, AV3088.WareHouseID, AV3088.WareHouseName
	'
END --- theo ngay -------------------------------------------------------
PRINT (@sSQL1)
PRINT (@sSQL2)
EXEC(@sSQL1 + @sSQL2)

	SET @GroupField1 = 
	(
		SELECT CASE @GroupID1
			WHEN 'CI1' THEN 'S1'
			WHEN 'CI2' THEN 'S2'
			WHEN 'CI3' THEN 'S3'
			WHEN 'I01' THEN 'I01ID'
			WHEN 'I02' THEN 'I02ID'
			WHEN 'I03' THEN 'I03ID'
			WHEN 'I04' THEN 'I04ID'
			WHEN 'I05' THEN 'I05ID' 
		END
	)
	SET @GroupField2 = @GroupField1

	SET @GroupField2 = 
	(
		SELECT CASE @GroupID2
			WHEN 'CI1' THEN 'S1'
			WHEN 'CI2' THEN 'S2'
			WHEN 'CI3' THEN 'S3'
			WHEN 'I01' THEN 'I01ID'
			WHEN 'I02' THEN 'I02ID'
			WHEN 'I03' THEN 'I03ID'
			WHEN 'I04' THEN 'I04ID'
			WHEN 'I05' THEN 'I05ID' 
		END
	)

	SET @GroupField1 = ISNULL(@GroupField1, '')
	SET @GroupField2 = ISNULL(@GroupField2, '')
		        
	IF ((@IsGroupID = 1) AND (@GroupField1 <> '') AND (@GroupField2 <> ''))
	BEGIN
		SET @sSQL1 = N'
			SELECT V1.ID AS GroupID1, V2.ID AS GroupID2, V1.SName AS GroupName1, V2.SName AS GroupName2, AV3098.InventoryID,
			S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, AV3098.InventoryName, AV3098.UnitID, AV3098.UnitName, VATPercent,
			AV3098.InventoryTypeID, AV3098.Specification, AV3098.Notes01, AV3098.Notes02, AV3098.Notes03, AV3098.Varchar01,
			AV3098.Varchar02, AV3098.Varchar03, AV3098.Varchar04, AV3098.Varchar05, AV3098.ConversionUnitID, AV3098.ConversionFactor,
			AV3098.Operator, SUM(AV3098.BeginQuantity) AS BeginQuantity, SUM(AV3098.EndQuantity) AS EndQuantity,
			CASE WHEN AV3098.ConversionFactor = NULL OR AV3098.ConversionFactor = 0 THEN NULL ELSE ISNULL(SUM(AV3098.EndQuantity), 0) / AV3098.ConversionFactor END AS ConversionQuantity,
			SUM(AV3098.DebitQuantity) AS DebitQuantity, SUM(AV3098.CreditQuantity) AS CreditQuantity, SUM(AV3098.BeginAmount) AS BeginAmount, SUM(AV3098.EndAmount) AS EndAmount, 
			SUM(AV3098.DebitAmount) AS DebitAmount, SUM(AV3098.CreditAmount) AS CreditAmount, 
			SUM(AV3098.InDebitAmount) AS InDebitAmount, SUM(AV3098.InCreditAmount) AS InCreditAmount, SUM(AV3098.InDebitQuantity) AS InDebitQuantity, 
			SUM(AV3098.InCreditQuantity) AS InCreditQuantity, AV3098.DivisionID, AT1314.MinQuantity, AT1314.MaxQuantity,
			CASE WHEN (	SELECT SUM(ActualQuantity) FROM AT2007 WITH(NOLOCK)
						INNER JOIN AT2006 WITH(NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID And AT2007.VoucherID = AT2006.VoucherID 
						LEFT JOIN WT8899 W89 WITH (NOLOCK) ON AT2007.DivisionID = W89.DivisionID And AT2007.VoucherID = W89.VoucherID And AT2007.TransactionID = W89.TransactionID
						WHERE InventoryID = AV3098.InventoryID
						AND KindVoucherID IN (2,4,6)
						AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''')) = 0 THEN 0
			ELSE SUM(AV3098.EndQuantity)/
						((SELECT SUM(ActualQuantity) FROM AT2007 WITH(NOLOCK)
						INNER JOIN AT2006 WITH(NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID AND AT2007.VoucherID = AT2006.VoucherID 
						WHERE InventoryID = AV3098.InventoryID AND KindVoucherID IN (2,4,6)
						AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + '''))/3)
			END TimeOfUse,
			AV3098.S01ID, AV3098.S02ID, AV3098.S03ID, AV3098.S04ID, AV3098.S05ID, AV3098.S06ID, AV3098.S07ID, AV3098.S08ID, AV3098.S09ID, AV3098.S10ID,
			AV3098.S11ID, AV3098.S12ID, AV3098.S13ID, AV3098.S14ID, AV3098.S15ID, AV3098.S16ID, AV3098.S17ID, AV3098.S18ID, AV3098.S19ID, AV3098.S20ID,
			A01.StandardName AS StandardName01, A02.StandardName AS StandardName02, A03.StandardName AS StandardName03, A04.StandardName AS StandardName04, 
			A05.StandardName AS StandardName05, A06.StandardName AS StandardName06, A07.StandardName AS StandardName07, A08.StandardName AS StandardName08, 
			A09.StandardName AS StandardName09, A10.StandardName AS StandardName10, A11.StandardName AS StandardName11, A12.StandardName AS StandardName12,
			A13.StandardName AS StandardName13, A14.StandardName AS StandardName14, A15.StandardName AS StandardName15, A16.StandardName AS StandardName16,
			A17.StandardName AS StandardName17, A18.StandardName AS StandardName18, A19.StandardName AS StandardName19, A20.StandardName AS StandardName20,'

			SET @sSQL1a='
			a.S01, a.S02, a.S03, a.S04, a.S05, a.S06, a.S07, a.S08, a.S09, a.S10,
			a.S11, a.S12, a.S13, a.S14, a.S15, a.S16, a.S17, a.S18, a.S19, a.S20,
			AV3098.InventoryID + CASE WHEN ISNULL(AV3098.S01ID,'''')<>'''' THEN ''.''+AV3098.S01ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S02ID,'''')<>'''' THEN ''.''+AV3098.S02ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S03ID,'''')<>'''' THEN ''.''+AV3098.S03ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S04ID,'''')<>'''' THEN ''.''+AV3098.S04ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S05ID,'''')<>'''' THEN ''.''+AV3098.S05ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S06ID,'''')<>'''' THEN ''.''+AV3098.S06ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S07ID,'''')<>'''' THEN ''.''+AV3098.S07ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S08ID,'''')<>'''' THEN ''.''+AV3098.S08ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S09ID,'''')<>'''' THEN ''.''+AV3098.S09ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S10ID,'''')<>'''' THEN ''.''+AV3098.S10ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S11ID,'''')<>'''' THEN ''.''+AV3098.S11ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S12ID,'''')<>'''' THEN ''.''+AV3098.S12ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S13ID,'''')<>'''' THEN ''.''+AV3098.S13ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S14ID,'''')<>'''' THEN ''.''+AV3098.S14ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S15ID,'''')<>'''' THEN ''.''+AV3098.S15ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S16ID,'''')<>'''' THEN ''.''+AV3098.S16ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S17ID,'''')<>'''' THEN ''.''+AV3098.S17ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S18ID,'''')<>'''' THEN ''.''+AV3098.S18ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S19ID,'''')<>'''' THEN ''.''+AV3098.S19ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S20ID,'''')<>'''' THEN ''.''+AV3098.S20ID ELSE '''' END AS InventoryID_QC,
			N'''+@GroupID+''' AS GroupID, AT1401.GroupName, D03.WareHouseID, D03.WarehouseName'

		SET @sSQL2 = N'
			FROM ##AV3098 AV3098
			LEFT JOIN AT1303 AS D03 WITH (NOLOCK) ON D03.WareHouseID = AV3098.WareHouseID
			LEFT JOIN AV1310 V1 ON V1.ID = AV3098.' + @GroupField1 + ' AND V1.TypeID =''' + @GroupID1 + ''' 
			LEFT JOIN AV1310 V2 ON V2.ID = AV3098.' + @GroupField2 + ' AND V2.TypeID =''' + @GroupID2 + ''' 
			LEFT JOIN (	SELECT A.InventoryID, SUM(A.MinQuantity) AS MinQuantity, SUM(A.MaxQuantity) AS MaxQuantity, DivisionID,
						S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID, S11ID, S12ID, S13ID, S14ID, S15ID, 
						S16ID, S17ID, S18ID, S19ID, S20ID
						FROM AT1314 A WITH(NOLOCK) GROUP BY InventoryID, DivisionID, S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, 
						S08ID, S09ID, S10ID, S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID) AT1314
				ON AT1314.DivisionID IN (AV3098.DivisionID,''@@@'') AND AT1314.InventoryID = AV3098.InventoryID
				AND ISNULL(AV3098.S01ID,'''') = ISNULL(AT1314.S01ID,'''') AND ISNULL(AV3098.S02ID,'''') = ISNULL(AT1314.S02ID,'''')
				AND ISNULL(AV3098.S03ID,'''') = ISNULL(AT1314.S03ID,'''') AND ISNULL(AV3098.S04ID,'''') = ISNULL(AT1314.S04ID,'''')
				AND ISNULL(AV3098.S05ID,'''') = ISNULL(AT1314.S05ID,'''') AND ISNULL(AV3098.S06ID,'''') = ISNULL(AT1314.S06ID,'''')
				AND ISNULL(AV3098.S07ID,'''') = ISNULL(AT1314.S07ID,'''') AND ISNULL(AV3098.S08ID,'''') = ISNULL(AT1314.S08ID,'''') 
				AND ISNULL(AV3098.S09ID,'''') = ISNULL(AT1314.S09ID,'''') AND ISNULL(AV3098.S10ID,'''') = ISNULL(AT1314.S10ID,'''') 
				AND ISNULL(AV3098.S11ID,'''') = ISNULL(AT1314.S11ID,'''') AND ISNULL(AV3098.S12ID,'''') = ISNULL(AT1314.S12ID,'''') 
				AND ISNULL(AV3098.S13ID,'''') = ISNULL(AT1314.S13ID,'''') AND ISNULL(AV3098.S14ID,'''') = ISNULL(AT1314.S14ID,'''') 
				AND ISNULL(AV3098.S15ID,'''') = ISNULL(AT1314.S15ID,'''') AND ISNULL(AV3098.S16ID,'''') = ISNULL(AT1314.S16ID,'''') 
				AND ISNULL(AV3098.S17ID,'''') = ISNULL(AT1314.S17ID,'''') AND ISNULL(AV3098.S18ID,'''') = ISNULL(AT1314.S18ID,'''') 
				AND ISNULL(AV3098.S19ID,'''') = ISNULL(AT1314.S19ID,'''') AND ISNULL(AV3098.S20ID,'''') = ISNULL(AT1314.S20ID,'''')
			LEFT JOIN (SELECT * FROM  (SELECT UserName, TypeID, DivisionID
		            FROM AT0005 WITH (NOLOCK) WHERE TypeID LIKE ''S__'') b PIVOT (MAX(Username) for TypeID IN (S01, S02, S03, S04, S05, S06, S07, S08, S09, S10,
																								S11, S12, S13, S14, S15, S16, S17, S18, S19, S20))  AS a) a ON a.DivisionID = AV3098.DivisionID
			LEFT JOIN AT0128 A01 WITH (NOLOCK) ON AV3098.S01ID = A01.StandardID AND A01.StandardTypeID = ''S01''
			LEFT JOIN AT0128 A02 WITH (NOLOCK) ON AV3098.S02ID = A02.StandardID AND A02.StandardTypeID = ''S02''
			LEFT JOIN AT0128 A03 WITH (NOLOCK) ON AV3098.S03ID = A03.StandardID AND A03.StandardTypeID = ''S03''
			LEFT JOIN AT0128 A04 WITH (NOLOCK) ON AV3098.S04ID = A04.StandardID AND A04.StandardTypeID = ''S04''
			LEFT JOIN AT0128 A05 WITH (NOLOCK) ON AV3098.S05ID = A05.StandardID AND A05.StandardTypeID = ''S05''
			LEFT JOIN AT0128 A06 WITH (NOLOCK) ON AV3098.S06ID = A06.StandardID AND A06.StandardTypeID = ''S06''
			LEFT JOIN AT0128 A07 WITH (NOLOCK) ON AV3098.S07ID = A07.StandardID AND A07.StandardTypeID = ''S07''
			LEFT JOIN AT0128 A08 WITH (NOLOCK) ON AV3098.S08ID = A08.StandardID AND A08.StandardTypeID = ''S08''
			LEFT JOIN AT0128 A09 WITH (NOLOCK) ON AV3098.S09ID = A09.StandardID AND A09.StandardTypeID = ''S09''
			LEFT JOIN AT0128 A10 WITH (NOLOCK) ON AV3098.S10ID = A10.StandardID AND A10.StandardTypeID = ''S10'''

		SET @sSQL2a='
			LEFT JOIN AT0128 A11 WITH (NOLOCK) ON AV3098.S11ID = A11.StandardID AND A11.StandardTypeID = ''S11''
			LEFT JOIN AT0128 A12 WITH (NOLOCK) ON AV3098.S12ID = A12.StandardID AND A12.StandardTypeID = ''S12''
			LEFT JOIN AT0128 A13 WITH (NOLOCK) ON AV3098.S13ID = A13.StandardID AND A13.StandardTypeID = ''S13''
			LEFT JOIN AT0128 A14 WITH (NOLOCK) ON AV3098.S14ID = A14.StandardID AND A14.StandardTypeID = ''S14''
			LEFT JOIN AT0128 A15 WITH (NOLOCK) ON AV3098.S15ID = A15.StandardID AND A15.StandardTypeID = ''S15''
			LEFT JOIN AT0128 A16 WITH (NOLOCK) ON AV3098.S16ID = A16.StandardID AND A16.StandardTypeID = ''S16''
			LEFT JOIN AT0128 A17 WITH (NOLOCK) ON AV3098.S17ID = A17.StandardID AND A17.StandardTypeID = ''S17''
			LEFT JOIN AT0128 A18 WITH (NOLOCK) ON AV3098.S18ID = A18.StandardID AND A18.StandardTypeID = ''S18''
			LEFT JOIN AT0128 A19 WITH (NOLOCK) ON AV3098.S19ID = A19.StandardID AND A19.StandardTypeID = ''S19''
			LEFT JOIN AT0128 A20 WITH (NOLOCK) ON AV3098.S20ID = A20.StandardID AND A20.StandardTypeID = ''S20''
			LEFT JOIN AT1401 WITH (NOLOCK) ON AT1401.GroupID = N''' +@GroupID+ '''
			'

		SET @sSQL3 = '
			WHERE (BeginQuantity <> 0 OR BeginAmount <> 0 OR DebitQuantity <> 0 OR DebitAmount <> 0 OR
			CreditQuantity <> 0 OR CreditAmount <> 0 OR EndQuantity <> 0 OR EndAmount <> 0 )
			AND AV3098.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''')
			GROUP BY V1.ID, V2.ID, V1.SName, V2.SName, AV3098.InventoryID, S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, 
			AV3098.InventoryName, AV3098.UnitID, AV3098.UnitName, VATPercent, AV3098.InventoryTypeID, AV3098.Specification, 
			AV3098.Notes01, AV3098.Notes02, AV3098.Notes03, AV3098.Varchar01,AV3098.Varchar02,AV3098.Varchar03,AV3098.Varchar04,AV3098.Varchar05, 
			AV3098.ConversionUnitID, AV3098.ConversionFactor, AV3098.Operator, AV3098.DivisionID,  AT1314.MinQuantity, AT1314.MaxQuantity,
			AV3098.S01ID, AV3098.S02ID, AV3098.S03ID, AV3098.S04ID, AV3098.S05ID, AV3098.S06ID, AV3098.S07ID, AV3098.S08ID, AV3098.S09ID, AV3098.S10ID,
			AV3098.S11ID, AV3098.S12ID, AV3098.S13ID, AV3098.S14ID, AV3098.S15ID, AV3098.S16ID, AV3098.S17ID, AV3098.S18ID, AV3098.S19ID, AV3098.S20ID,
			A01.StandardName, A02.StandardName, A03.StandardName, A04.StandardName, A05.StandardName, A06.StandardName, A07.StandardName, A08.StandardName, 
			A09.StandardName, A10.StandardName, A11.StandardName, A12.StandardName, A13.StandardName, A14.StandardName, A15.StandardName, A16.StandardName,
			A17.StandardName, A18.StandardName, A19.StandardName, A20.StandardName, a.S01, a.S02, a.S03, a.S04, a.S05, a.S06, a.S07, a.S08, a.S09, a.S10,
			a.S11, a.S12, a.S13, a.S14, a.S15, a.S16, a.S17, a.S18, a.S19, a.S20, AT1401.GroupName, D03.WareHouseID, D03.WarehouseName
			'
	END 
	ELSE IF ((@IsGroupID = 1) AND ((@GroupField1 <> '') OR (@GroupField2 <> '')))
	BEGIN
		IF(@GroupField1 = '') SET @GroupField1 = @GroupField2
		IF(ISNULL(@GroupID1, '') = '') SET @GroupID1 = @GroupID2
		SET @sSQL1 = N'
			SELECT V1.ID AS GroupID1, '''' AS GroupID2, V1.SName AS GroupName1, '''' AS GroupName2, AV3098.InventoryID, S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID,
			AV3098.InventoryName, AV3098.UnitID, AV3098.UnitName, AV3098.VATPercent, AV3098.InventoryTypeID, AV3098.Specification,
			AV3098.Notes01, AV3098.Notes02, AV3098.Notes03, AV3098.Varchar01,AV3098.Varchar02,AV3098.Varchar03,AV3098.Varchar04,AV3098.Varchar05,
			AV3098.ConversionUnitID, AV3098.ConversionFactor, AV3098.Operator, AV3098.BeginQuantity, AV3098.EndQuantity,
			CASE WHEN AV3098.ConversionFactor = NULL OR AV3098.ConversionFactor = 0 THEN NULL
			ELSE ISNULL(AV3098.EndQuantity, 0) / AV3098.ConversionFactor END AS ConversionQuantity,
			AV3098.DebitQuantity, AV3098.CreditQuantity, AV3098.BeginAmount, AV3098.EndAmount,
			AV3098.DebitAmount, AV3098.CreditAmount, AV3098.InDebitAmount, AV3098.InCreditAmount, AV3098.InDebitQuantity,
			AV3098.InCreditQuantity, AV3098.DivisionID, AT1314.MinQuantity, AT1314.MaxQuantity,
			CASE WHEN (	SELECT SUM(ActualQuantity) FROM AT2007 WITH (NOLOCK)
						INNER JOIN AT2006 WITH (NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID And AT2007.VoucherID = AT2006.VoucherID 
						WHERE InventoryID = AV3098.InventoryID AND KindVoucherID IN (2,4,6)
						AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''')) = 0 THEN 0
			ELSE AV3098.EndQuantity/
						((SELECT SUM(ActualQuantity) FROM AT2007 WITH (NOLOCK)
						INNER JOIN AT2006 WITH (NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID And AT2007.VoucherID = AT2006.VoucherID
						WHERE InventoryID = AV3098.InventoryID
						AND KindVoucherID IN (2,4,6)
						AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + '''))/3)
			END TimeOfUse,
			AV3098.S01ID, AV3098.S02ID, AV3098.S03ID, AV3098.S04ID, AV3098.S05ID, AV3098.S06ID, AV3098.S07ID, AV3098.S08ID, AV3098.S09ID, AV3098.S10ID,
			AV3098.S11ID, AV3098.S12ID, AV3098.S13ID, AV3098.S14ID, AV3098.S15ID, AV3098.S16ID, AV3098.S17ID, AV3098.S18ID, AV3098.S19ID, AV3098.S20ID,
			A01.StandardName AS StandardName01, A02.StandardName AS StandardName02, A03.StandardName AS StandardName03, A04.StandardName AS StandardName04, 
			A05.StandardName AS StandardName05, A06.StandardName AS StandardName06, A07.StandardName AS StandardName07, A08.StandardName AS StandardName08, 
			A09.StandardName AS StandardName09, A10.StandardName AS StandardName10, A11.StandardName AS StandardName11, A12.StandardName AS StandardName12,
			A13.StandardName AS StandardName13, A14.StandardName AS StandardName14, A15.StandardName AS StandardName15, A16.StandardName AS StandardName16,
			A17.StandardName AS StandardName17, A18.StandardName AS StandardName18, A19.StandardName AS StandardName19, A20.StandardName AS StandardName20,'

			SET @sSQL1a='
			a.S01, a.S02, a.S03, a.S04, a.S05, a.S06, a.S07, a.S08, a.S09, a.S10,
			a.S11, a.S12, a.S13, a.S14, a.S15, a.S16, a.S17, a.S18, a.S19, a.S20,
			AV3098.InventoryID + CASE WHEN ISNULL(AV3098.S01ID,'''') <> '''' THEN ''.'' + AV3098.S01ID ELSE '''' END +
			CASE WHEN ISNULL(AV3098.S02ID,'''')<>'''' THEN ''.''+AV3098.S02ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S03ID,'''')<>'''' THEN ''.''+AV3098.S03ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S04ID,'''')<>'''' THEN ''.''+AV3098.S04ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S05ID,'''')<>'''' THEN ''.''+AV3098.S05ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S06ID,'''')<>'''' THEN ''.''+AV3098.S06ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S07ID,'''')<>'''' THEN ''.''+AV3098.S07ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S08ID,'''')<>'''' THEN ''.''+AV3098.S08ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S09ID,'''')<>'''' THEN ''.''+AV3098.S09ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S10ID,'''')<>'''' THEN ''.''+AV3098.S10ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S11ID,'''')<>'''' THEN ''.''+AV3098.S11ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S12ID,'''')<>'''' THEN ''.''+AV3098.S12ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S13ID,'''')<>'''' THEN ''.''+AV3098.S13ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S14ID,'''')<>'''' THEN ''.''+AV3098.S14ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S15ID,'''')<>'''' THEN ''.''+AV3098.S15ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S16ID,'''')<>'''' THEN ''.''+AV3098.S16ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S17ID,'''')<>'''' THEN ''.''+AV3098.S17ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S18ID,'''')<>'''' THEN ''.''+AV3098.S18ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S19ID,'''')<>'''' THEN ''.''+AV3098.S19ID ELSE '''' END+
			CASE WHEN ISNULL(AV3098.S20ID,'''')<>'''' THEN ''.''+AV3098.S20ID ELSE '''' END AS InventoryID_QC,
			N'''+@GroupID+''' AS GroupID, AT1401.GroupName, D03.WareHouseID, D03.WarehouseName
			'
	
		SET @sSQL2 = N'
			FROM ##AV3098 AV3098
			LEFT JOIN AT1303 AS D03 WITH (NOLOCK) ON D03.WareHouseID = AV3098.WareHouseID
			LEFT JOIN AV1310 V1 ON V1.ID = AV3098.' + @GroupField1 + ' AND V1.TypeID =''' + @GroupID1 + '''
			LEFT JOIN (	SELECT A.InventoryID, SUM(A.MinQuantity) AS MinQuantity, SUM(A.MaxQuantity) AS MaxQuantity, DivisionID,
						S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID, S11ID, S12ID, S13ID, S14ID, S15ID, 
						S16ID, S17ID, S18ID, S19ID, S20ID
						FROM AT1314 A WITH(NOLOCK) GROUP BY InventoryID, DivisionID, S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, 
						S08ID, S09ID, S10ID, S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID) AT1314
				ON AT1314.DivisionID IN (AV3098.DivisionID,''@@@'') AND AT1314.InventoryID = AV3098.InventoryID
				AND ISNULL(AV3098.S01ID,'''') = ISNULL(AT1314.S01ID,'''') AND ISNULL(AV3098.S02ID,'''') = ISNULL(AT1314.S02ID,'''')
				AND ISNULL(AV3098.S03ID,'''') = ISNULL(AT1314.S03ID,'''') AND ISNULL(AV3098.S04ID,'''') = ISNULL(AT1314.S04ID,'''')
				AND ISNULL(AV3098.S05ID,'''') = ISNULL(AT1314.S05ID,'''') AND ISNULL(AV3098.S06ID,'''') = ISNULL(AT1314.S06ID,'''')
				AND ISNULL(AV3098.S07ID,'''') = ISNULL(AT1314.S07ID,'''') AND ISNULL(AV3098.S08ID,'''') = ISNULL(AT1314.S08ID,'''') 
				AND ISNULL(AV3098.S09ID,'''') = ISNULL(AT1314.S09ID,'''') AND ISNULL(AV3098.S10ID,'''') = ISNULL(AT1314.S10ID,'''') 
				AND ISNULL(AV3098.S11ID,'''') = ISNULL(AT1314.S11ID,'''') AND ISNULL(AV3098.S12ID,'''') = ISNULL(AT1314.S12ID,'''') 
				AND ISNULL(AV3098.S13ID,'''') = ISNULL(AT1314.S13ID,'''') AND ISNULL(AV3098.S14ID,'''') = ISNULL(AT1314.S14ID,'''') 
				AND ISNULL(AV3098.S15ID,'''') = ISNULL(AT1314.S15ID,'''') AND ISNULL(AV3098.S16ID,'''') = ISNULL(AT1314.S16ID,'''') 
				AND ISNULL(AV3098.S17ID,'''') = ISNULL(AT1314.S17ID,'''') AND ISNULL(AV3098.S18ID,'''') = ISNULL(AT1314.S18ID,'''') 
				AND ISNULL(AV3098.S19ID,'''') = ISNULL(AT1314.S19ID,'''') AND ISNULL(AV3098.S20ID,'''') = ISNULL(AT1314.S20ID,'''')
			LEFT JOIN (SELECT * FROM  (SELECT UserName, TypeID, DivisionID
		            FROM AT0005 WITH (NOLOCK) WHERE TypeID LIKE ''S__'') b PIVOT (MAX(Username) for TypeID IN (S01, S02, S03, S04, S05, S06, S07, S08, S09, S10,
																								S11, S12, S13, S14, S15, S16, S17, S18, S19, S20))  AS a) a ON a.DivisionID = AV3098.DivisionID
			LEFT JOIN AT0128 A01 WITH (NOLOCK) ON AV3098.S01ID = A01.StandardID AND A01.StandardTypeID = ''S01''
			LEFT JOIN AT0128 A02 WITH (NOLOCK) ON AV3098.S02ID = A02.StandardID AND A02.StandardTypeID = ''S02''
			LEFT JOIN AT0128 A03 WITH (NOLOCK) ON AV3098.S03ID = A03.StandardID AND A03.StandardTypeID = ''S03''
			LEFT JOIN AT0128 A04 WITH (NOLOCK) ON AV3098.S04ID = A04.StandardID AND A04.StandardTypeID = ''S04''
			LEFT JOIN AT0128 A05 WITH (NOLOCK) ON AV3098.S05ID = A05.StandardID AND A05.StandardTypeID = ''S05''
			LEFT JOIN AT0128 A06 WITH (NOLOCK) ON AV3098.S06ID = A06.StandardID AND A06.StandardTypeID = ''S06''
			LEFT JOIN AT0128 A07 WITH (NOLOCK) ON AV3098.S07ID = A07.StandardID AND A07.StandardTypeID = ''S07''
			LEFT JOIN AT0128 A08 WITH (NOLOCK) ON AV3098.S08ID = A08.StandardID AND A08.StandardTypeID = ''S08''
			LEFT JOIN AT0128 A09 WITH (NOLOCK) ON AV3098.S09ID = A09.StandardID AND A09.StandardTypeID = ''S09''
			LEFT JOIN AT0128 A10 WITH (NOLOCK) ON AV3098.S10ID = A10.StandardID AND A10.StandardTypeID = ''S10'' '

		SET @sSQL2a = '
			LEFT JOIN AT0128 A11 WITH (NOLOCK) ON AV3098.S11ID = A11.StandardID AND A11.StandardTypeID = ''S11''
			LEFT JOIN AT0128 A12 WITH (NOLOCK) ON AV3098.S12ID = A12.StandardID AND A12.StandardTypeID = ''S12''
			LEFT JOIN AT0128 A13 WITH (NOLOCK) ON AV3098.S13ID = A13.StandardID AND A13.StandardTypeID = ''S13''
			LEFT JOIN AT0128 A14 WITH (NOLOCK) ON AV3098.S14ID = A14.StandardID AND A14.StandardTypeID = ''S14''
			LEFT JOIN AT0128 A15 WITH (NOLOCK) ON AV3098.S15ID = A15.StandardID AND A15.StandardTypeID = ''S15''
			LEFT JOIN AT0128 A16 WITH (NOLOCK) ON AV3098.S16ID = A16.StandardID AND A16.StandardTypeID = ''S16''
			LEFT JOIN AT0128 A17 WITH (NOLOCK) ON AV3098.S17ID = A17.StandardID AND A17.StandardTypeID = ''S17''
			LEFT JOIN AT0128 A18 WITH (NOLOCK) ON AV3098.S18ID = A18.StandardID AND A18.StandardTypeID = ''S18''
			LEFT JOIN AT0128 A19 WITH (NOLOCK) ON AV3098.S19ID = A19.StandardID AND A19.StandardTypeID = ''S19''
			LEFT JOIN AT0128 A20 WITH (NOLOCK) ON AV3098.S20ID = A20.StandardID AND A20.StandardTypeID = ''S20''	
			LEFT JOIN AT1401 WITH (NOLOCK) ON AT1401.GroupID = N''' +@GroupID+ '''
			WHERE (BeginQuantity <> 0 OR BeginAmount <> 0 OR DebitQuantity <> 0 OR DebitAmount <> 0 OR
			CreditQuantity <> 0 OR CreditAmount <> 0 OR EndQuantity <> 0 OR EndAmount <>0 )
			AND AV3098.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''')
			'

		SET @sSQL3 = ''
	END
		ELSE
			BEGIN
				SET @sSQL1 = N'
					SELECT '''' AS GroupID1, '''' AS GroupID2, '''' AS GroupName1, '''' AS GroupName2, AV3098.InventoryID, S1, S2, S3, I01ID, I02ID, I03ID, I04ID, I05ID, 
					AV3098.InventoryName, AV3098.UnitID, AV3098.UnitName, AV3098.VATPercent, AV3098.InventoryTypeID, Specification, AV3098.Notes01, AV3098.Notes02, AV3098.Notes03, 
					AV3098.Varchar01,AV3098.Varchar02,AV3098.Varchar03,AV3098.Varchar04,AV3098.Varchar05, AV3098.ConversionUnitID, AV3098.ConversionFactor, AV3098.Operator, 
					AV3098.BeginQuantity, AV3098.EndQuantity, CASE WHEN AV3098.ConversionFactor = NULL OR AV3098.ConversionFactor = 0 THEN NULL
					ELSE ISNULL(AV3098.EndQuantity, 0) / AV3098.ConversionFactor END AS ConversionQuantity, AV3098.DebitQuantity, AV3098.CreditQuantity, AV3098.BeginAmount, AV3098.EndAmount, 
					AV3098.DebitAmount, AV3098.CreditAmount, AV3098.InDebitAmount, AV3098.InCreditAmount, AV3098.InDebitQuantity, AV3098.InCreditQuantity, AV3098.DivisionID,
					AT1314.MinQuantity, AT1314.MaxQuantity, 
					CASE WHEN (	SELECT SUM(ActualQuantity) FROM AT2007 WITH(NOLOCK)
								INNER JOIN AT2006 WITH(NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID And AT2007.VoucherID = AT2006.VoucherID
								WHERE InventoryID = AV3098.InventoryID
								AND KindVoucherID IN (2,4,6)
								AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + ''')) = 0 THEN 0
					ELSE AV3098.EndQuantity/
								((SELECT SUM(ActualQuantity) FROM AT2007 WITH(NOLOCK)
								INNER JOIN AT2006 WITH(NOLOCK) ON AT2007.DivisionID = AT2006.DivisionID And AT2007.VoucherID = AT2006.VoucherID
								WHERE InventoryID = AV3098.InventoryID
								AND KindVoucherID IN (2,4,6)
								AND (CONCAT(AT2007.TranMonth, ''/'', AT2007.TranYear)) IN (''' + ISNULL(@PeriodList, '') + '''))/3)
					END TimeOfUse,
					AV3098.S01ID, AV3098.S02ID, AV3098.S03ID, AV3098.S04ID, AV3098.S05ID, AV3098.S06ID, AV3098.S07ID, AV3098.S08ID, AV3098.S09ID, AV3098.S10ID,
					AV3098.S11ID, AV3098.S12ID, AV3098.S13ID, AV3098.S14ID, AV3098.S15ID, AV3098.S16ID, AV3098.S17ID, AV3098.S18ID, AV3098.S19ID, AV3098.S20ID,
					A01.StandardName AS StandardName01, A02.StandardName AS StandardName02, A03.StandardName AS StandardName03, A04.StandardName AS StandardName04, 
					A05.StandardName AS StandardName05, A06.StandardName AS StandardName06, A07.StandardName AS StandardName07, A08.StandardName AS StandardName08, 
					A09.StandardName AS StandardName09, A10.StandardName AS StandardName10, A11.StandardName AS StandardName11, A12.StandardName AS StandardName12,
					A13.StandardName AS StandardName13, A14.StandardName AS StandardName14, A15.StandardName AS StandardName15, A16.StandardName AS StandardName16,
					A17.StandardName AS StandardName17, A18.StandardName AS StandardName18, A19.StandardName AS StandardName19, A20.StandardName AS StandardName20,'

					SET @sSQL1a='
					a.S01, a.S02, a.S03, a.S04, a.S05, a.S06, a.S07, a.S08, a.S09, a.S10, a.S11, a.S12, a.S13, a.S14, a.S15, a.S16, a.S17, a.S18, a.S19, a.S20,
					AV3098.InventoryID + CASE WHEN ISNULL(AV3098.S01ID,'''')<>'''' THEN ''.''+AV3098.S01ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S02ID,'''')<>'''' THEN ''.''+AV3098.S02ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S03ID,'''')<>'''' THEN ''.''+AV3098.S03ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S04ID,'''')<>'''' THEN ''.''+AV3098.S04ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S05ID,'''')<>'''' THEN ''.''+AV3098.S05ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S06ID,'''')<>'''' THEN ''.''+AV3098.S06ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S07ID,'''')<>'''' THEN ''.''+AV3098.S07ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S08ID,'''')<>'''' THEN ''.''+AV3098.S08ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S09ID,'''')<>'''' THEN ''.''+AV3098.S09ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S10ID,'''')<>'''' THEN ''.''+AV3098.S10ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S11ID,'''')<>'''' THEN ''.''+AV3098.S11ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S12ID,'''')<>'''' THEN ''.''+AV3098.S12ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S13ID,'''')<>'''' THEN ''.''+AV3098.S13ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S14ID,'''')<>'''' THEN ''.''+AV3098.S14ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S15ID,'''')<>'''' THEN ''.''+AV3098.S15ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S16ID,'''')<>'''' THEN ''.''+AV3098.S16ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S17ID,'''')<>'''' THEN ''.''+AV3098.S17ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S18ID,'''')<>'''' THEN ''.''+AV3098.S18ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S19ID,'''')<>'''' THEN ''.''+AV3098.S19ID ELSE '''' END+
					CASE WHEN ISNULL(AV3098.S20ID,'''')<>'''' THEN ''.''+AV3098.S20ID ELSE '''' END AS InventoryID_QC,
					N'''+@GroupID+''' AS GroupID, AT1401.GroupName, AV3098.WarehouseID, AV3098.WarehouseName
					'

					SET @sSQL2 = N'
					FROM ##AV3098 AV3098 
					LEFT JOIN (	SELECT A.InventoryID, SUM(A.MinQuantity) AS MinQuantity, SUM(A.MaxQuantity) AS MaxQuantity, DivisionID
								FROM AT1314 A WITH(NOLOCK) GROUP BY InventoryID, DivisionID ) AT1314
						ON AT1314.DivisionID IN (AV3098.DivisionID,''@@@'') AND AT1314.InventoryID = AV3098.InventoryID
					LEFT JOIN (SELECT * FROM  (SELECT UserName, TypeID, DivisionID
		                   FROM AT0005 WITH (NOLOCK) WHERE TypeID LIKE ''S__'') b PIVOT (MAX(Username) for TypeID IN (S01, S02, S03, S04, S05, S06, S07, S08, S09, S10,
																										S11, S12, S13, S14, S15, S16, S17, S18, S19, S20))  AS a) a ON a.DivisionID = AV3098.DivisionID
					LEFT JOIN AT0128 A01 WITH (NOLOCK) ON AV3098.S01ID = A01.StandardID AND A01.StandardTypeID = ''S01''
					LEFT JOIN AT0128 A02 WITH (NOLOCK) ON AV3098.S02ID = A02.StandardID AND A02.StandardTypeID = ''S02''
					LEFT JOIN AT0128 A03 WITH (NOLOCK) ON AV3098.S03ID = A03.StandardID AND A03.StandardTypeID = ''S03''
					LEFT JOIN AT0128 A04 WITH (NOLOCK) ON AV3098.S04ID = A04.StandardID AND A04.StandardTypeID = ''S04''
					LEFT JOIN AT0128 A05 WITH (NOLOCK) ON AV3098.S05ID = A05.StandardID AND A05.StandardTypeID = ''S05''
					LEFT JOIN AT0128 A06 WITH (NOLOCK) ON AV3098.S06ID = A06.StandardID AND A06.StandardTypeID = ''S06''
					LEFT JOIN AT0128 A07 WITH (NOLOCK) ON AV3098.S07ID = A07.StandardID AND A07.StandardTypeID = ''S07''
					LEFT JOIN AT0128 A08 WITH (NOLOCK) ON AV3098.S08ID = A08.StandardID AND A08.StandardTypeID = ''S08''
					LEFT JOIN AT0128 A09 WITH (NOLOCK) ON AV3098.S09ID = A09.StandardID AND A09.StandardTypeID = ''S09''
					LEFT JOIN AT0128 A10 WITH (NOLOCK) ON AV3098.S10ID = A10.StandardID AND A10.StandardTypeID = ''S10'''

				SET @sSQL2a='
					LEFT JOIN AT0128 A11 WITH (NOLOCK) ON AV3098.S11ID = A11.StandardID AND A11.StandardTypeID = ''S11''
					LEFT JOIN AT0128 A12 WITH (NOLOCK) ON AV3098.S12ID = A12.StandardID AND A12.StandardTypeID = ''S12''
					LEFT JOIN AT0128 A13 WITH (NOLOCK) ON AV3098.S13ID = A13.StandardID AND A13.StandardTypeID = ''S13''
					LEFT JOIN AT0128 A14 WITH (NOLOCK) ON AV3098.S14ID = A14.StandardID AND A14.StandardTypeID = ''S14''
					LEFT JOIN AT0128 A15 WITH (NOLOCK) ON AV3098.S15ID = A15.StandardID AND A15.StandardTypeID = ''S15''
					LEFT JOIN AT0128 A16 WITH (NOLOCK) ON AV3098.S16ID = A16.StandardID AND A16.StandardTypeID = ''S16''
					LEFT JOIN AT0128 A17 WITH (NOLOCK) ON AV3098.S17ID = A17.StandardID AND A17.StandardTypeID = ''S17''
					LEFT JOIN AT0128 A18 WITH (NOLOCK) ON AV3098.S18ID = A18.StandardID AND A18.StandardTypeID = ''S18''
					LEFT JOIN AT0128 A19 WITH (NOLOCK) ON AV3098.S19ID = A19.StandardID AND A19.StandardTypeID = ''S19''
					LEFT JOIN AT0128 A20 WITH (NOLOCK) ON AV3098.S20ID = A20.StandardID AND A20.StandardTypeID = ''S20''	
					LEFT JOIN AT1401 WITH (NOLOCK) ON AT1401.GroupID = N''' +@GroupID+ '''
					WHERE (BeginQuantity <> 0 OR BeginAmount <> 0 OR DebitQuantity <> 0 OR DebitAmount <> 0 OR
					CreditQuantity <> 0 OR CreditAmount <> 0 OR EndQuantity <> 0 OR EndAmount <> 0 )
					AND AV3098.DivisionID IN (''' + IIF(ISNULL(@DivisionIDList, '') != '', @DivisionIDList, @DivisionID) + ''')
					'

				SET @sSQL3 = ''
			END

		SET @sSQL4 = N''

		PRINT ('--@sSQL1'+
		@sSQL1)
		PRINT ('--@sSQL1a'+
		@sSQL1a)
		PRINT ('--@sSQL2'+
		@sSQL2)
		PRINT ('--@sSQL2a'+
		@sSQL2a)
		PRINT ('--@sSQL3'+
		@sSQL3)
		PRINT ('--@sSQL4'+
		@sSQL4)
		 
		EXEC(@sSQL1 + @sSQL1a + @sSQL2 + @sSQL2a + @sSQL3 + @sSQL4)

		

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
