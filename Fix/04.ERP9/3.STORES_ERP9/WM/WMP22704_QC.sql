IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[WMP22704_QC]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[WMP22704_QC]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO





-- <Summary>
---- Xử lý tồn kho khi kết chuyển - kế thừa từ store AP9998_QC
-- <Param>
----
-- <Return>
----
-- <History>
---- Created by: Hoài Bảo on 20/07/2022
---- Modified by: Hoài Bảo on 02/12/2022 - Bổ sung insert người cập nhật, ngày cập nhật, lịch sử
---- Modified by: Hoài Bảo on 20/02/2023 - WareHouseID truyền vào theo danh sách
---- Modified by ... on ...

-- <Example>


CREATE PROCEDURE [dbo].[WMP22704_QC]
(
	@DivisionID NVARCHAR(50),
	@UserID NVARCHAR(50),
	@WareHouseID NVARCHAR(50),
	@TranMonth INT,
	@TranYear INT,
	@NextMonth INT,
	@NextYear INT
)
 AS

DECLARE
	@PeriodMonthBegin INT,
	@PeriodYearBegin INT

SELECT TOP 1  @PeriodMonthBegin = TranMonth, @PeriodYearBegin = TranYear FROM WT9999 WITH (NOLOCK) WHERE DivisionID = @DivisionID
ORDER BY TranYear, TranMonth ASC

--- Tạo bảng tạm thay cho view AV2222
  IF EXISTS (SELECT * FROM tempdb.dbo.sysobjects WHERE ID = OBJECT_ID(N'tempdb.dbo.#TAM'))
	DROP TABLE #TAM

  SELECT (CASE WHEN DE.DivisionID IS NULL THEN CE.DivisionID ELSE DE.DivisionID END) AS DivisionID,
	 (CASE WHEN DE.TranMonth IS NULL THEN CE.TranMonth ELSE DE.TranMonth END) AS TranMonth,
	 (CASE WHEN DE.TranYear IS NULL THEN CE.TranYear ELSE DE.TranYear END) AS TranYear,
	 (CASE WHEN DE.WareHouseID IS NULL THEN CE.WareHouseID ELSE DE.WareHouseID END) AS WareHouseID,
	 (CASE WHEN DE.InventoryID IS NULL THEN CE.InventoryID ELSE DE.InventoryID END) AS InventoryID,
	 (CASE WHEN DE.InventoryAccountID IS NULL THEN CE.InventoryAccountID ELSE DE.InventoryAccountID END) AS InventoryAccountID,
	 BeginQuantity,
	 BeginAmount,
	 DebitQuantity,
	 DebitAmount,
	 InDebitQuantity,
	 InDebitAmount,
	 CE.Quantity AS CreditQuantity,
	 CE.Amount AS CreditAmount,
	 CE.InQuantity AS InCreditQuantity,
	 CE.InAmount AS InCreditAmount,
	 ISNULL(CE.S01ID,DE.S01ID) AS S01ID, ISNULL(CE.S02ID,DE.S02ID) AS S02ID, ISNULL(CE.S03ID,DE.S03ID) AS S03ID, ISNULL(CE.S04ID,DE.S04ID) AS S04ID, ISNULL(CE.S05ID,DE.S05ID) AS S05ID, 
	 ISNULL(CE.S06ID,DE.S06ID) AS S06ID, ISNULL(CE.S07ID,DE.S07ID) AS S07ID, ISNULL(CE.S08ID,DE.S08ID) AS S08ID, ISNULL(CE.S09ID,DE.S09ID) AS S09ID, ISNULL(CE.S10ID,DE.S10ID) AS S10ID, 
	 ISNULL(CE.S11ID,DE.S11ID) AS S11ID, ISNULL(CE.S12ID,DE.S12ID) AS S12ID, ISNULL(CE.S13ID,DE.S13ID) AS S13ID, ISNULL(CE.S14ID,DE.S14ID) AS S14ID, ISNULL(CE.S15ID,DE.S15ID) AS S15ID, 
	 ISNULL(CE.S16ID,DE.S16ID) AS S16ID, ISNULL(CE.S17ID,DE.S17ID) AS S17ID, ISNULL(CE.S18ID,DE.S18ID) AS S18ID, ISNULL(CE.S19ID,DE.S19ID) AS S19ID, ISNULL(CE.S20ID,DE.S20ID) AS S20ID	
INTO #TAM
FROM
--Nhap + So du
(SELECT (CASE WHEN BE.DivisionID IS NULL THEN DE.DivisionID ELSE BE.DivisionID END) AS DivisionID,
	(CASE WHEN BE.TranMonth IS NULL THEN DE.TranMonth ELSE BE.TranMonth END) AS TranMonth,
	(CASE WHEN BE.TranYear IS NULL THEN DE.TranYear ELSE BE.TranYear END) AS TranYear,
	(CASE WHEN BE.WareHouseID IS NULL THEN DE.WareHouseID ELSE BE.WareHouseID END) AS WareHouseID,
	(CASE WHEN BE.InventoryID IS NULL THEN DE.InventoryID ELSE BE.InventoryID END) AS InventoryID,
	(CASE WHEN BE.InventoryAccountID IS NULL THEN DE.InventoryAccountID ELSE BE.InventoryAccountID END) AS InventoryAccountID,
	BE.Quantity AS BeginQuantity, 
	BE.Amount AS BeginAmount, 
	DE.Quantity AS DebitQuantity, 
	DE.Amount AS DebitAmount,
	DE.InQuantity AS InDebitQuantity,
	DE.InAmount AS InDebitAmount,
	ISNULL(DE.S01ID,BE.S01ID) AS S01ID, ISNULL(DE.S02ID,BE.S02ID) AS S02ID, ISNULL(DE.S03ID,BE.S03ID) AS S03ID, ISNULL(DE.S04ID,BE.S04ID) AS S04ID, ISNULL(DE.S05ID,BE.S05ID) AS S05ID,
	ISNULL(DE.S06ID,BE.S06ID) AS S06ID, ISNULL(DE.S07ID,BE.S07ID) AS S07ID, ISNULL(DE.S08ID,BE.S08ID) AS S08ID, ISNULL(DE.S09ID,BE.S09ID) AS S09ID, ISNULL(DE.S10ID,BE.S10ID) AS S10ID,
	ISNULL(DE.S11ID,BE.S11ID) AS S11ID, ISNULL(DE.S12ID,BE.S12ID) AS S12ID, ISNULL(DE.S13ID,BE.S13ID) AS S13ID, ISNULL(DE.S14ID,BE.S14ID) AS S14ID, ISNULL(DE.S15ID,BE.S15ID) AS S15ID,
	ISNULL(DE.S16ID,BE.S16ID) AS S16ID, ISNULL(DE.S17ID,BE.S17ID) AS S17ID, ISNULL(DE.S18ID,BE.S18ID) AS S18ID, ISNULL(DE.S19ID,BE.S19ID) AS S19ID, ISNULL(DE.S20ID,BE.S20ID) AS S20ID
FROM
--So du dau
(SELECT T16.DivisionID,T16.TranMonth,T16.TranYear,T16.WareHouseID,T17.InventoryID,T17.DebitAccountID AS InventoryAccountID,
	  ISNULL(SUM(ISNULL(T17.ActualQuantity,0)),0) AS Quantity, 
	  ISNULL(SUM(ISNULL(T17.ConvertedAmount,0)),0) AS Amount,
	  O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	  O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID 
FROM AT2017 T17 WITH (NOLOCK) LEFT JOIN AT2016 T16 WITH (NOLOCK) ON T16.VoucherID = T17.VoucherID AND T16.DivisionID = T17.DivisionID
	LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = T17.DivisionID AND O99.VoucherID = T17.VoucherID AND O99.TransactionID = T17.TransactionID
WHERE T16.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ',')) OR T16.WareHouseID IS NULL
GROUP BY T16.DivisionID,T16.TranMonth,T16.TranYear,WareHouseID,InventoryID,DebitAccountID,
O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID) AS BE

FULL JOIN
--Nhap kho
(SELECT T16.DivisionID,T16.TranMonth,T16.TranYear,T16.WareHouseID,T17.InventoryID,T17.DebitAccountID AS InventoryAccountID,
	  ISNULL(SUM(ISNULL(T17.ActualQuantity,0)),0) AS Quantity, 
	  ISNULL(SUM(ISNULL(T17.ConvertedAmount,0)),0) AS Amount,
	  ISNULL(SUM(CASE WHEN T16.KindVoucherID = 3 THEN ISNULL(T17.ActualQuantity,0) ELSE 0 END),0) AS InQuantity, 
	  ISNULL(SUM(CASE WHEN T16.KindVoucherID = 3 THEN ISNULL(T17.ConvertedAmount,0) ELSE 0 END),0) AS InAmount,
	  O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	  O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID  
FROM AT2007 T17 WITH (NOLOCK) LEFT JOIN AT2006 T16 WITH (NOLOCK) ON T16.VoucherID = T17.VoucherID AND T16.DivisionID = T17.DivisionID
	LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = T17.DivisionID AND O99.VoucherID = T17.VoucherID AND O99.TransactionID = T17.TransactionID
WHERE KindVoucherID in (1,3,5,7,9,15,17) AND (T16.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ',')) OR T16.WareHouseID IS NULL)
GROUP BY T16.DivisionID,T16.TranMonth,T16.TranYear,WareHouseID,InventoryID,DebitAccountID,
O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID) AS DE
ON 
BE.DivisionID = DE.DivisionID 
AND BE.TranMonth = DE.TranMonth 
AND BE.TranYear = DE.TranYear
AND BE.WareHouseID = DE.WareHouseID
AND BE.InventoryID = DE.InventoryID
AND BE.InventoryAccountID = DE.InventoryAccountID AND 
ISNULL(BE.S01ID,'') = ISNULL(DE.S01ID,'') AND 
ISNULL(BE.S02ID,'') = ISNULL(DE.S02ID,'') AND
ISNULL(BE.S03ID,'') = ISNULL(DE.S03ID,'') AND
ISNULL(BE.S04ID,'') = ISNULL(DE.S04ID,'') AND
ISNULL(BE.S05ID,'') = ISNULL(DE.S05ID,'') AND 
ISNULL(BE.S06ID,'') = ISNULL(DE.S06ID,'') AND
ISNULL(BE.S07ID,'') = ISNULL(DE.S07ID,'') AND
ISNULL(BE.S08ID,'') = ISNULL(DE.S08ID,'') AND
ISNULL(BE.S09ID,'') = ISNULL(DE.S09ID,'') AND
ISNULL(BE.S10ID,'') = ISNULL(DE.S10ID,'') AND
ISNULL(BE.S11ID,'') = ISNULL(DE.S11ID,'') AND 
ISNULL(BE.S12ID,'') = ISNULL(DE.S12ID,'') AND
ISNULL(BE.S13ID,'') = ISNULL(DE.S13ID,'') AND
ISNULL(BE.S14ID,'') = ISNULL(DE.S14ID,'') AND
ISNULL(BE.S15ID,'') = ISNULL(DE.S15ID,'') AND
ISNULL(BE.S16ID,'') = ISNULL(DE.S16ID,'') AND
ISNULL(BE.S17ID,'') = ISNULL(DE.S17ID,'') AND
ISNULL(BE.S18ID,'') = ISNULL(DE.S18ID,'') AND
ISNULL(BE.S19ID,'') = ISNULL(DE.S19ID,'') AND
ISNULL(BE.S20ID,'') = ISNULL(DE.S20ID,'')
) AS DE

FULL JOIN
--Xuat kho
(SELECT T16.DivisionID,T16.TranMonth,T16.TranYear,(CASE WHEN KindVoucherID = 3 THEN T16.WareHouseID2 ELSE T16.WareHouseID END) AS WareHouseID,T17.InventoryID,T17.CreditAccountID AS InventoryAccountID,
	  ISNULL(SUM(ISNULL(T17.ActualQuantity,0)),0) AS Quantity, 
	  ISNULL(SUM(ISNULL(T17.ConvertedAmount,0)),0) AS Amount,
	  ISNULL(SUM(CASE WHEN T16.KindVoucherID = 3 THEN ISNULL(T17.ActualQuantity,0) ELSE 0 END),0) AS InQuantity, 
	  ISNULL(SUM(CASE WHEN T16.KindVoucherID = 3 THEN ISNULL(T17.ConvertedAmount,0) ELSE 0 END),0) AS InAmount,
	  O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
	  O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID  
FROM AT2007 T17 WITH (NOLOCK) LEFT JOIN AT2006 T16 WITH (NOLOCK) ON T16.VoucherID = T17.VoucherID AND T16.DivisionID = T17.DivisionID
	LEFT JOIN WT8899 O99 WITH (NOLOCK) ON O99.DivisionID = T17.DivisionID AND O99.VoucherID = T17.VoucherID AND O99.TransactionID = T17.TransactionID
WHERE KindVoucherID in (2,3,4,6,8,10,14,20) AND (T16.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ',')) OR T16.WareHouseID IS NULL)
GROUP BY T16.DivisionID,T16.TranMonth,T16.TranYear,(CASE WHEN KindVoucherID = 3 THEN T16.WareHouseID2 ELSE T16.WareHouseID END),InventoryID,CreditAccountID,
O99.S01ID, O99.S02ID, O99.S03ID, O99.S04ID, O99.S05ID, O99.S06ID, O99.S07ID, O99.S08ID, O99.S09ID, O99.S10ID,
O99.S11ID, O99.S12ID, O99.S13ID, O99.S14ID, O99.S15ID, O99.S16ID, O99.S17ID, O99.S18ID, O99.S19ID, O99.S20ID) AS CE
ON
DE.DivisionID = CE.DivisionID 
AND DE.TranMonth = CE.TranMonth 
AND DE.TranYear = CE.TranYear
AND DE.WareHouseID = CE.WareHouseID
AND DE.InventoryID = CE.InventoryID
AND DE.InventoryAccountID = CE.InventoryAccountID AND 
ISNULL(DE.S01ID,'') = ISNULL(CE.S01ID,'') AND 
ISNULL(DE.S02ID,'') = ISNULL(CE.S02ID,'') AND
ISNULL(DE.S03ID,'') = ISNULL(CE.S03ID,'') AND
ISNULL(DE.S04ID,'') = ISNULL(CE.S04ID,'') AND
ISNULL(DE.S05ID,'') = ISNULL(CE.S05ID,'') AND 
ISNULL(DE.S06ID,'') = ISNULL(CE.S06ID,'') AND
ISNULL(DE.S07ID,'') = ISNULL(CE.S07ID,'') AND
ISNULL(DE.S08ID,'') = ISNULL(CE.S08ID,'') AND
ISNULL(DE.S09ID,'') = ISNULL(CE.S09ID,'') AND
ISNULL(DE.S10ID,'') = ISNULL(CE.S10ID,'') AND
ISNULL(DE.S11ID,'') = ISNULL(CE.S11ID,'') AND 
ISNULL(DE.S12ID,'') = ISNULL(CE.S12ID,'') AND
ISNULL(DE.S13ID,'') = ISNULL(CE.S13ID,'') AND
ISNULL(DE.S14ID,'') = ISNULL(CE.S14ID,'') AND
ISNULL(DE.S15ID,'') = ISNULL(CE.S15ID,'') AND
ISNULL(DE.S16ID,'') = ISNULL(CE.S16ID,'') AND
ISNULL(DE.S17ID,'') = ISNULL(CE.S17ID,'') AND
ISNULL(DE.S18ID,'') = ISNULL(CE.S18ID,'') AND
ISNULL(DE.S19ID,'') = ISNULL(CE.S19ID,'') AND
ISNULL(DE.S20ID,'') = ISNULL(CE.S20ID,'')

INSERT INTO AT2008_QC (DivisionID, TranMonth, TranYear, WareHouseID, InventoryID, InventoryAccountID, 
			BeginQuantity, BeginAmount, 
			DebitQuantity, DebitAmount,
			InDebitQuantity, InDebitAmount,
			CreditQuantity, CreditAmount,
			InCreditQuantity, InCreditAmount,
			EndQuantity, EndAmount, S01ID, S02ID,S03ID,S04ID,S05ID, S06ID, S07ID, S08ID, S09ID,S10ID,
			S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID,S18ID,S19ID,S20ID, CreateUserID, CreateDate, LastModifyUserID, LastModifyDate)
SELECT V.DivisionID, V.TranMonth, V.TranYear, V.WareHouseID, V.InventoryID, V.InventoryAccountID,
	   ISNULL(V.BeginQuantity,0), ISNULL(V.BeginAmount,0), 
	   ISNULL(V.DebitQuantity,0), ISNULL(V.DebitAmount,0),
	   ISNULL(V.InDebitQuantity,0), ISNULL(V.InDebitAmount,0),
	   ISNULL(V.CreditQuantity,0), ISNULL(V.CreditAmount,0),
	   ISNULL(V.InCreditQuantity,0), ISNULL(V.InCreditAmount,0),
	   ISNULL(V.BeginQuantity,0) + ISNULL(V.DebitQuantity,0) - ISNULL(V.CreditQuantity,0),
	   ISNULL(V.BeginAmount,0) + ISNULL(V.DebitAmount,0) - ISNULL(V.CreditAmount,0), V.S01ID, V.S02ID,V.S03ID,V.S04ID,V.S05ID, V.S06ID, V.S07ID, V.S08ID, V.S09ID, V.S10ID,
	   V.S11ID, V.S12ID, V.S13ID, V.S14ID, V.S15ID, V.S16ID, V.S17ID, V.S18ID, V.S19ID, V.S20ID, @UserID, GETDATE(), @UserID, GETDATE()
FROM AT2008_QC A WITH (NOLOCK) RIGHT JOIN #TAM V
ON 	A.DivisionID = V.DivisionID AND
	A.WareHouseID = V.WareHouseID AND
	A.InventoryID = V.InventoryID AND
	A.InventoryAccountID = V.InventoryAccountID AND
	A.TranMonth = V.TranMonth AND
	A.TranYear = V.TranYear AND 
	ISNULL(A.S01ID,'') = ISNULL(V.S01ID,'') AND 
	ISNULL(A.S02ID,'') = ISNULL(V.S02ID,'') AND
	ISNULL(A.S03ID,'') = ISNULL(V.S03ID,'') AND
	ISNULL(A.S04ID,'') = ISNULL(V.S04ID,'') AND
	ISNULL(A.S05ID,'') = ISNULL(V.S05ID,'') AND 
	ISNULL(A.S06ID,'') = ISNULL(V.S06ID,'') AND
	ISNULL(A.S07ID,'') = ISNULL(V.S07ID,'') AND
	ISNULL(A.S08ID,'') = ISNULL(V.S08ID,'') AND
	ISNULL(A.S09ID,'') = ISNULL(V.S09ID,'') AND
	ISNULL(A.S10ID,'') = ISNULL(V.S10ID,'') AND
	ISNULL(A.S11ID,'') = ISNULL(V.S11ID,'') AND 
	ISNULL(A.S12ID,'') = ISNULL(V.S12ID,'') AND
	ISNULL(A.S13ID,'') = ISNULL(V.S13ID,'') AND
	ISNULL(A.S14ID,'') = ISNULL(V.S14ID,'') AND
	ISNULL(A.S15ID,'') = ISNULL(V.S15ID,'') AND
	ISNULL(A.S16ID,'') = ISNULL(V.S16ID,'') AND
	ISNULL(A.S17ID,'') = ISNULL(V.S17ID,'') AND
	ISNULL(A.S18ID,'') = ISNULL(V.S18ID,'') AND
	ISNULL(A.S19ID,'') = ISNULL(V.S19ID,'') AND
	ISNULL(A.S20ID,'') = ISNULL(V.S20ID,'')
WHERE A.DivisionID IS NULL AND
	A.WareHouseID IS NULL AND
	A.InventoryID IS NULL AND
	A.InventoryAccountID IS NULL AND
	V.InventoryAccountID IS NOT NULL AND
	A.TranMonth IS NULL AND
	A.TranYear IS NULL AND
	V.DivisionID = @DivisionID AND
	V.TranMonth = @TranMonth AND
	V.TranYear = @TranYear

--Xoa Du lieu rac
DELETE AT2008_QC
FROM AT2008_QC A LEFT JOIN #TAM V
ON 	A.DivisionID = V.DivisionID AND
	A.WareHouseID = V.WareHouseID AND
	A.InventoryID = V.InventoryID AND
	A.InventoryAccountID = V.InventoryAccountID AND
	ISNULL(A.S01ID,'') = ISNULL(V.S01ID,'') AND 
	ISNULL(A.S02ID,'') = ISNULL(V.S02ID,'') AND
	ISNULL(A.S03ID,'') = ISNULL(V.S03ID,'') AND
	ISNULL(A.S04ID,'') = ISNULL(V.S04ID,'') AND
	ISNULL(A.S05ID,'') = ISNULL(V.S05ID,'') AND 
	ISNULL(A.S06ID,'') = ISNULL(V.S06ID,'') AND
	ISNULL(A.S07ID,'') = ISNULL(V.S07ID,'') AND
	ISNULL(A.S08ID,'') = ISNULL(V.S08ID,'') AND
	ISNULL(A.S09ID,'') = ISNULL(V.S09ID,'') AND
	ISNULL(A.S10ID,'') = ISNULL(V.S10ID,'') AND
	ISNULL(A.S11ID,'') = ISNULL(V.S11ID,'') AND 
	ISNULL(A.S12ID,'') = ISNULL(V.S12ID,'') AND
	ISNULL(A.S13ID,'') = ISNULL(V.S13ID,'') AND
	ISNULL(A.S14ID,'') = ISNULL(V.S14ID,'') AND
	ISNULL(A.S15ID,'') = ISNULL(V.S15ID,'') AND
	ISNULL(A.S16ID,'') = ISNULL(V.S16ID,'') AND
	ISNULL(A.S17ID,'') = ISNULL(V.S17ID,'') AND
	ISNULL(A.S18ID,'') = ISNULL(V.S18ID,'') AND
	ISNULL(A.S19ID,'') = ISNULL(V.S19ID,'') AND
	ISNULL(A.S20ID,'') = ISNULL(V.S20ID,'')
WHERE V.DivisionID IS NULL AND
	V.WareHouseID IS NULL AND
	V.InventoryID IS NULL AND
	V.InventoryAccountID IS NULL AND
	V.TranMonth + V.TranYear*12 <= @TranMonth + @TranYear*12 AND
	A.TranMonth + A.TranYear*12 <= @TranMonth + @TranYear*12

IF (@PeriodMonthBegin = @TranMonth AND @PeriodYearBegin = @TranYear)
BEGIN
	UPDATE A
	SET
		A.BeginQuantity = ISNULL(V.BeginQuantity,0),
		A.BeginAmount = ISNULL(V.BeginAmount,0),
		A.LastModifyUserID = @UserID,
		A.LastModifyDate = GETDATE()
	FROM AT2008_QC A WITH (NOLOCK) LEFT JOIN #TAM V
	ON 	A.DivisionID = V.DivisionID AND
		A.WareHouseID = V.WareHouseID AND
		A.InventoryID = V.InventoryID AND
		A.InventoryAccountID = V.InventoryAccountID AND
		A.TranMonth = V.TranMonth AND
		A.TranYear = V.TranYear AND
		ISNULL(A.S01ID,'') = ISNULL(V.S01ID,'') AND 
		ISNULL(A.S02ID,'') = ISNULL(V.S02ID,'') AND
		ISNULL(A.S03ID,'') = ISNULL(V.S03ID,'') AND
		ISNULL(A.S04ID,'') = ISNULL(V.S04ID,'') AND
		ISNULL(A.S05ID,'') = ISNULL(V.S05ID,'') AND 
		ISNULL(A.S06ID,'') = ISNULL(V.S06ID,'') AND
		ISNULL(A.S07ID,'') = ISNULL(V.S07ID,'') AND
		ISNULL(A.S08ID,'') = ISNULL(V.S08ID,'') AND
		ISNULL(A.S09ID,'') = ISNULL(V.S09ID,'') AND
		ISNULL(A.S10ID,'') = ISNULL(V.S10ID,'') AND
		ISNULL(A.S11ID,'') = ISNULL(V.S11ID,'') AND 
		ISNULL(A.S12ID,'') = ISNULL(V.S12ID,'') AND
		ISNULL(A.S13ID,'') = ISNULL(V.S13ID,'') AND
		ISNULL(A.S14ID,'') = ISNULL(V.S14ID,'') AND
		ISNULL(A.S15ID,'') = ISNULL(V.S15ID,'') AND
		ISNULL(A.S16ID,'') = ISNULL(V.S16ID,'') AND
		ISNULL(A.S17ID,'') = ISNULL(V.S17ID,'') AND
		ISNULL(A.S18ID,'') = ISNULL(V.S18ID,'') AND
		ISNULL(A.S19ID,'') = ISNULL(V.S19ID,'') AND
		ISNULL(A.S20ID,'') = ISNULL(V.S20ID,'')
	WHERE
		A.DivisionID = @DivisionID AND
		A.TranMonth = @TranMonth AND
		A.TranYear = @TranYear AND
		A.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ','))
END

--Cap Nhat Ton Kho Tong Hop
UPDATE A SET
A.DebitQuantity = ISNULL(V.DebitQuantity,0),
A.DebitAmount = ISNULL(V.DebitAmount,0),
A.InDebitQuantity = ISNULL(V.InDebitQuantity,0),
A.InDebitAmount = ISNULL(V.InDebitAmount,0),
A.CreditQuantity = ISNULL(V.CreditQuantity,0),
A.CreditAmount = ISNULL(V.CreditAmount,0),
A.InCreditQuantity = ISNULL(V.InCreditQuantity,0),
A.InCreditAmount = ISNULL(V.InCreditAmount,0),
A.EndQuantity = ISNULL(A.BeginQuantity,0) + ISNULL(V.DebitQuantity,0) - ISNULL(V.CreditQuantity,0),
A.EndAmount = ISNULL(A.BeginAmount,0) + ISNULL(V.DebitAmount,0) - ISNULL(V.CreditAmount,0),
A.LastModifyUserID = @UserID,
A.LastModifyDate = GETDATE()
FROM AT2008_QC  A WITH (NOLOCK) LEFT JOIN #TAM V
ON 	A.DivisionID = V.DivisionID AND
	A.WareHouseID = V.WareHouseID AND
	A.InventoryID = V.InventoryID AND
	A.InventoryAccountID = V.InventoryAccountID AND
	A.TranMonth = V.TranMonth AND
	A.TranYear = V.TranYear AND
	ISNULL(A.S01ID,'') = ISNULL(V.S01ID,'') AND 
	ISNULL(A.S02ID,'') = ISNULL(V.S02ID,'') AND
	ISNULL(A.S03ID,'') = ISNULL(V.S03ID,'') AND
	ISNULL(A.S04ID,'') = ISNULL(V.S04ID,'') AND
	ISNULL(A.S05ID,'') = ISNULL(V.S05ID,'') AND 
	ISNULL(A.S06ID,'') = ISNULL(V.S06ID,'') AND
	ISNULL(A.S07ID,'') = ISNULL(V.S07ID,'') AND
	ISNULL(A.S08ID,'') = ISNULL(V.S08ID,'') AND
	ISNULL(A.S09ID,'') = ISNULL(V.S09ID,'') AND
	ISNULL(A.S10ID,'') = ISNULL(V.S10ID,'') AND
	ISNULL(A.S11ID,'') = ISNULL(V.S11ID,'') AND 
	ISNULL(A.S12ID,'') = ISNULL(V.S12ID,'') AND
	ISNULL(A.S13ID,'') = ISNULL(V.S13ID,'') AND
	ISNULL(A.S14ID,'') = ISNULL(V.S14ID,'') AND
	ISNULL(A.S15ID,'') = ISNULL(V.S15ID,'') AND
	ISNULL(A.S16ID,'') = ISNULL(V.S16ID,'') AND
	ISNULL(A.S17ID,'') = ISNULL(V.S17ID,'') AND
	ISNULL(A.S18ID,'') = ISNULL(V.S18ID,'') AND
	ISNULL(A.S19ID,'') = ISNULL(V.S19ID,'') AND
	ISNULL(A.S20ID,'') = ISNULL(V.S20ID,'')
WHERE
	A.DivisionID = @DivisionID AND
	A.TranMonth = @TranMonth AND
	A.TranYear = @TranYear AND
	A.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ','))

UPDATE AT2008_QC
SET BeginQuantity = T08.EndQuantity,
	BeginAmount = T08.EndAmount,
	EndQuantity =T08.EndQuantity + AT2008_QC.DebitQuantity - AT2008_QC.CreditQuantity,
	EndAmount = T08.EndAmount + AT2008_QC.DebitAmount - AT2008_QC.CreditAmount,
	LastModifyUserID = @UserID, LastModifyDate = GETDATE()
FROM AT2008_QC WITH (NOLOCK)
INNER JOIN (SELECT InventoryID, WareHouseID, InventoryAccountID, EndQuantity, EndAmount, S01ID, S02ID, S03ID, S04ID, S05ID, S06ID, S07ID, S08ID, S09ID, S10ID,
				   S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID, S18ID, S19ID, S20ID FROM AT2008_QC WITH (NOLOCK)
			WHERE DivisionID = @DivisionID AND TranMonth = @TranMonth AND TranYear = @TranYear) T08
ON AT2008_QC.InventoryID = T08.InventoryID AND AT2008_QC.WareHouseID = T08.WareHouseID AND AT2008_QC.InventoryAccountID = T08.InventoryAccountID AND 
ISNULL(AT2008_QC.S01ID,'') = ISNULL(T08.S01ID,'') AND 
ISNULL(AT2008_QC.S02ID,'') = ISNULL(T08.S02ID,'') AND
ISNULL(AT2008_QC.S03ID,'') = ISNULL(T08.S03ID,'') AND
ISNULL(AT2008_QC.S04ID,'') = ISNULL(T08.S04ID,'') AND
ISNULL(AT2008_QC.S05ID,'') = ISNULL(T08.S05ID,'') AND 
ISNULL(AT2008_QC.S06ID,'') = ISNULL(T08.S06ID,'') AND
ISNULL(AT2008_QC.S07ID,'') = ISNULL(T08.S07ID,'') AND
ISNULL(AT2008_QC.S08ID,'') = ISNULL(T08.S08ID,'') AND
ISNULL(AT2008_QC.S09ID,'') = ISNULL(T08.S09ID,'') AND
ISNULL(AT2008_QC.S10ID,'') = ISNULL(T08.S10ID,'') AND
ISNULL(AT2008_QC.S11ID,'') = ISNULL(T08.S11ID,'') AND 
ISNULL(AT2008_QC.S12ID,'') = ISNULL(T08.S12ID,'') AND
ISNULL(AT2008_QC.S13ID,'') = ISNULL(T08.S13ID,'') AND
ISNULL(AT2008_QC.S14ID,'') = ISNULL(T08.S14ID,'') AND
ISNULL(AT2008_QC.S15ID,'') = ISNULL(T08.S15ID,'') AND
ISNULL(AT2008_QC.S16ID,'') = ISNULL(T08.S16ID,'') AND
ISNULL(AT2008_QC.S17ID,'') = ISNULL(T08.S17ID,'') AND
ISNULL(AT2008_QC.S18ID,'') = ISNULL(T08.S18ID,'') AND
ISNULL(AT2008_QC.S19ID,'') = ISNULL(T08.S19ID,'') AND
ISNULL(AT2008_QC.S20ID,'') = ISNULL(T08.S20ID,'')
WHERE AT2008_QC.TranMonth = @NextMonth AND
	  AT2008_QC.TranYear = @NextYear AND
	  AT2008_QC.DivisionID = @DivisionID AND
	  AT2008_QC.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ','))


-- Chuyển điều kiện WHERE sang CROSS APLLY giảm thời gian load dữ liệu
INSERT INTO AT2008_QC (InventoryID,WarehouseID,TranMonth,TranYear,DivisionID, BeginQuantity, BeginAmount, EndQuantity, EndAmount, 
	   DebitQuantity, DebitAmount, CreditQuantity, CreditAmount,InDebitQuantity, InDebitAmount, InCreditQuantity,InCreditAmount,
	   InventoryAccountID, S01ID, S02ID,S03ID,S04ID,S05ID, S06ID, S07ID, S08ID, S09ID,S10ID,
	   S11ID, S12ID, S13ID, S14ID, S15ID, S16ID, S17ID,S18ID,S19ID,S20ID, CreateUserID, CreateDate, LastModifyUserID, LastModifyDate)
SELECT T08.InventoryID,T08.WareHouseID,@NextMonth,@NextYear,@DivisionID, 
   T08.EndQuantity, T08.EndAmount, T08.EndQuantity, T08.EndAmount,  
   0,0,0,0,0,0,0,0,
   T08.InventoryAccountID,T08.S01ID, T08.S02ID, T08.S03ID, T08.S04ID, T08.S05ID, T08.S06ID, T08.S07ID, T08.S08ID, T08.S09ID, T08.S10ID,
   T08.S11ID, T08.S12ID, T08.S13ID, T08.S14ID, T08.S15ID, T08.S16ID, T08.S17ID, T08.S18ID, T08.S19ID, T08.S20ID, @UserID, GETDATE(), @UserID, GETDATE()
FROM AT2008_QC T08 WITH (NOLOCK)
	CROSS APPLY (SELECT TOP 1 1 AS REF FROM AT2008_QC WITH (NOLOCK) WHERE DivisionID = @DivisionID AND TranMonth = @NextMonth AND TranYear = @NextYear
	AND InventoryID = T08.InventoryID AND WareHouseID = T08.WareHouseID AND InventoryAccountID = T08.InventoryAccountID AND
	ISNULL(AT2008_QC.S01ID,'') = ISNULL(T08.S01ID,'') AND 
	ISNULL(AT2008_QC.S02ID,'') = ISNULL(T08.S02ID,'') AND
	ISNULL(AT2008_QC.S03ID,'') = ISNULL(T08.S03ID,'') AND
	ISNULL(AT2008_QC.S04ID,'') = ISNULL(T08.S04ID,'') AND
	ISNULL(AT2008_QC.S05ID,'') = ISNULL(T08.S05ID,'') AND 
	ISNULL(AT2008_QC.S06ID,'') = ISNULL(T08.S06ID,'') AND
	ISNULL(AT2008_QC.S07ID,'') = ISNULL(T08.S07ID,'') AND
	ISNULL(AT2008_QC.S08ID,'') = ISNULL(T08.S08ID,'') AND
	ISNULL(AT2008_QC.S09ID,'') = ISNULL(T08.S09ID,'') AND
	ISNULL(AT2008_QC.S10ID,'') = ISNULL(T08.S10ID,'') AND
	ISNULL(AT2008_QC.S11ID,'') = ISNULL(T08.S11ID,'') AND 
	ISNULL(AT2008_QC.S12ID,'') = ISNULL(T08.S12ID,'') AND
	ISNULL(AT2008_QC.S13ID,'') = ISNULL(T08.S13ID,'') AND
	ISNULL(AT2008_QC.S14ID,'') = ISNULL(T08.S14ID,'') AND
	ISNULL(AT2008_QC.S15ID,'') = ISNULL(T08.S15ID,'') AND
	ISNULL(AT2008_QC.S16ID,'') = ISNULL(T08.S16ID,'') AND
	ISNULL(AT2008_QC.S17ID,'') = ISNULL(T08.S17ID,'') AND
	ISNULL(AT2008_QC.S18ID,'') = ISNULL(T08.S18ID,'') AND
	ISNULL(AT2008_QC.S19ID,'') = ISNULL(T08.S19ID,'') AND
	ISNULL(AT2008_QC.S20ID,'') = ISNULL(T08.S20ID,'')) T09
WHERE T08.DivisionID = @DivisionID AND T08.TranMonth = @TranMonth AND T08.TranYear = @TranYear AND T08.WareHouseID IN (SELECT Value FROM dbo.StringSplit(@WareHouseID, ',')) 
AND T09.REF IS NULL
--AND 
--	ISNULL((SELECT top 1 1 FROM AT2008_QC WITH (NOLOCK) WHERE DivisionID = @DivisionID AND TranMonth = @NextMonth AND TranYear = @NextYear
--	AND InventoryID = T08.InventoryID AND WareHouseID = T08.WareHouseID AND InventoryAccountID = T08.InventoryAccountID AND
--	ISNULL(AT2008_QC.S01ID,'') = ISNULL(T08.S01ID,'') AND 
--	ISNULL(AT2008_QC.S02ID,'') = ISNULL(T08.S02ID,'') AND
--	ISNULL(AT2008_QC.S03ID,'') = ISNULL(T08.S03ID,'') AND
--	ISNULL(AT2008_QC.S04ID,'') = ISNULL(T08.S04ID,'') AND
--	ISNULL(AT2008_QC.S05ID,'') = ISNULL(T08.S05ID,'') AND 
--	ISNULL(AT2008_QC.S06ID,'') = ISNULL(T08.S06ID,'') AND
--	ISNULL(AT2008_QC.S07ID,'') = ISNULL(T08.S07ID,'') AND
--	ISNULL(AT2008_QC.S08ID,'') = ISNULL(T08.S08ID,'') AND
--	ISNULL(AT2008_QC.S09ID,'') = ISNULL(T08.S09ID,'') AND
--	ISNULL(AT2008_QC.S10ID,'') = ISNULL(T08.S10ID,'') AND
--	ISNULL(AT2008_QC.S11ID,'') = ISNULL(T08.S11ID,'') AND 
--	ISNULL(AT2008_QC.S12ID,'') = ISNULL(T08.S12ID,'') AND
--	ISNULL(AT2008_QC.S13ID,'') = ISNULL(T08.S13ID,'') AND
--	ISNULL(AT2008_QC.S14ID,'') = ISNULL(T08.S14ID,'') AND
--	ISNULL(AT2008_QC.S15ID,'') = ISNULL(T08.S15ID,'') AND
--	ISNULL(AT2008_QC.S16ID,'') = ISNULL(T08.S16ID,'') AND
--	ISNULL(AT2008_QC.S17ID,'') = ISNULL(T08.S17ID,'') AND
--	ISNULL(AT2008_QC.S18ID,'') = ISNULL(T08.S18ID,'') AND
--	ISNULL(AT2008_QC.S19ID,'') = ISNULL(T08.S19ID,'') AND
--	ISNULL(AT2008_QC.S20ID,'') = ISNULL(T08.S20ID,'')
-- ),0) = 0

-- Insert Người theo dõi mặc định
INSERT INTO WMT9020 (APK, DivisionID, APKMaster, TableID, FollowerID01, FollowerName01, TypeFollow, RelatedToTypeID, CreateDate, CreateUserID)
SELECT DISTINCT NEWID(), A08.DivisionID, A08.APK, 'AT2008', A08.CreateUserID, AT1103.FullName, 0, 0, GETDATE(), @UserID
FROM AT2008_QC A08
LEFT JOIN AT1103 WITH (NOLOCK) ON AT1103.EmployeeID = A08.CreateUserID
WHERE NOT EXISTS (SELECT TOP 1 1 FROM WMT9020 WM20 WHERE WM20.DivisionID = A08.DivisionID AND WM20.APKMaster = A08.APK)
-- Insert lịch sử mô tả
INSERT INTO WMT00003 (APK, DivisionID, [Description], RelatedToID, RelatedToTypeID, CreateDate, CreateUserID, StatusID, ScreenID, TableID)
SELECT DISTINCT NEWID(), A08.DivisionID, '''A00.AddNew'' <br/>', A08.APK, 47, GETDATE(), @UserID, 1, 'WMF2271', 'AT2008'
FROM AT2008_QC A08
LEFT JOIN AT1103 WITH (NOLOCK) ON AT1103.EmployeeID = A08.CreateUserID
WHERE NOT EXISTS (SELECT TOP 1 1 FROM WMT00003 WM03 WHERE WM03.DivisionID = A08.DivisionID AND WM03.RelatedToID = A08.APK)

GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
