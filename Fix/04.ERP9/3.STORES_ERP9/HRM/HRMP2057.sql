IF EXISTS (SELECT TOP 1 1 FROM DBO.SYSOBJECTS WHERE ID = OBJECT_ID(N'[DBO].[HRMP2057]') AND  OBJECTPROPERTY(ID, N'IsProcedure') = 1)			
DROP PROCEDURE [DBO].[HRMP2057]
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

-- <Summary>
---- Load form Duyệt Quyết định tuyển dụng
-- <Param>
---- 
-- <Return>
---- 
-- <Reference>
---- 
-- <History>
----Created by: Bảo Anh, Date: 19/12/2019
---- Modified on
-- <Example>
---- 
/*
   exec HRMP2057 'NTY', '98F44718-751E-4D7C-B323-91DA613AA060','NTVN0021'
*/

CREATE PROCEDURE HRMP2057
( 
	@DivisionID VARCHAR(50),
	@APKMaster VARCHAR(50),
	@UserID VARCHAR(50)
)
AS
	
DECLARE @RecDecisionID VARCHAR(50)

SELECT @RecDecisionID = RecDecisionID FROM HRMT2050 WITH (NOLOCK)
WHERE DivisionID = @DivisionID AND APKMaster = @APKMaster

--- Dataset 1: Trả ra master
SELECT	HRMT2050.APK, HRMT2050.APKMaster, HRMT2050.DivisionID, HRMT2050.RecDecisionID, HRMT2050.RecDecisionNo, HRMT2050.Description, 
		HRMT2050.DecisionDate, ISNULL(O90.Status, 0) AS StatusOOT9001, O91.Level,
		HRMT2050.CreateUserID +' - '+ (SELECT TOP 1 UserName FROM AT1405 WITH (NOLOCK) WHERE DivisionID = HRMT2050.DivisionID AND UserID = HRMT2050.CreateUserID) CreateUserID, HRMT2050.CreateDate, 
		HRMT2050.LastModifyUserID +' - '+ (SELECT TOP 1 UserName FROM AT1405 WITH (NOLOCK) WHERE DivisionID = HRMT2050.DivisionID AND UserID = HRMT2050.LastModifyUserID) LastModifyUserID, HRMT2050.LastModifyDate
FROM HRMT2050 WITH (NOLOCK)
	INNER JOIN OOT9000 O90 WITH (NOLOCK) ON HRMT2050.DivisionID = O90.DivisionID AND HRMT2050.APKMaster = O90.APK
	INNER JOIN OOT9001 O91 WITH (NOLOCK) ON HRMT2050.DivisionID = O91.DivisionID AND HRMT2050.RecDecisionID = O91.APKMaster AND O91.ApprovePersonID = @UserID
WHERE HRMT2050.DivisionID = @DivisionID
	AND HRMT2050.RecDecisionID = @RecDecisionID
GROUP BY HRMT2050.APK, HRMT2050.APKMaster, HRMT2050.DivisionID, HRMT2050.RecDecisionID, HRMT2050.RecDecisionNo, HRMT2050.Description, O91.Level,
		HRMT2050.DecisionDate, O90.Status, HRMT2050.CreateUserID, HRMT2050.CreateDate, HRMT2050.LastModifyUserID, HRMT2050.LastModifyDate

--- Dataset 2: Trả ra detail
SELECT HRMT2051.APK, O91.APK AS APKOOT9001, O91.[Level], HRMT2051.RecruitPeriodID, HRMT2020.DepartmentID, AT1102.DepartmentName, 
	HRMT2020.DutyID, HT1102.DutyName, HRMT2051.CandidateID, O91.[Status], H09.Description AS StatusName,
    LTRIM(RTRIM(REPLACE(LTRIM(RTRIM(ISNULL(HRMT1030.LastName,'')))+ ' ' + LTRIM(RTRIM(ISNULL(HRMT1030.MiddleName,''))) + ' ' + LTRIM(RTRIM(ISNULL(HRMT1030.FirstName,''))),'  ',' '))) AS CandidateName,
    HRMT1030.Gender, H10.Description AS GenderName, HRMT1030.Birthday, IsSingle, CASE WHEN ISNULL(IsSingle,0) = 0 THEN N'Đã kết hôn' ELSE N'Độc thân' END AS MaterialStatus,
    HRMT1031.WorkType, H11.Description AS WorkTypeName, HRMT2040.RequireSalary, HRMT2040.DealSalary, HRMT2040.TrialFromDate, HRMT2040.TrialToDate,
	HRMT2051.ApproveLevel, HRMT2051.ApprovingLevel, HRMT2051.APKMaster,
	CASE WHEN ISNULL(HRMT2051.ApprovingLevel,0) > O91.Level THEN 1 ELSE 0 END AS IsLock
FROM HRMT2051 WITH (NOLOCK)
	LEFT JOIN HRMT2020 WITH (NOLOCK) ON HRMT2051.DivisionID = HRMT2020.DivisionID AND HRMT2051.RecruitPeriodID = HRMT2020.RecruitPeriodID
	LEFT JOIN HT0099 H09 WITH (NOLOCK) ON HRMT2051.Status = H09.ID AND H09.CodeMaster = 'RecruitStatus'
	LEFT JOIN AT1102 WITH (NOLOCK) ON HRMT2020.DepartmentID = AT1102.DepartmentID
	LEFT JOIN HT1102 WITH (NOLOCK) ON HRMT2020.DivisionID = HT1102.DivisionID AND HRMT2020.DutyID = HT1102.DutyID
	LEFT JOIN HRMT1030 WITH (NOLOCK) ON HRMT2051.DivisionID = HRMT1030.DivisionID AND HRMT2051.CandidateID = HRMT1030.CandidateID
	LEFT JOIN HT0099 H10 WITH (NOLOCK) ON HRMT1030.Gender = H10.ID AND H10.CodeMaster = 'Gender'
	LEFT JOIN HRMT1031 WITH (NOLOCK) ON HRMT1031.DivisionID = HRMT1030.DivisionID AND HRMT1031.CandidateID = HRMT1030.CandidateID
	LEFT JOIN HT0099 H11 WITH (NOLOCK) ON HRMT1031.WorkType = H11.ID AND H11.CodeMaster = 'WorkType'
	LEFT JOIN HRMT2040 WITH (NOLOCK) ON HRMT2051.DivisionID = HRMT2040.DivisionID AND HRMT2051.CandidateID = HRMT2040.CandidateID
	INNER JOIN OOT9001 O91 WITH (NOLOCK) ON HRMT2051.DivisionID = O91.DivisionID AND HRMT2051.APK = O91.APKDetail AND O91.ApprovePersonID = @UserID
WHERE  HRMT2051.DivisionID = @DivisionID
    AND HRMT2051.RecDecisionID = @RecDecisionID





GO
SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
